(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.Grapher=function(){var format_number;Grapher.format_number=format_number=function(num){if(num>1e7){return Math.floor(num/1e6)+"m"}else if(num>=1e6){return Math.floor(num/1e5)/10+"m"}else if(num>1e4){return Math.floor(num/1e3)+"k"}else if(num>=1e3){return Math.floor(num/100)/10+"k"}else{return""+num}};Grapher.prototype.chart_svg_class="chart";Grapher.prototype.margin_left=40;Grapher.prototype.margin_bottom=30;Grapher.prototype.margin_right=30;Grapher.prototype.margin_top=20;Grapher.prototype.dot_hitbox_w=30;Grapher.prototype.dot_hitbox_h=120;Grapher.prototype.axis_spacing=8;Grapher.prototype.axis_graph_padding=10;Grapher.prototype.popup_template='<div class="graph_popup">\n  <div class="popup_date">{{ date }}</div>\n  <div class="popup_label">{{ label }}</div>\n</div>';Grapher.prototype.default_opts={label:"Count",y_axis_padding:1.3,min_y:10,x_ticks:10,fit_dots:false};function Grapher(el,data1,opts){this.data=data1;this.increment_date=bind(this.increment_date,this);this.list_range=bind(this.list_range,this);this.get_range=bind(this.get_range,this);this.format_y_axis=bind(this.format_y_axis,this);this.get_y_scaled=bind(this.get_y_scaled,this);this.get_x_scaled=bind(this.get_x_scaled,this);this.get_y=bind(this.get_y,this);this.get_x=bind(this.get_x,this);this.popup_date=bind(this.popup_date,this);this.axis_offsets=bind(this.axis_offsets,this);this.el=$(el);this.opts=$.extend({},this.default_opts,opts);this.draw();this.setup_popups()}Grapher.prototype.popup_position=function(hitbox){var point_offset,x,y;point_offset=hitbox.prev("circle").position();x=Math.floor(point_offset.left);y=Math.floor(point_offset.top);return[x,y]};Grapher.prototype.get_template=function(name){var base;if(name==null){name="poup_template"}this._templates||(this._templates={});(base=this._templates)[name]||(base[name]=_.template(this[name]));return this._templates[name]};Grapher.prototype.setup_popups=function(){var current_popup,remove_popup,toggle_popup;current_popup=null;remove_popup=function(popup){if(!popup){return}return popup.stop(true,true).remove()};toggle_popup=_.debounce(function(_this){return function(state,hitbox){var h,pad,popup,ref,template,w,x,y;hitbox=$(hitbox);if(!hitbox.data("popup")){return}switch(state){case"show":template=_this.get_template(hitbox.data("popup_template")||"popup_template");popup=hitbox.data("popup_el");if(current_popup!=null?current_popup.is(popup):void 0){return}remove_popup(current_popup);if(!popup){popup=$(template(hitbox.data("popup")));hitbox.data("popup_el",popup)}current_popup=popup;current_popup.appendTo(_this.el).hide().fadeIn("fast");ref=_this.popup_position(hitbox),x=ref[0],y=ref[1];pad=5;w=current_popup.outerWidth();h=current_popup.outerHeight();current_popup.css({left:x-w-pad+"px",top:y-h-pad+"px"});return typeof _this.on_show_popup==="function"?_this.on_show_popup(current_popup,hitbox):void 0;case"hide":remove_popup(current_popup);if(typeof _this.on_hide_popup==="function"){_this.on_hide_popup(current_popup,hitbox)}return current_popup=null}}}(this),30);this.el[0].addEventListener("mouseover",function(_this){return function(e){var ref;if((ref=e.target.getAttribute("class"))!=null?ref.match(/\bhitbox\b/):void 0){return toggle_popup("show",e.target)}}}(this));return this.el[0].addEventListener("mouseout",function(_this){return function(e){var ref;if((ref=e.target.getAttribute("class"))!=null?ref.match(/\bhitbox\b/):void 0){return toggle_popup("hide",e.target)}}}(this))};Grapher.prototype.draw=function(){var data,x,y;this.w=this.el.width();this.h=this.el.height();this.time_format=d3.time.format("%Y-%m-%d");this.svg=d3.select(this.el[0]).append("svg").attr("class",this.chart_svg_class).attr("width",this.w).attr("height",this.h);data=this.format_data();x=this._x_scale=this.x_scale(data);y=this._y_scale=this.y_scale(data);this.draw_guides(x,y);this.draw_area(data);this.draw_axis(x,y);this.draw_dots(data);return this.draw_label()};Grapher.prototype.guide_x_range=function(x,y){return x.range()};Grapher.prototype.draw_guides=function(x,y){var gx,gy,ref,y_guides;y_guides=this.svg.append("g").attr("class","y_guides");ref=this.guide_x_range(x,y),gx=ref[0],gy=ref[1];y_guides.selectAll("line").data(y.ticks(this.y_ticks())).enter().append("line").attr("x1",gx).attr("y1",y).attr("x2",gy).attr("y2",y);return this.svg.append("g").attr("class","x_guides").selectAll("line").data(x.ticks(this.x_ticks())).enter().append("line").attr("x1",x).attr("y1",y.range()[0]).attr("x2",x).attr("y2",y.range()[1])};Grapher.prototype.axis_offsets=function(){return[0,0]};Grapher.prototype.draw_axis=function(x,y){var left,ox,oy,ref,x_axis,y_axis;y_axis=d3.svg.axis().scale(y).orient("left").tickFormat(this.format_y_axis).ticks(this.y_ticks());left=x.domain()[0];ref=this.axis_offsets(),ox=ref[0],oy=ref[1];this.svg.append("g").attr("transform","translate("+(this._x_scale(left)+ox-this.axis_spacing)+", 0)").attr("class","y_axis axis").call(y_axis);x_axis=d3.svg.axis().scale(x).orient("bottom").ticks(this.x_ticks());return this.svg.append("g").attr("transform","translate(0, "+(y.range()[0]+oy+this.axis_spacing)+")").attr("class","x_axis axis").call(x_axis)};Grapher.prototype.draw_area=function(data){var area;area=d3.svg.area().x(this.get_x_scaled).y1(this.get_y_scaled).y0(this.h-this.margin_bottom);return this.svg.append("g").attr("class","graph").append("path").attr("d",area(data))};Grapher.prototype.draw_label=function(){var label;label=this.svg.append("g").attr("class","label").attr("transform","translate("+this.margin_left+", 10)");label.append("circle").attr("cx",0).attr("cy",-5).attr("r",4);return label.append("text").text(this.opts.label).attr("x",10)};Grapher.prototype.draw_dots=function(data,opts){var hitbox_h,hitbox_w,popups;if(opts==null){opts={}}data=this.filter_dots_data(data);if(this.list_range().length>60){return}popups=this.svg.append("g").attr("class","popups").selectAll("g").data(data).enter().append("g").attr("class","popup_trigger");hitbox_w=this.dot_hitbox_w;hitbox_h=this.dot_hitbox_h;popups.append("circle").attr("class","dot_outline").attr("cx",this.get_x_scaled).attr("cy",this.get_y_scaled).attr("r",6);popups.append("circle").attr("class","dot").attr("cx",this.get_x_scaled).attr("cy",this.get_y_scaled).attr("r",4);return popups.append("rect").attr("class","hitbox").attr("transform","translate(-"+hitbox_w/2+", -"+hitbox_h/2+")").attr("x",this.get_x_scaled).attr("y",this.get_y_scaled).attr("width",hitbox_w).attr("height",hitbox_h).attr("data-popup",function(_this){return function(d){return JSON.stringify({date:_this.popup_date.apply(_this,arguments),label:_this.popup_label.apply(_this,arguments)})}}(this))};Grapher.prototype.filter_dots_data=function(data){var can_fit,dots_to_fit,i,real_w,subset,take_every;if(this.opts.fit_dots){real_w=this.w-this.margin_left-this.margin_right-this.axis_graph_padding;can_fit=Math.floor(real_w/this.dot_hitbox_w);if(data.length>can_fit){dots_to_fit=Math.floor((real_w-this.dot_hitbox_w*2)/this.dot_hitbox_w);take_every=Math.floor((data.length-2)/dots_to_fit);subset=function(){var j,ref,ref1,results;results=[];for(i=j=1,ref=data.length-2,ref1=take_every;ref1>0?j<=ref:j>=ref;i=j+=ref1){results.push(data[i])}return results}();subset.push(data[data.length-1]);subset.unshift(data[1]);return subset}}return data};Grapher.prototype.popup_label=function(d){var val;val=this.opts.rate?_.str.numberFormat(this.get_y(d),4)+"%":_.str.numberFormat(this.get_y(d));return this.opts.label+": "+val};Grapher.prototype.popup_date=function(d){return d.date};Grapher.prototype.get_x=function(d){return this.time_format.parse(d.date)};Grapher.prototype.get_y=function(d){if(this.opts.rate){return d.count*100}else{return d.count}};Grapher.prototype.get_x_scaled=function(){return this._x_scale(this.get_x.apply(this,arguments))};Grapher.prototype.get_y_scaled=function(){return this._y_scale(this.get_y.apply(this,arguments))};Grapher.prototype.format_y_axis=function(num){if(this.opts.rate){if(num<10&&num!==0){return _.str.numberFormat(num,1)+"%"}else{return _.str.numberFormat(num)+"%"}}else{return I.Grapher.format_number(num)}};Grapher.prototype.x_ticks=function(){return this.opts.x_ticks};Grapher.prototype.y_ticks=function(){if(this.opts.rate){return 5}else{return Math.min(5,this.opts.min_y)}};Grapher.prototype.get_range=function(){var format,left,new_left,offset,out,right,today;if(this.opts.range_left){format=d3.time.format("%Y-%m-%d");out=[format.parse(this.opts.range_left),format.parse(this.opts.range_right)];if(this.opts.interval==="weekly"&&this.data[0]){format=d3.time.format("%Y-%m-%d");left=out[0];new_left=format.parse(this.data[0].date);while(new_left>left){new_left=d3.time.day.offset(new_left,-7)}return[new_left,out[1]]}return out}if(this.opts.num_days){today=d3.time.day(new Date);offset=this.opts.day_offset||0;left=d3.time.day.offset(today,-(this.opts.num_days+offset-1));right=d3.time.day.offset(today,-offset);return[left,right]}throw"Don't know how to calculate range"};Grapher.prototype.map_range=function(fn){var left,ref,results,right,t,val;ref=this.get_range(),left=ref[0],right=ref[1];t=left;results=[];while(t<=right){val=fn(t);t=this.increment_date(t);if(!val){continue}results.push(val)}return results};Grapher.prototype.list_range=function(){var out;out=[];this.map_range(function(d){return out.push(d)});return out};Grapher.prototype.increment_date=function(t){if(this.opts.interval==="weekly"){return d3.time.day.offset(t,7)}else{return d3.time.day.offset(t,1)}};Grapher.prototype.format_data=function(){var counts_by_date,j,len,ref,v;counts_by_date={};ref=this.data;for(j=0,len=ref.length;j<len;j++){v=ref[j];counts_by_date[v.date]=v}return this.map_range(function(_this){return function(t){var formatted;formatted=_this.time_format(t);return counts_by_date[formatted]||{count:0,date:formatted}}}(this))};Grapher.prototype.x_scale=function(data){var left,ref,right;ref=this.get_range(),left=ref[0],right=ref[1];return d3.time.scale().domain([left,right]).rangeRound([this.margin_left+this.axis_graph_padding,this.w-this.margin_right])};Grapher.prototype.y_scale=function(data){var axis_max_y,max,out,out_range,p;max=d3.max(data,this.get_y)||0;p=this.opts.y_axis_padding||1.3;out_range=[this.h-this.margin_bottom,this.margin_top];axis_max_y=this.opts.rate?Math.max(.5,Math.floor(max*10*p)/10):Math.max(this.opts.min_y,Math.floor((max+1)*p));out=d3.scale.linear().domain([0,axis_max_y]);if(this.opts.rate){return out.range(out_range)}else{return out.rangeRound(out_range)}};return Grapher}();I.MoneyGrapher=function(superClass){extend(MoneyGrapher,superClass);function MoneyGrapher(){this.format_y_axis=bind(this.format_y_axis,this);return MoneyGrapher.__super__.constructor.apply(this,arguments)}MoneyGrapher.prototype.format_y_axis=function(num){var dollars;dollars=this.opts.currency==="JPY"?num:num/100;if(dollars>9){Math.floor(dollars)}return(I.currency_symbols[this.opts.currency]||"$")+I.Grapher.format_number(dollars)};MoneyGrapher.prototype.popup_label=function(d){return this.opts.label+": "+I.format_money(d.sum,this.opts.currency)};return MoneyGrapher}(I.Grapher);I.CumulativeGraph=function(superClass){extend(CumulativeGraph,superClass);function CumulativeGraph(){this.get_range=bind(this.get_range,this);this.get_y=bind(this.get_y,this);return CumulativeGraph.__super__.constructor.apply(this,arguments)}CumulativeGraph.prototype.default_opts={label:"Amount",min_y:100,x_ticks:8,fit_dots:true,min_range:7,currency:"USD",y_axis_padding:1.3};CumulativeGraph.prototype.get_y=function(d){return d.sum};CumulativeGraph.prototype.get_range=function(){var first,format,last,range_ago;format=d3.time.format("%Y-%m-%d");first=this.data[0];last=this.data[this.data.length-1];first=format.parse(first.date);last=format.parse(last.date);range_ago=d3.time.day.offset(last,-this.opts.min_range);if(range_ago<first){first=range_ago}return[first,last]};CumulativeGraph.prototype.format_data=function(){var by_date,j,last,len,ref,v;by_date={};ref=this.data;for(j=0,len=ref.length;j<len;j++){v=ref[j];by_date[v.date]=v}last=0;return this.map_range(function(_this){return function(t){var formatted,ref1;formatted=_this.time_format(t);last=((ref1=by_date[formatted])!=null?ref1.sum:void 0)||last;return{sum:last,date:formatted}}}(this))};return CumulativeGraph}(I.MoneyGrapher);I.BarGrapher=function(superClass){extend(BarGrapher,superClass);function BarGrapher(){return BarGrapher.__super__.constructor.apply(this,arguments)}BarGrapher.prototype.x_axis_unit_offset=-.5;BarGrapher.prototype.chart_svg_class="chart bar_chart";BarGrapher.prototype.dot_hitbox_w=20;BarGrapher.prototype.dot_hitbox_h=20;BarGrapher.prototype.axis_offsets=function(){return[-Math.floor(this.bar_width()/2),0]};BarGrapher.prototype.bar_width=function(){var bl,br;bl=this.get_range()[0];br=d3.time.day.offset(bl,1);return this._x_scale(br)-this._x_scale(bl)};BarGrapher.prototype.guide_x_range=function(x,y){var a,b,bw,ref;ref=x.range(),a=ref[0],b=ref[1];bw=this.bar_width();return[a-bw/2,b+bw/2]};BarGrapher.prototype.x_scale=function(data){var available_width,bar_width,bars,bh,d,left,left_date,ref,right,right_date;ref=this.get_range(),left_date=ref[0],right_date=ref[1];left=this.margin_left+this.axis_graph_padding;right=this.w-this.margin_right;available_width=right-left;d=d3.time.scale().domain([left_date,right_date]);bars=d.ticks(d3.time.day,1);bar_width=available_width/bars.length;bh=bar_width/2;return d.rangeRound([left+bh,right-bh])};BarGrapher.prototype.draw_area=function(data){var bar_width,bars,x_centered;bar_width=this.bar_width();x_centered=function(_this){return function(d){var x;x=_this.get_x_scaled(d);return x-(bar_width-5)/2}}(this);return bars=this.svg.append("g").attr("class","bars").selectAll("rect").data(data).enter().append("rect").attr("x",x_centered).attr("y",this.get_y_scaled).attr("width",bar_width-5).attr("height",function(_this){return function(d){return _this._y_scale(0)-_this.get_y_scaled(d)}}(this))};return BarGrapher}(I.Grapher);I.StackedBarGrapher=function(superClass){extend(StackedBarGrapher,superClass);StackedBarGrapher.prototype.bar_popup_template='<div class="graph_popup">\n  <div class="popup_date">{{ date }}</div>\n  <div class="popup_group">{{ group }}</div>\n  <div class="popup_label">{{ label }}</div>\n</div>';function StackedBarGrapher(){this.on_hide_popup=bind(this.on_hide_popup,this);this.on_show_popup=bind(this.on_show_popup,this);this.popup_group=bind(this.popup_group,this);StackedBarGrapher.__super__.constructor.apply(this,arguments);this.el.on("click","[data-game_id]",function(_this){return function(e){var id,url;if(!_this.opts.group_url){return}id=$(e.target).data("game_id");url=_this.opts.group_url({game_id:id});if(!url){return}return window.location=url}}(this))}StackedBarGrapher.prototype.secondary_field=function(){return this.opts.secondary_field||"game_id"};StackedBarGrapher.prototype.get_y=function(d){return d.max};StackedBarGrapher.prototype.popup_group=function(d){return d[this.secondary_field()]};StackedBarGrapher.prototype.bar_popup_label=function(d){var val;val=_.str.numberFormat(d.max-d.min);return this.opts.label+": "+val};StackedBarGrapher.prototype.format_data=function(){var counts_by_date,j,len,ref,v;counts_by_date={};ref=this.data;for(j=0,len=ref.length;j<len;j++){v=ref[j];counts_by_date[v.date]=v}return this.map_range(function(_this){return function(t){var count,formatted,idx,last_sum,stacks,sum,tuple,x;formatted=_this.time_format(t);tuple=counts_by_date[formatted];if(!tuple){return{date:formatted,min:0,max:0,stacks:[]}}sum=0;stacks=function(){var k,len1,ref1,results;ref1=tuple.counts;results=[];for(idx=k=0,len1=ref1.length;k<len1;idx=++k){count=ref1[idx];last_sum=sum;sum+=count.count;x={cap:sum===tuple.count,date:tuple.date,min:last_sum,max:sum};x[this.secondary_field()]=count[this.secondary_field()];results.push(x)}return results}.call(_this);if(!(tuple.count>0)){return}return{date:tuple.date,min:0,max:tuple.count,stacks:stacks}}}(this))};StackedBarGrapher.prototype.popup_position=function(hitbox){var point_offset,x,y;point_offset=hitbox.position();x=Math.floor(point_offset.left);y=Math.floor(point_offset.top);return[x,y]};StackedBarGrapher.prototype.on_show_popup=function(popup,hitbox){var current_bars,game_bars,secondary_id;secondary_id=hitbox.data(this.secondary_field());if(!secondary_id){this.on_hide_popup();return}this.el.addClass("highlighting_bar");game_bars=this.el.find(".game_bar");current_bars=game_bars.filter("[data-"+this.secondary_field()+"='"+secondary_id+"']");game_bars.css({opacity:.1});return current_bars.css({opacity:""})};StackedBarGrapher.prototype.on_hide_popup=function(popup,hitbox){return this.el.removeClass("highlighting_bar").find(".game_bar").css({opacity:""})};StackedBarGrapher.prototype.draw_area=function(data){var bar_stack,bar_stacks,bar_width,bl,br,colors,g,item,j,len,position_bars,secondary_ids,stack;bl=this.get_range()[0];br=d3.time.day.offset(bl,1);bar_width=this._x_scale(br)-this._x_scale(bl);colors=d3.scale.ordinal().range(this.opts.colors||["#FA5C5C","#E85757","#EB7070","#EF8888","#F4ADAD","#F9C1C1"]);data=data.filter(function(d){return d.min!==d.max});secondary_ids={};for(j=0,len=data.length;j<len;j++){item=data[j];secondary_ids[item[this.secondary_field()]]=true}secondary_ids=function(){var results;results=[];for(g in secondary_ids){results.push(+g)}return results}();colors=colors.domain(secondary_ids);stack=this.svg.append("g").attr("class","bars").selectAll("g").data(data).enter().append("g");position_bars=function(_this){return function(group,expand){if(expand==null){expand=0}return group.attr("x",function(d){var x;x=_this.get_x_scaled(d);return-expand+Math.floor(x-(bar_width-5)/2)}).attr("y",function(d){return _this._y_scale(d.max)-expand}).attr("width",bar_width-5+expand*2).attr("height",function(d){return 2*expand+Math.max(1,_this._y_scale(d.min)-_this._y_scale(d.max))})}}(this);bar_stack=stack.attr("class","bar_stack");position_bars(bar_stack.append("rect").attr("class","total_border"),1);position_bars(bar_stack.append("rect").attr("class","total_bar"));bar_stacks=stack.append("g").attr("class","game_counts").selectAll("rect").data(function(d){return d.stacks}).enter();position_bars(bar_stacks.append("rect").attr("class",function(_this){return function(d){var base,c;c="game_bar hitbox";if(typeof(base=_this.opts).group_url==="function"?base.group_url(d):void 0){c+=" link"}return c}}(this)).attr("data-"+this.secondary_field(),function(_this){return function(d){return d[_this.secondary_field()]}}(this)).attr("fill",function(_this){return function(d){return colors(d[_this.secondary_field()])}}(this)).attr("data-popup_template","bar_popup_template").attr("data-popup",function(_this){return function(d){return JSON.stringify({date:_this.popup_date.apply(_this,arguments),label:_this.bar_popup_label.apply(_this,arguments),group:(_this.opts.popup_group||_this.popup_group).apply(null,arguments)})}}(this)));return position_bars(bar_stacks.append("rect").attr("class","bar_border")).attr("height",function(d){if(d.cap){return 0}else{return 1}})};return StackedBarGrapher}(I.BarGrapher)}).call(this);(function(){var AdminLightbox,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;AdminLightbox=function(superClass){extend(AdminLightbox,superClass);function AdminLightbox(){return AdminLightbox.__super__.constructor.apply(this,arguments)}AdminLightbox.prototype.init=function(id,name){var input,url;this.el.find(".recipient").text(name).end();input=this.el.find(".admin_url");input.on("click",function(){return input.select()});url=_.template(input.data("url_template"))({user_id:id});return input.val(url)};return AdminLightbox}(I.Lightbox);I.AdminsForm=function(){function AdminsForm(el,opts){var form,match;this.opts=opts!=null?opts:{};this.el=$(el).remote_link(function(_this){return function(res){if(res.removed){if(res.is_self){return window.location="/dashboard"}else{return window.location.reload()}}}}(this));this.el.dispatch("click",{show_url_btn:function(_this){return function(btn){var row;row=btn.closest("tr");return I.Lightbox.open_tpl("admin_accept_lightbox",AdminLightbox,row.data("user_id"),row.data("user_name"))}}(this)});this.el.find(".field_toggle_input").on("change",function(_this){return function(e){var input,picker,row;input=$(e.target);picker=input.closest(".field_toggle");if(picker.is(".disabled")){return}picker.addClass("disabled");input.prop("disabled",true);row=input.closest("tr");return $.post("",I.with_csrf({json:true,action:"toggle_field",username:row.data("user_slug"),field:input.data("field"),enabled:""+input.prop("checked")}),function(res){input.prop("disabled",false);input.prop("checked",res[input.data("field")]);return picker.removeClass("disabled")})}}(this));if(match=window.location.search.match(/\bnew_admin=(\d+)/)){this.el.find("[data-user_id="+match[1]+"] .show_url_btn").click()}if(this.opts.async_add){form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return I.Lightbox.open_tpl("admin_accept_lightbox",AdminLightbox,res.user_id,res.user_name)}}(this))}}return AdminsForm}()}).call(this);(function(){I.ApiKeys=function(){function ApiKeys(el){this.el=$(el);this.el.dispatch("click",{revoke_key_btn:function(_this){return function(btn){if(confirm("Are you sure you want to delete this key?")){return btn.closest("form").submit()}}}(this),remove_ssh_key_button:function(_this){return function(btn){if(confirm("Are you sure you want to delete this key?")){return btn.closest("form").submit()}}}(this),view_key_btn:function(_this){return function(btn){return btn.closest(".key_cell").toggleClass("show_key")}}(this)})}return ApiKeys}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.BlogPostPage=function(){BlogPostPage.prototype.like_button_template=I.lazy_template(BlogPostPage,"like_button");function BlogPostPage(el,data){this.render_like_button=bind(this.render_like_button,this);var grid;this.el=$(el);grid=this.el.find(".browse_game_grid");this.grid=new I.GameGrid(grid,{selector:".browse_game_grid .game_cell .game_thumb",width_selector:".browse_game_grid .game_cell"});this.grid.setup_conversion_tracking("10");new I.GameGrid(this.el.find(".sidebar_game_grid"),{sizer:false});this.render_like_button();I.format_dates(this.el,"fromNow");I.setup_grid_referrers(this.el,function(_this){return function(){return"blog_post:"+data.post_id}}(this));I.has_follow_button(this.el);I.setup_sticky_bar(this.el.find(".post_tools"));I.deferred_links(this.el,"a[data-label]");this.el.on("i:delegate_tracking",function(_this){return function(e,push){return push(I.ga_tracker("view_blog_post")($(e.target)))}}(this));this.el.find(".post_body").on("i:delegate_tracking",function(_this){return function(e,push){var game_id;game_id=$(e.target).closest("[data-game_id]").data("game_id");if(!game_id){return}I.ConversionTracker.click("10:1:"+game_id);return push(I.ConversionTracker.flush_now())}}(this))}BlogPostPage.prototype.render_like_button=function(s){var base,child,drop;drop=this.el.find(".like_button_drop");this.like_button_state||(this.like_button_state=drop.data("init"));if(s){$.extend(this.like_button_state,s)}(base=this.like_button_state).classname||(base.classname=this.like_button_state.liked?"liked":"");child=drop.html(this.like_button_template(this.like_button_state)).children();return child.find("form").remote_submit(function(_this){return function(res){return _this.render_like_button({classname:_this.like_button_state.liked?"animate_drop_down":"liked animate_bounce",liked:!_this.like_button_state.liked,likes_count:res.likes_count})}}(this))};return BlogPostPage}()}).call(this);(function(){I.BundleAnalytics=function(){function BundleAnalytics(el,opts){var i,len,ref,tbl;this.el=$(el);ref=this.el.find(".remote_table");for(i=0,len=ref.length;i<len;i++){tbl=ref[i];$(tbl).remote_table()}I.format_dates(this.el);if(opts.cumulative_earnings){new I.CumulativeGraph("#cumulative_earnings_graph",opts.cumulative_earnings,{currency:opts.currency})}}return BundleAnalytics}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CollectionPage=function(superClass){extend(CollectionPage,superClass);CollectionPage.prototype.method="get";CollectionPage.prototype.setup_loading=function(){if(this.opts.disable_infinite_scroll){return}return CollectionPage.__super__.setup_loading.apply(this,arguments)};function CollectionPage(el,opts){var grid;this.opts=opts;this.setup_admin_panel=bind(this.setup_admin_panel,this);this.setup_loading=bind(this.setup_loading,this);CollectionPage.__super__.constructor.call(this,el);I.format_dates(this.el);I.has_follow_button(this.el);I.setup_grid_referrers(this.el,function(_this){return function(){return"collection:"+_this.opts.id}}(this));this.el.on("i:delegate_tracking",function(_this){return function(e,push){return push(I.ga_tracker("collection")($(e.target)))}}(this));I.deferred_links(this.el,"a[data-label]",function(_this){return function(el,event){var game_id;if(!I.is_middle_click(event)&&el.is(".game_link")){game_id=el.closest("[data-game_id]").data("game_id");if(game_id!=null&&_this.opts.queue_url&&!I.is_mobile()){el.attr("href",_this.opts.queue_url+"?"+$.param({game_id:game_id}))}}return I.delegate_tracking(el)}}(this));switch(this.opts.layout){case"grid":grid=this.el.find(".browse_game_grid");this.grid=new I.GameGrid(grid,{selector:".browse_game_grid .game_cell .game_thumb",width_selector:".browse_game_grid .game_cell",cell_margin:I.is_mobile()?10:20});this.grid.setup_conversion_tracking("3");break;case"list":this.grid={add_image_loading:function(_this){return function(){return _this.el.lazy_images()}}(this),el:this.el.find(".collection_game_list_widget")};I.GameGrid.prototype.setup_lazy_images.call(this);I.GameGrid.prototype.setup_conversion_tracking.call(this,"3");new I.GamePopups(this.el);new I.GameCells(this.el)}this.el.dispatch("click",{edit_collection_admins_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("lightbox_url"),I.EditCollectionAdminsLightbox)}}(this),edit_collection_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("lightbox_url"),I.EditCollectionLightbox)}}(this),edit_collection_game_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("lightbox_url"),I.CollectionGameLightbox,btn.closest(".game_cell, .game_row"))}}(this)});this.el.remote_link(function(_this){return function(res,btn){var base;if(res.errors){alert(res.errors.join("\n"));return}if(btn.is(".remove_game_btn")){btn.closest(".game_cell").remove();return typeof(base=_this.grid).refresh_images==="function"?base.refresh_images():void 0}}}(this));this.setup_admin_panel()}CollectionPage.prototype.setup_admin_panel=function(){var admin_panel;admin_panel=this.el.find(".admin_tools");if(!admin_panel.length){return}return admin_panel.dispatch("click",{close_btn:function(_this){return function(btn){return admin_panel.remove()}}(this)})};return CollectionPage}(I.InfiniteGameGrid);I.EditCollectionAdminsLightbox=function(superClass){extend(EditCollectionAdminsLightbox,superClass);function EditCollectionAdminsLightbox(){this.init=bind(this.init,this);return EditCollectionAdminsLightbox.__super__.constructor.apply(this,arguments)}EditCollectionAdminsLightbox.prototype.init=function(){return new I.AdminsForm(this.el.find(".admins_form_widget"),{async_add:true})};return EditCollectionAdminsLightbox}(I.Lightbox)}).call(this);(function(){I.Dashboard=function(){function Dashboard(el,opts){var downloads,g,games,games_by_id,graph_left,graph_right,i,len,views;views=opts.views,downloads=opts.downloads,graph_left=opts.graph_left,graph_right=opts.graph_right,games=opts.games;games_by_id={};for(i=0,len=games.length;i<len;i++){g=games[i];games_by_id[g.id]=g}this.el=$(el);new I.FilterPickers(el,{label_padding:8});I.tracked_links(this.el,"my_games","click");if(views){new I.StackedBarGrapher("#views_graph",views,{label:"Views",x_ticks:7,popup_group:function(d){var ref;return((ref=games_by_id[d.game_id])!=null?ref.title:void 0)||""},group_url:function(d){var ref;return(ref=games_by_id[d.game_id])!=null?ref.url:void 0},range_left:graph_left,range_right:graph_right})}if(downloads){new I.StackedBarGrapher("#downloads_graph",downloads,{label:"Downloads",min_y:3,x_ticks:7,popup_group:function(d){var ref;return((ref=games_by_id[d.game_id])!=null?ref.title:void 0)||""},group_url:function(d){var ref;return(ref=games_by_id[d.game_id])!=null?ref.url:void 0},range_left:graph_left,range_right:graph_right})}I.format_dates(this.el,"fromNow")}return Dashboard}()}).call(this);(function(){I.DashboardAnalytics=function(){function DashboardAnalytics(el,opts){var downloads,g,games,games_by_id,graph_left,graph_right,i,len,views;views=opts.views,downloads=opts.downloads,graph_left=opts.graph_left,graph_right=opts.graph_right,games=opts.games;this.el=$(el);games_by_id={};for(i=0,len=games.length;i<len;i++){g=games[i];games_by_id[g.id]=g}if(views){new I.StackedBarGrapher("#views_graph",views,{label:"Views",x_ticks:7,y_axis_padding:1.1,popup_group:function(d){var ref;return((ref=games_by_id[d.game_id])!=null?ref.title:void 0)||""},group_url:function(d){var ref;return(ref=games_by_id[d.game_id])!=null?ref.url:void 0},range_left:graph_left,range_right:graph_right})}if(downloads){new I.StackedBarGrapher("#downloads_graph",downloads,{label:"Downloads",min_y:3,x_ticks:7,y_axis_padding:1.1,popup_group:function(d){var ref;return((ref=games_by_id[d.game_id])!=null?ref.title:void 0)||""},group_url:function(d){var ref;return(ref=games_by_id[d.game_id])!=null?ref.url:void 0},range_left:graph_left,range_right:graph_right})}}return DashboardAnalytics}()}).call(this);(function(){var RewardResponsesLightbox,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};RewardResponsesLightbox=function(){function RewardResponsesLightbox(){this.init=bind(this.init,this)}RewardResponsesLightbox.prototype.init=function(){};return RewardResponsesLightbox}();I.DashboardGameClaimedRewards=function(){function DashboardGameClaimedRewards(el,opts){this.el=$(el);this.el.has_tooltips();new I.FilterPickers(this.el.find(".rewards_pagination_header"));this.el.dispatch("click",{purchase_info_btn:function(_this){return function(el,e){if(I.is_middle_click(e)){return"continue"}return I.Lightbox.open_remote(el.attr("href"),I.DashboardPurchaseLightbox)}}(this),reward_responses_btn:function(_this){return function(el,e){if(I.is_middle_click(e)){return"continue"}return I.Lightbox.open_remote(el.attr("href"),I.RewardResponsesLightbox)}}(this)});this.el.on("click",".fullfilled_toggle",function(_this){return function(e){var form,msg,setting;setting=e.target.checked;msg=setting?"Mark as fulfilled?":"Mark as unfulfilled?";if(!confirm(msg)){e.preventDefault();return}form=$(e.target).closest("form");return I.remote_submit(form)}}(this))}return DashboardGameClaimedRewards}()}).call(this);(function(){I.DashboardGameClassification=function(){function DashboardGameClassification(el,opts){this.opts=opts;I.event2("game classification");this.el=$(el);I.setup_selectize(this.el);this.setup_sliders();this.setup_mp();this.form=this.el.find("form").remote_submit(function(_this){return function(res,form){if(res.errors){form.set_form_errors(res.errors);return}form.set_form_errors([]);return I.flash("Changes saved")}}(this));I.setup_dirty_warning(this.form)}DashboardGameClassification.prototype.setup_sliders=function(){var input,legend,max,max_value,min,min_value,update_legend,update_value;input=this.el.find(".players_slider_input");legend=this.el.find(".players_slider_row .sub");min_value=this.el.find(".min_players_value");max_value=this.el.find(".max_players_value");min=parseInt(min_value.val(),10);max=parseInt(max_value.val(),10);update_legend=function(_this){return function(text){return legend.text(" — "+text)}}(this);update_value=function(_this){return function(vals){min_value.val(vals[0]);max_value.val(vals[1]);if(vals[0]===vals[1]){if(vals[0]===1){return update_legend(" This is a single-player game")}else{return update_legend(" Exactly "+vals[0]+" players can play on the same device")}}else{return update_legend(" Between "+vals[0]+" and "+vals[1]+" players can play on the same device")}}}(this);this.el.find(".players_slider").slider({range:true,min:1,max:16,values:[min,max],slide:function(_this){return function(e,ui){return update_value(ui.values)}}(this)});return update_value([min,max])};DashboardGameClassification.prototype.setup_mp=function(){var feature_picker,on_feature_change;feature_picker=this.el.find("input[name='data[multiplayer_features]']");on_feature_change=function(_this){return function(e){var has_local_mp,tags;tags=feature_picker.val().split(",");has_local_mp=tags.indexOf("local")>=0;return _this.el.toggleClass("with_local_multiplayer",has_local_mp)}}(this);feature_picker.on("change",on_feature_change);return on_feature_change()};return DashboardGameClassification}()}).call(this);(function(){I.DashboardGameConversionType=function(){function DashboardGameConversionType(el,opts){this.el=$(el);new I.StackedBarGrapher("#conversion_graph",opts.counts,{label:opts.label,secondary_field:"source",x_ticks:7,range_left:opts.stat_left,range_right:opts.stat_right,popup_group:function(d){return opts.groups[d.source]||""}})}return DashboardGameConversionType}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.DashboardGameConversions=function(){function DashboardGameConversions(el,opts){var WideGraph;this.el=$(el);WideGraph=function(superClass){extend(WideGraph,superClass);function WideGraph(){return WideGraph.__super__.constructor.apply(this,arguments)}WideGraph.prototype.default_opts={range_left:opts.stat_left,range_right:opts.stat_right,x_ticks:7,min_y:10};return WideGraph}(I.Grapher);if(opts.counts.impression){new WideGraph("#impressions_graph",opts.counts.impression,{label:"Impressions"})}if(opts.counts.click){new WideGraph("#clicks_graph",opts.counts.click,{label:"Clicks",min_y:3})}if(opts.counts.download){new WideGraph("#downloads_graph",opts.counts.download,{label:"Downloads",min_y:3})}if(opts.counts.purchase){new WideGraph("#purchases_graph",opts.counts.purchase,{label:"Purchases",min_y:3})}}return DashboardGameConversions}()}).call(this);(function(){I.DashboardGameEditEmail=function(){function DashboardGameEditEmail(el,opts){this.opts=opts}return DashboardGameEditEmail}()}).call(this);(function(){I.DashboardGamePatreonAccess=function(){function DashboardGamePatreonAccess(el){this.el=$(el);I.money_input(this.el.find(".pledge_input"),{currency:"USD"})}return DashboardGamePatreonAccess}()}).call(this);(function(){I.DashboardInvoicesNew=function(){function DashboardInvoicesNew(el,opts){this.el=$(el);I.datepicker($(".start_date, .end_date"));ReactDOM.render(R.Forms.FileUploader({label:"Upload invoice",upload_url:opts.upload_url,name:"invoice[upload_id]"}),this.el.find(".upload_drop")[0]);I.money_input(this.el.find(".amount_input"))}return DashboardInvoicesNew}()}).call(this);(function(){I.DashboardJamEntryDownloads=function(){function DashboardJamEntryDownloads(el){this.el=$(el);this.setup_downloads()}DashboardJamEntryDownloads.prototype.setup_downloads=function(){return this.el.dispatch("click",{upload_download_btn:function(_this){return function(btn){return $.ajax({url:btn.data("href"),type:"post",data:I.with_csrf(),success:function(res){var err;if(res.errors){err=res.errors.join(", ");alert(err);return}return window.location=res.url}})}}(this)})};return DashboardJamEntryDownloads}()}).call(this);(function(){I.DashboardPurchaseList=function(){function DashboardPurchaseList(el){this.el=$(el);this.el.dispatch("click",{purchase_info_btn:function(_this){return function(el){return I.Lightbox.open_remote(el.attr("href"),I.DashboardPurchaseLightbox)}}(this)})}return DashboardPurchaseList}()}).call(this);(function(){var EarningsGraph,PurchasesGraph,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.DashboardPurchases=function(){function DashboardPurchases(el,opts){var currency,earnings,ref;this.el=$(el);this.el.has_tooltips();if(opts.purchases_graph){new PurchasesGraph("#purchases_graph",opts.purchases_graph,{label:"Purchases",min_y:3,unit:opts.unit,left:opts.graph_left,right:opts.graph_right})}if(opts.earnings_graph){ref=opts.earnings_graph;for(currency in ref){earnings=ref[currency];new EarningsGraph("#earnings_graph_"+currency,earnings,{label:currency+" earnings",min_y:3,currency:currency,unit:opts.unit,left:opts.graph_left,right:opts.graph_right})}}}return DashboardPurchases}();PurchasesGraph=function(superClass){extend(PurchasesGraph,superClass);function PurchasesGraph(){this.get_range=bind(this.get_range,this);return PurchasesGraph.__super__.constructor.apply(this,arguments)}PurchasesGraph.prototype.default_opts={num_days:30,x_ticks:7,min_y:10,unit:"daily"};PurchasesGraph.prototype.get_range=function(){var format;format=d3.time.format("%Y-%m-%d");return[format.parse(this.opts.left),format.parse(this.opts.right)]};PurchasesGraph.prototype.increment_date=function(t){if(this.opts.unit==="monthly"){return d3.time.month.offset(t,1)}else{return d3.time.day.offset(t,1)}};return PurchasesGraph}(I.Grapher);EarningsGraph=function(superClass){extend(EarningsGraph,superClass);function EarningsGraph(){this.get_range=bind(this.get_range,this);this.format_data=bind(this.format_data,this);this.popup_date=bind(this.popup_date,this);this.get_y=bind(this.get_y,this);return EarningsGraph.__super__.constructor.apply(this,arguments)}EarningsGraph.prototype.default_opts={label:"Amount",min_y:100,x_ticks:8};EarningsGraph.prototype.get_y=function(d){return d.sum};EarningsGraph.prototype.popup_date=function(d){var format;format=d3.time.format("%Y-%m-%d");d3.time.format("%B %Y")(format.parse(d.date));return d.date};EarningsGraph.prototype.format_data=function(){var by_date,i,len,ref,v;by_date={};ref=this.data;for(i=0,len=ref.length;i<len;i++){v=ref[i];by_date[v.date]=v}return this.map_range(function(_this){return function(t){var formatted,ref1;formatted=_this.time_format(t);return{sum:((ref1=by_date[formatted])!=null?ref1.sum:void 0)||0,date:formatted}}}(this))};EarningsGraph.prototype.get_range=function(){var format;format=d3.time.format("%Y-%m-%d");return[format.parse(this.opts.left),format.parse(this.opts.right)]};EarningsGraph.prototype.increment_date=function(t){if(this.opts.unit==="monthly"){return d3.time.month.offset(t,1)}else{return d3.time.day.offset(t,1)}};return EarningsGraph}(I.MoneyGrapher)}).call(this);(function(){I.DashboardToolGames=function(){function DashboardToolGames(el,opts){this.el=$(el);this.el.dispatch("click",{edit_tags_btn:function(_this){return function(btn){return I.Lightbox.open(R.Dashboard.ToolGameTagsLightbox({game:btn.data("game"),tool:opts.tool,url:btn.data("href"),selected_tags:_.toArray(btn.data("tags")),on_save:function(res){btn.data("tags",res.selected_tags);return I.Lightbox.close()}}))}}(this)})}return DashboardToolGames}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.EditBlogPost=function(){function EditBlogPost(el,opts){var body_input,form;this.opts=opts;this.setup_date_pickers=bind(this.setup_date_pickers,this);this.setup_tags=bind(this.setup_tags,this);this.render_attachments=bind(this.render_attachments,this);this.el=$(el);body_input=this.el.find(".body_input");if(!this.opts.allow_html){I.redactor(body_input)}this.setup_tags();this.render_attachments();this.setup_date_pickers();this.el.dispatch("click",{delete_post_btn:function(_this){return function(btn){if(!confirm("Are you sure you want to delete this post?")){return}btn.addClass("disabled").prop("disabled",true);return $.post(btn.data("url"),I.with_csrf()).then(function(res){console.log(res);if(res.errors){form.set_form_errors(res.errors);return}if(res.redirect_to){window.location=res.redirect_to}})}}(this)});form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}if(res.redirect_to){window.location=res.redirect_to;return}return I.flash("Saved post")}}(this))}EditBlogPost.prototype.render_attachments=function(){var el;el=this.el.find(".attachment_editor_drop");if(!el.length){return}return ReactDOM.render(R.BlogPosts.AttachmentEditor({upload_image_url:this.opts.upload_image_url,available_attachments:_.toArray(this.opts.available_attachments),selected_attachments:_.toArray(this.opts.selected_attachments),object:this.opts.object,add_recently_changed:!!this.opts.add_recently_changed}),el[0])};EditBlogPost.prototype.setup_tags=function(){var items,suggested_tags,tag_input;suggested_tags=_.toArray(this.opts.suggested_tags);tag_input=this.el.find(".tags_input");items=_.toArray(tag_input.data("json_value"));return this.tag_input=tag_input.selectize({delimiter:",",plugins:["remove_button"],persist:false,placeholder:tag_input.attr("placeholder"),valueField:"name",labelField:"name",searchField:["name"],closeAfterSelect:true,options:suggested_tags.concat(items).map(function(x){return{name:x}}),create:function(tag){return{name:$.trim(tag)}}})};EditBlogPost.prototype.setup_date_pickers=function(){return I.datepicker(this.el.find(".date_picker"))};return EditBlogPost}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.EditBundleForm=function(){EditBundleForm.prototype.date_format="yy-mm-dd";EditBundleForm.prototype.time_format="HH:mm:ss";EditBundleForm.prototype.format_date_time=function(d){var date,time;time=$.datepicker.formatTime(this.time_format,{hour:d.getHours(),minute:d.getMinutes(),second:d.getSeconds()});date=$.datepicker.formatDate(this.date_format,new Date(d));return date+" "+time};function EditBundleForm(el){this.format_date_time=bind(this.format_date_time,this);var area,other_save;this.el=$(el);this.form=this.el.find("form").remote_submit(function(_this){return function(res,form){if(res.errors){form.set_form_errors(res.errors);return}form.set_form_errors([]);if(res.url){return window.location=res.url}else{return I.flash("Co-op bundle updated")}}}(this));other_save=this.el.find(".header_nav").find(".save_btn").on("click",function(_this){return function(){return _this.form.submit()}}(this));this.form.on("i:before_submit",function(_this){return function(){return other_save.prop("disabled",true).addClass("disabled")}}(this));this.form.on("i:after_submit",function(_this){return function(){return other_save.prop("disabled",false).removeClass("disabled")}}(this));I.setup_dirty_warning(this.form);this.setup_datepickers();this.setup_timezone();I.format_dates(this.el);if(area=this.el.find("textarea")){I.redactor(area,{minHeight:80})}this.el.dispatch("click",{delete_bundle_btn:function(_this){return function(btn){if(!confirm("Are you sure you want to delete this bundle?")){return}btn.addClass("disabled");return $.ajax({type:"post",data:I.with_csrf(),url:btn.data("url"),success:function(res){return window.location=res.redirect_to||"/"}})}}(this)})}EditBundleForm.prototype.setup_datepickers=function(){var duration_summary,end,end_picker,pickers,start_picker,update_picker;pickers=this.el.find(".date_picker");if(!pickers.length){return}start_picker=this.el.find(".date_picker.start_date");end_picker=this.el.find(".date_picker.end_date");duration_summary=this.el.find(".duration_summary");update_picker=function(input,set_min){var end,real_date,start;if(set_min==null){set_min=true}if(set_min&&input.is(".start_date")){real_date=input.datetimepicker("getDate");end_picker.datetimepicker("option","minDate",new Date(+real_date))}start=start_picker.datetimepicker("getDate");end=end_picker.datetimepicker("getDate");if(start&&end){return duration_summary.text(I.specific_humanize(moment.duration(end-start)))}};if(!pickers){return}I.datetimepicker(pickers,{onSelect:function(val){return update_picker($(this))}});if(start_picker.val()){end=$.datepicker.parseDateTime(this.date_format,this.time_format,end_picker.val());end_picker.datetimepicker("setDate",end);return update_picker(start_picker)}};EditBundleForm.prototype.setup_timezone=function(){return this.el.find(".timezone_offset").val((new Date).getTimezoneOffset()/60)};return EditBundleForm}()}).call(this);(function(){var CoverImageUpload,ExternalFileUpload,FileUpload,ImageUpload,ScreenshotUpload,SlurpFileUpload,Upload,UploadDescriptionLightbox,get_template,lazy_template,upload_error,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,slice=[].slice;upload_error=function(uploader,msg){if(msg==="title must be provided"){msg="Please enter a title for your game first"}if(msg){return I.flash(msg,"error")}};Upload=I.Upload,ImageUpload=I.ImageUpload,get_template=I.get_template,lazy_template=I.lazy_template;UploadDescriptionLightbox=function(superClass){extend(UploadDescriptionLightbox,superClass);function UploadDescriptionLightbox(){this.init=bind(this.init,this);return UploadDescriptionLightbox.__super__.constructor.apply(this,arguments)}UploadDescriptionLightbox.prototype.init=function(uploader){var input,name,uploader_input;name=uploader.find(".upload_display_name").text();this.el.find(".upload_name").text(name);uploader_input=uploader.find(".description_input");input=this.el.find(".description_input").val(uploader_input.val());I.redactor(input,{minHeight:100});return this.el.dispatch("click",{save_description_btn:function(_this){return function(btn){uploader_input.val(input.val());return I.Lightbox.close()}}(this)})};return UploadDescriptionLightbox}(I.Lightbox);FileUpload=function(superClass){extend(FileUpload,superClass);FileUpload.prototype.kind="upload";FileUpload.type_to_extension={flash:/^swf$/,unity:/^unity3d$/,java:/^jar$/,html:/^zip|html$/};FileUpload.get_extension=function(filename){var m;if(!filename){return}m=filename.match(/\.(\w+)$/);return m!=null?m[1].toLowerCase():void 0};function FileUpload(editor,file1,opts1){var ref,ref1;this.editor=editor;this.file=file1;this.opts=opts1!=null?opts1:{};this.cancel_upload=bind(this.cancel_upload,this);if(this.opts.upload){this.upload=this.opts.upload;this.state="ready"}else{this.state="uploading";this.upload={filename:(ref=this.file)!=null?ref.name:void 0,size:(ref1=this.file)!=null?ref1.size:void 0}}}FileUpload.prototype.have_upload_data=function(){var j,len,ref,ref1,replace_id,results,upload;this.upload.id=this.upload_data.upload_id;if(replace_id=this.upload_data.replaced_upload_id){I.event("upload","replace","replaced");ref=this.editor.game.uploads;results=[];for(j=0,len=ref.length;j<len;j++){upload=ref[j];if(replace_id===((ref1=upload.upload)!=null?ref1.id:void 0)){upload.remove();this.upload=upload.upload;this.upload.id=this.upload_data.upload_id;this.editor.render_uploads();break}else{results.push(void 0)}}return results}};FileUpload.prototype.after_save=function(){this.state="ready";return this.editor.render_uploads()};FileUpload.prototype.valid_for_embed=function(){var extension,pattern;if(!(this.upload&&this.upload.filename)){return false}pattern=FileUpload.type_to_extension[this.editor.get_type()];extension=FileUpload.get_extension(this.upload.filename);return extension&&pattern&&pattern.test(extension)};FileUpload.prototype.progress=function(sent,total){this.progress_percent=Math.round(sent/total*100);return this.editor.render_uploads()};FileUpload.prototype.cancel_upload=function(upload,msg,action){if(action==="remove"){this.remove()}else{this.state="failed"}return this.editor.render_uploads()};FileUpload.prototype.save_upload=function(fn){if(!this.upload_data){return}return $.ajax({url:this.upload_data.success_url,data:I.with_csrf(),type:"post",success:function(_this){return function(res){var err_msg;if(res.errors){err_msg=res.errors.join(", ");I.event("upload_error","file",err_msg);upload_error(_this,err_msg);_this.cancel_upload();return}_this.after_save();return typeof fn==="function"?fn.apply(null,[_this].concat(slice.call(arguments))):void 0}}(this)})};FileUpload.prototype.remove=function(){var idx,j,len,ref,results,upload;ref=this.editor.game.uploads;results=[];for(idx=j=0,len=ref.length;j<len;idx=++j){upload=ref[idx];if(upload===this){this.editor.game.uploads.splice(idx,1);results.push(this.editor.render_uploads())}else{results.push(void 0)}}return results};FileUpload.prototype.delete_upload=function(fn){if(!this.upload){return}this.remove();return $.ajax({url:this.editor.upload_prefix()+"/upload/delete/"+this.upload.id,type:"post",data:I.with_csrf(),success:fn})};return FileUpload}(Upload);SlurpFileUpload=function(superClass){extend(SlurpFileUpload,superClass);SlurpFileUpload.prototype.ping_time=1e3;function SlurpFileUpload(editor,file1){var ref,ref1;this.editor=editor;this.file=file1;this.state="uploading";this.upload={filename:(ref=this.file)!=null?ref.name:void 0,size:(ref1=this.file)!=null?ref1.bytes:void 0}}SlurpFileUpload.prototype.start_upload=function(fn,fail_fn){var req;if(this.upload_data){return}this.progress(1,1);req=$.post(this.editor.upload_prefix()+"/upload/slurp",I.with_csrf({filename:this.file.name,kind:"upload",url:this.file.link}));req.done(function(_this){return function(res){if(res.errors){I.event("upload_error","slurp_file",res.errors.join(", "));alert(res.errors.join(", "));_this.cancel_upload();return typeof fail_fn==="function"?fail_fn(_this):void 0}else{_this.upload_data=res;if(typeof _this.have_upload_data==="function"){_this.have_upload_data()}return _this.poll_for_completion(fn)}}}(this));return req.fail(function(_this){return function(){I.event("upload_error","slurp_file","slurp server error");_this.cancel_upload();return typeof fail_fn==="function"?fail_fn(_this):void 0}}(this))};SlurpFileUpload.prototype.poll_for_completion=function(fn,fail_fn){var req;req=$.get(this.editor.upload_prefix()+"/upload/slurp/"+this.upload_data.upload_id);req.done(function(_this){return function(res){if(res.deleted){_this.cancel_upload();if(typeof fail_fn==="function"){fail_fn(_this)}return}if(res.ready){_this.state="ready";_this.editor.render_uploads();return}return setTimeout(function(){_this.ping_time=Math.min(_this.ping_time+100,3e3);return _this.poll_for_completion(fn)},_this.ping_time)}}(this));return req.fail(function(_this){return function(){I.event("upload_error","slurp_file","poll server error");_this.cancel_upload();return typeof fail_fn==="function"?fail_fn(_this):void 0}}(this))};return SlurpFileUpload}(FileUpload);ExternalFileUpload=function(superClass){extend(ExternalFileUpload,superClass);function ExternalFileUpload(){this.load_upload=bind(this.load_upload,this);ExternalFileUpload.__super__.constructor.apply(this,arguments);this.upload.external=true;this.upload.just_created=true;this.progress_percent=100}ExternalFileUpload.prototype.load_upload=function(upload_data){this.upload.id=upload_data.upload_id;this.state="ready";return this.editor.render_uploads()};return ExternalFileUpload}(FileUpload);ScreenshotUpload=function(superClass){extend(ScreenshotUpload,superClass);ScreenshotUpload.prototype.label="screenshot";ScreenshotUpload.prototype.template=lazy_template(ScreenshotUpload,"screenshot_uploader");ScreenshotUpload.prototype.success_params={type:"screenshot",thumb_size:"editor_preview"};function ScreenshotUpload(){ScreenshotUpload.__super__.constructor.apply(this,arguments);this.el=$(this.template(this));this.progress_inner=this.el.find(".progress_inner")}ScreenshotUpload.prototype.progress=function(sent,total){var p,ref;p=Math.round(100*sent/total);return(ref=this.progress_inner)!=null?ref.css("right",100-p+"%"):void 0};return ScreenshotUpload}(ImageUpload);CoverImageUpload=function(superClass){extend(CoverImageUpload,superClass);function CoverImageUpload(){return CoverImageUpload.__super__.constructor.apply(this,arguments)}CoverImageUpload.prototype.label="cover image";CoverImageUpload.prototype.success_params={type:"cover",thumb_size:"cover_big"};return CoverImageUpload}(ImageUpload);I.EditGame=function(){EditGame.FileUpload=FileUpload;function EditGame(el,game,opts1){var other_save;this.game=game;this.opts=opts1;this.refresh_has_download=bind(this.refresh_has_download,this);this.render_uploads=bind(this.render_uploads,this);this.render_links=bind(this.render_links,this);this.render_tags=bind(this.render_tags,this);this.render_access_control=bind(this.render_access_control,this);this.render_price_picker=bind(this.render_price_picker,this);this.render_embed_options=bind(this.render_embed_options,this);this.state={};this.user_slug=this.opts.user_slug;this.is_new=!this.game.id;this.el=$(el);this.el.has_tooltips();this.setup_uploader();this.setup_type_picker();this.setup_cover();this.setup_screenshots();this.setup_redactor();this.setup_slug_picker();this.setup_classification_picker();if(this.opts.enable_dropbox){this.setup_dropbox()}this.render_tags();this.render_links();this.render_access_control();this.render_price_picker();this.render_embed_options();I.setup_selectize(this.el);other_save=this.el.find(".header_nav").find(".save_btn").on("click",function(_this){return function(){return _this.form.submit()}}(this));this.form=this.el.find("form").remote_submit(function(_this){return function(res,form){if(res.game){$.extend(_this.game,res.game);_this.form.attr("action",_this.game_prefix())}if(res.errors){form.set_form_errors(res.errors);if(_this.game_deferred){_this.game_deferred.reject(res.errors)}return}form.set_form_errors([]);if(_this.game_deferred){return _this.game_deferred.resolve(_this.game)}else if(_this.is_new){if(_this.game.url){return window.location=_this.game.url}}else{return I.flash("Saved")}}}(this));this.form.on("i:before_submit",function(_this){return function(){return other_save.prop("disabled",true).addClass("disabled")}}(this));this.form.on("i:after_submit",function(_this){return function(){return other_save.prop("disabled",false).removeClass("disabled")}}(this));I.setup_dirty_warning(this.form,function(_this){return function(){if(_.any(_this.game.uploads,function(u){return u.state==="uploading"})){return"There are uploads in progress."}else{return _this.form.data("dirty")}}}(this));R.dispatch(this.el,{"game:set_state":function(_this){return function(event,state){_this.state=$.extend(_this.state,state);_this.render_uploads();_this.render_price_picker();_this.render_tags();return _this.render_embed_options()}}(this),"game:update_upload":function(_this){return function(event,file){return _this.refresh_has_download()}}(this)});this.el.dispatch("click",{external_file_btn:function(_this){return function(btn){var upload;upload=new ExternalFileUpload(_this);_this.append_upload(upload);return _this.prepare_upload(function(){return I.prepare_upload(_this.upload_prefix(),{kind:"upload",storage:"external"},function(data){return upload.load_upload(data)})},function(){return upload.cancel_upload()})}}(this),delete_game_btn:function(_this){return function(btn){if(_this.opts.delete_blocked){I.Lightbox.open(R.GameEdit.DeleteBlockedLightbox({}));return}if(confirm("Are you sure you want to delete this game?")){btn.addClass("disabled");return $.ajax({type:"post",data:I.with_csrf(),url:btn.data("url"),success:function(res){return window.location=res.redirect_to||"/"}})}}}(this)})}EditGame.prototype.setup_dropbox=function(){var button;if(window.Dropbox==null){return}button=Dropbox.createChooseButton({linkType:"direct",multiselect:true,success:function(_this){return function(files){return _this.with_game(function(){var file,j,len,results,slurp;I.event("upload","dropbox","slurp");results=[];for(j=0,len=files.length;j<len;j++){file=files[j];slurp=new SlurpFileUpload(_this,file);slurp.start_upload();results.push(_this.append_upload(slurp))}return results})}}(this)});return this.el.find(".upload_buttons").append(button)};EditGame.prototype.make_upload_button=function(btn){var ref;if(window.FormData&&!((ref=window.location.hash)!=null?ref.match(/\bold_uploader=1\b/):void 0)){I.make_upload_button.apply(I,[this].concat(slice.call(arguments)));return btn.addClass("has_multi_upload")}else{return I.make_popup_upload_button.apply(I,[this].concat(slice.call(arguments)))}};EditGame.prototype.setup_slug_picker=function(){return I.slug_input(this.el.find(".slug_input"),this.el.find(".title_input"))};EditGame.prototype.setup_redactor=function(){var j,len,ref,results,textarea;if(this.opts.enable_codemirror){ref=this.el.find("textarea");results=[];for(j=0,len=ref.length;j<len;j++){textarea=ref[j];results.push(CodeMirror.fromTextArea(textarea,{mode:"htmlmixed",lineNumbers:true,tabSize:2}))}return results}else{I.redactor(this.el.find(".game_description_input"),{minHeight:200});return I.redactor(this.el.find(".game_instructions_input"),{minHeight:60})}};EditGame.prototype.setup_screenshots=function(){var btn,j,len,ref,screen;this.screen_editor=this.el.find(".screenshot_editor");this.screen_list=this.screen_editor.find(".screenshot_list");this.screen_queue=this.screen_editor.find(".screenshot_queue");btn=this.screen_editor.find(".add_screenshot_btn");this.make_upload_button(btn,ScreenshotUpload,{finish_upload:function(_this){return function(upload,res){upload.el.remove();_this.add_screenshot(res);return _this.update_screenshot_positions()}}(this),cancel_upload:function(_this){return function(upload,err){upload.el.remove();upload_error.apply(null,arguments);return _this.update_screenshot_positions()}}(this),queue_upload:function(_this){return function(upload){return _this.screen_queue.append(upload.el)}}(this)});if(this.game.screenshots){ref=this.game.screenshots;for(j=0,len=ref.length;j<len;j++){screen=ref[j];this.add_screenshot(screen)}}this.update_screenshot_positions();return this.screen_list.dispatch("click",{delete_screen_btn:function(_this){return function(btn){var data,id;screen=btn.closest(".screenshot");data=screen.data("screen");id=data.id;if(confirm("Are you sure you want to delete this screenshot?")){I.ImageUpload.delete_image(_this,id);_this.remove_screenshot(screen);return _this.update_screenshot_positions()}}}(this),move_screen_up_btn:function(_this){return function(btn){var screenshot;screenshot=btn.closest(".screenshot");screenshot.swap_with(screenshot.prev());return _this.update_screenshot_positions()}}(this),move_screen_down_btn:function(_this){return function(btn){var screenshot;screenshot=btn.closest(".screenshot");screenshot.swap_with(screenshot.next());return _this.update_screenshot_positions()}}(this)})};EditGame.prototype.update_screenshot_positions=function(){var i,input,j,len,ref,results;ref=this.screen_list.find(".screenshot_position_input");results=[];for(i=j=0,len=ref.length;j<len;i=++j){input=ref[i];results.push($(input).val(i))}return results};EditGame.prototype.add_screenshot=function(screen){this.screen_template||(this.screen_template=get_template("screenshot"));this.screen_list.addClass("has_image");screen=$(this.screen_template(screen)).data("screen",screen);return screen.appendTo(this.screen_list)};EditGame.prototype.remove_screenshot=function(screen){screen.remove();if(this.screen_list.find("> *").length===0){return this.screen_list.removeClass("has_image")}};EditGame.prototype.setup_cover=function(){var btn;this.cover=this.el.find(".cover_image");btn=this.cover.find(".upload_cover_btn");this.make_upload_button(btn,CoverImageUpload,{start_uploading:function(_this){return function(){return _this.cover.addClass("loading")}}(this),stop_uploading:function(_this){return function(){return _this.cover.removeClass("loading")}}(this),cancel_upload:upload_error,finish_upload:function(_this){return function(upload,res){return _this.set_cover_image(res.url)}}(this)});if(this.game.cover_url){this.set_cover_image(this.game.cover_url)}return this.cover.on("click",".delete_cover_btn",function(_this){return function(){if(!_this.cover.hasClass("has_image")){return}if(!confirm("Are you sure you want to delete the cover image?")){return}I.ImageUpload.delete_image(_this,"cover-image");_this.set_cover_image(null);return false}}(this))};EditGame.prototype.set_cover_image=function(url){this.cover.toggleClass("has_image",!!url);url=url?"url("+url+")":"";return this.cover.css("background-image",url)};EditGame.prototype.get_type=function(){this.type_picker||(this.type_picker=this.el.find(".game_type_picker"));return this.type_picker.find("select").val()};EditGame.prototype.setup_type_picker=function(){this.type_picker||(this.type_picker=this.el.find(".game_type_picker"));return this.type_picker.on("change",function(_this){return function(e){var type;type=$(e.target).val();R.trigger(_this.el,"game:set_state",{type:type});_this.el.removeClass("type_flash type_unity type_java type_html");if(type!=="default"){_this.el.addClass("type_"+type)}_this.refresh_embed_state()}}(this))};EditGame.prototype.setup_classification_picker=function(){var noun_el,nouns,update_classification;this.classification_picker=this.el.find(".classification_picker").find("select");nouns=this.classification_picker.closest("[data-nouns]").data("nouns");noun_el=this.el.find(".user_classification_noun");update_classification=function(_this){return function(){var classify;classify=_this.classification_picker.val();R.trigger(_this.el,"game:set_state",{classification:classify});noun_el.text(nouns[classify]);return _this.el.toggleClass("is_game",classify==="game")}}(this);this.classification_picker.on("change",update_classification);return update_classification()};EditGame.prototype.render_embed_options=function(){var props,ref;this.game_dimensions_drop||(this.game_dimensions_drop=this.el.find(".game_dimensions_drop"));props=$.extend({type:(ref=this.state.type)!=null?ref:this.opts.type},this.opts.embed_options);return ReactDOM.render(R.GameEdit.EmbedOptions(props),this.game_dimensions_drop[0])};EditGame.prototype.render_price_picker=function(){var props;this.price_picker_drop||(this.price_picker_drop=this.el.find(".price_picker_drop"));props={currency:this.opts.currency,min_price:this.opts.min_price,suggested_price:this.opts.suggested_price,disable_payments:this.opts.disable_payments,money_placeholder:this.opts.money_placeholder,is_embed:this.get_type()!=="default",default_donation_amount:this.opts.default_donation_amount,reward_required:this.opts.reward_required,rewards_url:this.opts.rewards_url};return ReactDOM.render(R.GameEdit.PricePicker(props),this.price_picker_drop[0])};EditGame.prototype.render_access_control=function(){this.access_control_drop||(this.access_control_drop=this.el.find(".access_control_drop"));return ReactDOM.render(R.GameEdit.AccessControl({game:this.game,noun:this.opts.noun,published:this.opts.published,active:this.opts.active,unlisted:this.opts.unlisted,restricted:this.opts.restricted,password:this.opts.password,purchases_count:this.opts.purchases_count}),this.access_control_drop[0])};EditGame.prototype.render_tags=function(){var opts,ref;this.tags_drop||(this.tags_drop=this.el.find(".tags_drop"));opts=$.extend({classification:(ref=this.state.classification)!=null?ref:this.opts.classification,on_change_tags:function(_this){return function(tags){_this.current_tags=tags;return _this.render_links()}}(this)},this.opts.game_tags);return ReactDOM.render(R.GameEdit.GameTags(opts),this.tags_drop[0])};EditGame.prototype.render_links=function(){var opts,ref,tags;this.links_drop||(this.links_drop=this.el.find(".links_drop"));tags=_.toArray(this.current_tags||((ref=this.opts.game_tags)!=null?ref.tags:void 0)||[]);opts=$.extend({tags:tags},this.opts.game_links);return ReactDOM.render(R.GameEdit.GameLinks(opts),this.links_drop[0])};EditGame.prototype.render_uploads=function(){var ref,ref1;this.upload_drop||(this.upload_drop=this.upload_editor.find(".upload_drop"));ReactDOM.render(R.GameEdit.UploadList({game_id:this.game.id,uploads:this.game.uploads,game_min_price:(ref=this.state.min_price)!=null?ref:this.opts.min_price,disable_payments:(ref1=this.state.disable_payments)!=null?ref1:this.opts.disable_payments,currency:this.opts.currency,money_placeholder:this.opts.money_placeholder}),this.upload_drop[0]);return this.refresh_has_download()};EditGame.prototype.refresh_has_download=function(){var has_download,j,len,ref,upload;has_download=false;ref=this.game.uploads;for(j=0,len=ref.length;j<len;j++){upload=ref[j].upload;if(upload.embed){continue}if(upload.hidden){continue}has_download=true;break}return this.el.toggleClass("has_download",has_download)};EditGame.prototype.setup_uploader=function(){var btn,upload;this.upload_editor=this.el.find(".upload_editor");this.game.uploads=function(){var j,len,ref,results;ref=this.game.uploads||[];results=[];for(j=0,len=ref.length;j<len;j++){upload=ref[j];results.push(new FileUpload(this,null,{upload:upload}))}return results}.call(this);this.render_uploads();btn=this.el.find(".add_file_btn");return this.make_upload_button(btn,FileUpload,{queue_upload:function(_this){return function(upload){return _this.append_upload(upload)}}(this)})};EditGame.prototype.append_upload=function(upload){this.game.uploads.push(upload);return this.render_uploads()};EditGame.prototype.refresh_embed_state=function(){var pattern,ref,type,upload,valid_uploads;type=this.get_type();pattern=FileUpload.type_to_extension[type];valid_uploads=function(){var j,len,ref,results;ref=this.game.uploads;results=[];for(j=0,len=ref.length;j<len;j++){upload=ref[j];if(upload.valid_for_embed()){results.push(upload)}else{upload.upload.embed=false;continue}}return results}.call(this);if(!_.any(valid_uploads,function(u){return u.embed})){if((ref=valid_uploads[0])!=null){ref.upload.embed=true}}this.render_uploads();return true};EditGame.prototype.game_prefix=function(){return"/game/edit/"+this.game.id};EditGame.prototype.upload_prefix=function(){return this.game_prefix()};EditGame.prototype.prepare_upload=function(fn,fail_fn){return this.with_game(function(_this){return function(){return fn()}}(this),function(_this){return function(){return typeof fail_fn==="function"?fail_fn(void 0,"remove"):void 0}}(this))};EditGame.prototype.with_game=function(fn,fail_fn){if(this.game.id!=null){return typeof fn==="function"?fn(this.game):void 0}if(!this.game_deferred){this.game_deferred=$.Deferred().always(function(_this){return function(){return delete _this.game_deferred}}(this));this.form.trigger("submit")}this.game_deferred.done(fn);if(fail_fn){return this.game_deferred.fail(fail_fn)}};return EditGame}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.EditSaleForm=function(){EditSaleForm.prototype.date_format="yy-mm-dd";EditSaleForm.prototype.time_format="HH:mm:ss";EditSaleForm.prototype.format_date_time=function(d){var date,time;time=$.datepicker.formatTime(this.time_format,{hour:d.getHours(),minute:d.getMinutes(),second:d.getSeconds()});date=$.datepicker.formatDate(this.date_format,new Date(d));return date+" "+time};function EditSaleForm(el,opts){var other_save;this.opts=opts;this.setup_game_pickers=bind(this.setup_game_pickers,this);this.format_date_time=bind(this.format_date_time,this);this.sale=this.opts.sale;this.is_new=!this.sale;this.el=$(el);this.setup_datepickers();this.setup_bundle_price();this.setup_goal_amount();this.render();this.setup_game_pickers();this.setup_timezone();this.el.has_tooltips();other_save=this.el.find(".header_nav").find(".save_btn").on("click",function(_this){return function(){return _this.form.submit()}}(this));this.form=this.el.find("form").remote_submit(function(_this){return function(res,form){if(res.errors){form.set_form_errors(res.errors);return}form.set_form_errors([]);if(_this.is_new){return window.location=res.url}else{return I.flash("Sale saved")}}}(this));this.form.on("i:before_submit",function(_this){return function(){return other_save.prop("disabled",true).addClass("disabled")}}(this));this.form.on("i:after_submit",function(_this){return function(){return other_save.prop("disabled",false).removeClass("disabled")}}(this));I.setup_dirty_warning(this.form);this.el.dispatch("click",{select_all_games_btn:function(_this){return function(btn){var checkboxes;checkboxes=btn.closest(".input_group").find(".game_row:not(.disabled) input");checkboxes.prop("checked",true);return _this.el.trigger("i:update_games")}}(this),select_no_games_btn:function(_this){return function(btn){var checkboxes;checkboxes=btn.closest(".input_group").find(".game_row:not(.disabled) input");checkboxes.prop("checked",false);return _this.el.trigger("i:update_games")}}(this)});I.redactor(this.el.find("textarea"),{minHeight:80})}EditSaleForm.prototype.render_errors=function(errors){var err,lis;this.form_errors||(this.form_errors=this.el.find(".form_errors"));this.el.addClass("has_errors");lis=function(){var i,len,results;results=[];for(i=0,len=errors.length;i<len;i++){err=errors[i];results.push($("<li>").text(err))}return results}();this.form_errors.find("ul").empty().append(lis);return this.form_errors.hide().slideDown("fast")};EditSaleForm.prototype.setup_goal_amount=function(){this.goal_input=this.el.find(".goal_input");return I.money_input(this.goal_input)};EditSaleForm.prototype.setup_bundle_price=function(){var game_list,update_suggested_price;this.price_input=this.el.find(".bundle_price_input");I.money_input(this.price_input);this.el.on("change",".bundle_toggle_input",function(_this){return function(e){var target;target=$(e.currentTarget);return _this.el.toggleClass("is_bundle",target.prop("checked"))}}(this));game_list=this.el.find(".game_list");update_suggested_price=function(_this){return function(){var c,can_bundle,checked,input,rate,total;if(_this.current_rate==null){return}rate=_this.reverse_rate?1+_this.current_rate/100:1-_this.current_rate/100;checked=game_list.find("input:checked");can_bundle=rate>0&&checked.length>1;_this.selected_games=function(){var i,len,results;results=[];for(i=0,len=checked.length;i<len;i++){c=checked[i];results.push({id:$(c).data("game_id"),min_price:$(c).data("game_min_price"),paid_status:$(c).data("game_paid_status")})}return results}();_this.suggested_price=function(){var i,len;if(can_bundle){total=0;for(i=0,len=checked.length;i<len;i++){input=checked[i];total+=$(input).data("game_min_price")}return total*rate}}();return _this.render()}}(this);return this.el.on("i:update_rate i:update_games",function(_this){return function(){return update_suggested_price()}}(this))};EditSaleForm.prototype.setup_timezone=function(){return this.el.find(".timezone_offset").val((new Date).getTimezoneOffset()/60)};EditSaleForm.prototype.render=function(){this.render_slider();this.render_bundle_price();this.render_sale_conditions();return this.render_coupon_settings()};EditSaleForm.prototype.render_coupon_settings=function(){var ref,ref1,ref2,ref3,ref4;return ReactDOM.render(R.EditSale.CouponSettings({user_slug:this.opts.user_slug,taken_slugs:_.toArray(this.opts.taken_slugs),coupon:(ref=this.sale)!=null?ref.coupon:void 0,redeems:(ref1=this.sale)!=null?ref1.coupon_redeems:void 0,max_redeems:(ref2=this.sale)!=null?ref2.coupon_max_redeems:void 0,rate:(ref3=this.current_rate)!=null?ref3:(ref4=this.sale)!=null?ref4.rate:void 0}),this.el.find(".coupon_drop")[0])};EditSaleForm.prototype.render_sale_conditions=function(){return ReactDOM.render(R.EditSale.SaleConditions({selected_games:this.selected_games||[],sale_triggers:this.opts.sale_triggers||[],games:this.opts.games||[]}),this.el.find(".sale_conditions_drop")[0])};EditSaleForm.prototype.render_bundle_price=function(){var ref,ref1,ref2;return ReactDOM.render(R.EditSale.BundlePrice({rate:(ref=this.current_rate)!=null?ref:(ref1=this.sale)!=null?ref1.rate:void 0,bundle_price:(ref2=this.sale)!=null?ref2.bundle_price:void 0,currency:this.opts.currency,selected_games:this.selected_games||[],suggested_price:this.suggested_price}),this.el.find(".bundle_price_drop")[0])};EditSaleForm.prototype.render_slider=function(){var ref,ref1;this._set_rate||(this._set_rate=function(_this){return function(){var game_list,prices;game_list=_this.el.find(".game_list");prices=game_list.find(".game_price.after_sale");return function(rate,reverse){var amount,i,len,p,val;val=rate/100;for(i=0,len=prices.length;i<len;i++){p=prices[i];p=$(p);amount=reverse?p.data("default_price")*(1+val):p.data("default_price")*(1-val);p.text(I.format_money(amount,_this.opts.currency))}_this.current_rate=rate;_this.reverse_rate=reverse;return _this.el.trigger("i:update_rate",[val])}}}(this)());return ReactDOM.render(R.EditSale.RatePicker({rate:(ref=this.sale)!=null?ref.rate:void 0,allow_promotion_claim:(ref1=this.sale)!=null?ref1.allow_promotion_claim:void 0,set_rate:this._set_rate}),this.el.find(".sale_rate_drop")[0])};EditSaleForm.prototype.setup_datepickers=function(){var duration_summary,end,end_picker,pickers,start_picker,update_picker;start_picker=this.el.find(".date_picker.start_date");end_picker=this.el.find(".date_picker.end_date");duration_summary=this.el.find(".duration_summary");update_picker=function(input,set_min){var end,real_date,start;if(set_min==null){set_min=true}if(set_min&&input.is(".start_date")){real_date=input.datetimepicker("getDate");end_picker.datetimepicker("option","minDate",new Date(+real_date))}start=start_picker.datetimepicker("getDate");end=end_picker.datetimepicker("getDate");if(start&&end){return duration_summary.text(I.specific_humanize(moment.duration(end-start)))}};pickers=this.el.find(".date_picker");I.datetimepicker(pickers,{onSelect:function(val){return update_picker($(this))}});if(start_picker.val()){end=$.datepicker.parseDateTime(this.date_format,this.time_format,end_picker.val());end_picker.datetimepicker("setDate",end);return update_picker(start_picker)}};EditSaleForm.prototype.setup_game_pickers=function(){var game_list;game_list=this.el.find(".game_list");return game_list.on("change","input",function(_this){return function(){return _this.el.trigger("i:update_games")}}(this))};return EditSaleForm}()}).call(this);(function(){I.EmailEditForm=function(){function EmailEditForm(el,opts){var form,update;this.opts=opts;this.el=$(el);update=_.debounce(function(_this){return function(){return _this.update_preview()}}(this),100);this.setup_recipients();this.subject_input=this.el.find(".subject_input").on("change, keyup",update);this.body_input=I.redactor(this.el.find(".body_input"),{changeCallback:update});this.el.on("change",".show_download_input",function(_this){return function(e){return _this.update_preview()}}(this));this.el.find(".send_btn").on("click",function(_this){return function(){if(!confirm("Are you sure you want to send this email? It will be delivered right away.")){return false}}}(this));form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){return form.set_form_errors(res.errors)}else if(res.redirect_to){return window.location=res.redirect_to}}}(this));_.defer(function(_this){return function(){return _this.update_preview()}}(this))}EmailEditForm.prototype.setup_recipients=function(){var input;input=this.el.find(".recipients");return input.selectize({valueField:"id",persist:false,delimiter:",",options:_.toArray(this.opts.recipients),render:{item:function(_this){return function(item,escape){return"<div>"+escape(item.name)+"</div>"}}(this),option:function(_this){return function(item,escape){var label,prefix;label=escape(item.name)+" ("+_.str.numberFormat(item.count)+")";prefix=function(){switch(item.type){case"download_key_group":return"<strong>[Group]</strong> ";case"reward":return"<strong>[Reward]</strong> ";default:return""}}();return"<div>"+prefix+escape(label)+"</div>"}}(this)}})};EmailEditForm.prototype.update_preview=function(){var body,real_subject,subject;this.show_link_input||(this.show_link_input=this.el.find(".show_download_input"));this.preview_el||(this.preview_el=this.el.find(".email_preview"));this.preview_subject||(this.preview_subject=this.preview_el.find(".preview_subject"));this.preview_body||(this.preview_body=this.preview_el.find(".body_drop"));if(this.show_link_input.length){this.preview_el.toggleClass("show_download_link",this.show_link_input.prop("checked"))}subject=this.subject_input.val();body=this.body_input.val();real_subject=_.template(this.preview_subject.data("template"))({object_title:this.opts.object_title,subject:subject});this.preview_subject.html(real_subject);return this.preview_body.html(body)};return EmailEditForm}()}).call(this);(function(){var EditEventLightbox,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;EditEventLightbox=function(superClass){extend(EditEventLightbox,superClass);function EditEventLightbox(){this.init=bind(this.init,this);return EditEventLightbox.__super__.constructor.apply(this,arguments)}EditEventLightbox.prototype.init=function(parent){if(!$.fn.redactor&&this.el.data().redactor){$("head").append(this.el.data().redactor)}I.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),{formatting:["p","blockquote","pre"]})}}(this));return this.el.find("form").remote_submit(function(_this){return function(res){var event;if(res.event){event=$(res.event).insertAfter(parent).hide();parent.fadeOut(function(){event.fadeIn();return parent.remove()})}return I.Lightbox.close()}}(this))};return EditEventLightbox}(I.Lightbox);I.EventList=function(){EventList.prototype.track_category="event_list";function EventList(el,opts){this.el=$(el);$.extend(this,opts);I.format_filesize(this.el);I.has_follow_button(this.el);this.el.on("i:delegate_tracking",function(_this){return function(e,push){return push(I.ga_tracker(_this.track_category)($(e.target)))}}(this));I.deferred_links(this.el,"a[data-label]");this.el.has_tooltips();this.grid=new I.GameGrid(this.el,{sizer:true});this.grid.setup_conversion_tracking("9");this.el.dispatch("click",{edit_btn:function(_this){return function(btn){var parent;parent=btn.closest(".event_row");btn.trigger("i:track_link");return I.Lightbox.open_remote(btn.data("edit_url"),EditEventLightbox,parent)}}(this),delete_btn:function(_this){return function(btn){if(btn.is(".loading")){return}if(!confirm("Are you sure you want to delete this?")){return}btn.addClass("loading");btn.trigger("i:track_link");return $.post(btn.data("delete_url"),I.with_csrf(),function(res){var event_row;return event_row=btn.closest(".event_row").slideUp(function(){return event_row.remove()})})}}(this),like_btn:function(_this){return function(btn){var event_row,track_label,url;if(btn.is(".loading")){return}event_row=btn.closest(".event_row");btn.addClass("loading");url=btn.is(".liked")?btn.data("unlike_url"):(btn.trigger("i:track_link"),btn.data("like_url"));track_label=btn.data("label");if(btn.is(".liked")){track_label="un"+track_label}return $.post(url,I.with_csrf(),function(res){var count,new_msg,old_msg;btn.removeClass("loading");if(res.success){btn.toggleClass("liked");count=res.new_count;event_row.toggleClass("has_like",count>0);if(count>0){event_row.find(".like_count").text(count)}old_msg=btn.data("tooltip");new_msg=btn.data("tooltip_alt");btn.data("tooltip",new_msg);btn.data("tooltip_alt",old_msg);btn.trigger("i:refresh_tooltip")}if(res.errors){return alert(res.errors.join(", "))}})}}(this)})}return EventList}();I.EventFeed=function(superClass){extend(EventFeed,superClass);EventFeed.prototype.loading_element=".event_loader";EventFeed.prototype.get_next_page=function(){var params;this.el.addClass("loading");params={from_event:this.data.next_page,format:"json"};if(this.data.fetch_alt){params.fetch_alt=this.data.fetch_alt}return $.get("",params,function(_this){return function(res){var new_content;_this.el.removeClass("loading");if(!res.next_page){_this.remove_loader()}_this.data.next_page=res.next_page;if(res.num_items>0){new_content=$(res.content).appendTo(_this.feed_column).hide().slideDown();return _this.event_list.grid.add_image_loading(new_content)}}}(this))};function EventFeed(el,data){this.data=data;this.setup_follow_button_listener=bind(this.setup_follow_button_listener,this);this.setup_games_to_rate=bind(this.setup_games_to_rate,this);this.get_next_page=bind(this.get_next_page,this);EventFeed.__super__.constructor.apply(this,arguments);this.feed_column=this.el.find(".feed_column");this.event_list=new I.EventList(this.el);this.setup_games_to_rate();this.setup_follow_button_listener();this.el.dispatch("click",{rate_game_btn:function(_this){return function(btn){btn.trigger("i:track_link");return I.Lightbox.open_remote(btn.data("lightbox_url"),I.RateGameLightbox)}}(this),dismiss_btn:function(_this){return function(btn){var obj,parent,remaining,url;obj=btn.closest(".dismiss_object");obj.find("[data-tooltip]").trigger("i:hide_tooltip");parent=obj.closest(".dismissable_container");remaining=parent.find(".dismiss_object").length;if(remaining===1){parent.fadeOut(function(){return parent.remove()})}else{obj.fadeOut(function(){return obj.remove()})}url=btn.data("dismiss_url");btn.trigger("i:track_link",["dismiss_object"]);return $.post(url,I.with_csrf())}}(this)})}EventFeed.prototype.setup_games_to_rate=function(){var rate_outer;rate_outer=this.el.find(".games_to_rate");if(!rate_outer.length){return}return $(document).on("i:rating_updated",function(_this){return function(e,res){var rater;rater=rate_outer.find("[data-game_id="+res.game_id+"]");return rater.toggleClass("rated",!res.removed)}}(this))};EventFeed.prototype.setup_follow_button_listener=function(){var stat_box;stat_box=this.el.find(".following_stat_box");if(!stat_box.length){return}return $(document).on("i:follow_updated",function(_this){return function(e,res){var delta,val_box;delta=res.following?1:-1;val_box=stat_box.find(".stat_value");return val_box.text(+val_box.text()+delta)}}(this))};return EventFeed}(I.InfiniteScroll);I.EventPage=function(superClass){extend(EventPage,superClass);function EventPage(el){var grid;this.el=$(el);new I.EventList(this.el.find(".event_list"),{track_category:"view_event"});grid=new I.GameGrid(this.el.find(".related_games .game_grid_widget"),{expected_size:250,selector:".related_games .game_grid_widget .game_cell .game_thumb",width_selector:".related_games .game_grid_widget .game_cell"});grid.setup_conversion_tracking("12")}return EventPage}(I.EventList)}).call(this);(function(){I.FollowersBase=function(){function FollowersBase(el){this.el=$(el);I.has_follow_button(this.el)}return FollowersBase}()}).call(this);(function(){I.GameCollections=function(){function GameCollections(el){var form;this.el=$(el);I.redactor(this.el.find("textarea"),{toolbarOverflow:true,minHeight:100});this.el.find("input[type='radio']:first").prop("checked",true);this.el.on("click change",".collection_option",function(_this){return function(e){var row;row=$(e.currentTarget);return row.find("input[type='radio']").prop("checked",true)}}(this));form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(errors);return}return window.location=res.url}}(this))}return GameCollections}()}).call(this);(function(){I.GameCommunityCategory=function(){function GameCommunityCategory(el){var scroller;this.el=$(el);scroller=this.el.find(".blog_post_grid_widget");scroller.lazy_images({horizontal:true,target:scroller})}return GameCommunityCategory}()}).call(this);(function(){var KeyGroupLightbox,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;KeyGroupLightbox=function(superClass){extend(KeyGroupLightbox,superClass);function KeyGroupLightbox(){this.init=bind(this.init,this);return KeyGroupLightbox.__super__.constructor.apply(this,arguments)}KeyGroupLightbox.prototype.init=function(parent){var form;I.money_input(this.el.find(".unlock_price_input"));I.bind_checkbox_to_input(this.el.find(".toggle_unlock_input"),this.el.find(".unlock_price_input"));return form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return window.location.reload()}}(this))};return KeyGroupLightbox}(I.Lightbox);I.GameKeys=function(){function GameKeys(el,game){this.game=game;this.el=$(el);this.el.dispatch("click",{create_key_group_btn:function(_this){return function(btn){return I.Lightbox.open_tpl("key_group_lightbox",KeyGroupLightbox,_this)}}(this),create_key_btn:function(_this){return function(btn){return _this.create_download_key().done(function(key){var component;component=R.GameEdit.DownloadKeyLightbox(_this.lightbox_props(key,true));return I.Lightbox.open(component)})}}(this),revoke_key_btn:function(_this){return function(btn){var row;if(confirm("Are you sure you want to revoke this key?")){row=btn.closest(".key_row");row.removeClass("new").addClass("revoked");return _this.revoke_download_key(row.data("key"))}}}(this),show_key_btn:function(_this){return function(btn){var component,key;if(btn.closest(".revoked").length){return}key=btn.closest(".key_row").data("key");component=R.GameEdit.DownloadKeyLightbox(_this.lightbox_props(key));return I.Lightbox.open(component)}}(this)})}GameKeys.prototype.lightbox_props=function(key,is_new){return{new_key:is_new,download_key:key,game:{noun:"game"}}};GameKeys.prototype._download_key=function(action,data){if(data==null){data={}}data.action=action;return $.ajax({url:"/game/keys/"+this.game.id,type:"post",data:I.with_csrf(data)}).then(function(_this){return function(res){if(res.errors){alert(res.errors.join(","));return $.Deferred()}else{return res}}}(this))};GameKeys.prototype.create_download_key=function(){I.Lightbox.open_loading();return this._download_key("create")};GameKeys.prototype.revoke_download_key=function(key,fn){return this._download_key("revoke",{download_key_id:key.id})};return GameKeys}()}).call(this);(function(){var PromoUpload,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};PromoUpload=function(superClass){extend(PromoUpload,superClass);function PromoUpload(){return PromoUpload.__super__.constructor.apply(this,arguments)}PromoUpload.prototype.success_params={type:"promo_wide_cover",thumb_size:"promo_preview"};return PromoUpload}(I.ImageUpload);I.GamePromoImages=function(){function GamePromoImages(el,opts){this.opts=opts;this.setup_uploaders=bind(this.setup_uploaders,this);this.upload_prefix=bind(this.upload_prefix,this);this.el=$(el);this.setup_uploaders()}GamePromoImages.prototype.upload_prefix=function(){return"/g/"+this.opts.user_slug+"/"+this.opts.game_slug};GamePromoImages.prototype.setup_uploaders=function(){var i,len,ref,results,row;ref=this.el.find(".image_uploader_row");results=[];for(i=0,len=ref.length;i<len;i++){row=ref[i];results.push(function(_this){return function(row){var Uploader,btn,input,preview;btn=row.find(".upload_image_btn");input=row.find(".image_id_input");preview=row.find(".image_preview");Uploader=function(superClass){extend(Uploader,superClass);function Uploader(){return Uploader.__super__.constructor.apply(this,arguments)}Uploader.prototype.success_params={type:row.data("name"),thumb_size:row.data("thumb_size")};return Uploader}(I.ImageUpload);I.make_popup_upload_button(_this,btn,Uploader,{start_uploading:function(){return btn.prop("disabled",true).addClass("disabled")},finish_upload:function(upload,file){btn.prop("disabled",false).removeClass("disabled");input.val(file.id);preview.attr("src",file.url);return row.addClass("has_image")}});return row.dispatch("click",{remove_image_btn:function(btn){row.removeClass("has_image");return input.val("-1")}})}}(this)($(row)))}return results};return GamePromoImages}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.GameReleaseInfo=function(){function GameReleaseInfo(el,opts){this.opts=opts;this.setup_date_pickers=bind(this.setup_date_pickers,this);I.event2("game release info");this.el=$(el);I.setup_selectize(this.el);this.setup_date_pickers();this.setup_licenses();this.form=this.el.find("form").remote_submit(function(_this){return function(res,form){if(res.errors){form.set_form_errors(res.errors);return}form.set_form_errors([]);return I.flash("Changes saved")}}(this));I.setup_dirty_warning(this.form)}GameReleaseInfo.prototype.setup_licenses=function(){return["code","assets"].forEach(function(_this){return function(type){var on_change,picker;picker=_this.el.find("."+type+"_license_picker");on_change=function(e){var license;license=picker.val();_this.el.find("."+type+"_license").removeClass("shown");return _this.el.find("."+type+"_license.license_"+license).addClass("shown")};picker.on("change",on_change);return on_change()}}(this))};GameReleaseInfo.prototype.setup_date_pickers=function(){this.el.find(".timezone_input").val(jstz.determine().name());return I.datetimepicker(this.el.find(".date_picker"))};return GameReleaseInfo}()}).call(this);(function(){I.PurchaseList=function(){function PurchaseList(el){this.el=$(el);this.el.on("click",".email_cell",function(e){return $(e.currentTarget).closest(".purchase_list_table").addClass("show_emails")})}return PurchaseList}();I.GameSummary=function(){function GameSummary(el){this.el=$(el);this.setup_purchases()}GameSummary.prototype.setup_purchases=function(){new I.PurchaseList(this.el);return this.el.find(".purchases_table.remote_table").remote_table()};return GameSummary}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.GameInteract=function(){function GameInteract(el,opts){this.opts=opts;I.event2(this.opts.page_name);this.el=$(el);I.setup_selectize(this.el);this.el.find(".sort_by_picker").on("change",function(e){return window.location="?sort_by="+$(e.target).val()})}return GameInteract}();I.DashboardGameRatings=function(superClass){extend(DashboardGameRatings,superClass);function DashboardGameRatings(){DashboardGameRatings.__super__.constructor.apply(this,arguments);this.el.on("change",".rating_toggle_input",function(_this){return function(e){var data,target,top;target=$(e.currentTarget);top=target.closest(".toggle_ratings");if(top.is(".loading")){return false}top.addClass("loading");data=I.with_csrf(target.closest("form").serializeArray());target.prop("disabled",true);return $.ajax({url:"",type:"POST",data:I.with_csrf(data),success:function(res){return window.location.reload()}})}}(this))}return DashboardGameRatings}(I.GameInteract)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.IoGame=function(){function IoGame(el,opts){var img;this.el=$(el);this.upgrade_sidebar(opts);if(opts.hit_url){img=new Image;img.src=opts.hit_url}}IoGame.prototype.upgrade_sidebar=function(opts){return $.ajax({type:"POST",url:opts.upgrade_url,xhrFields:{withCredentials:true},success:function(_this){return function(res){if(!res.upgrade){return}if(res.header){$("body > .header_widget").replaceWith(res.header)}return _this.el.find(".game_sidebar").html(opts.sidebar)}}(this)})};return IoGame}();I.IoGameSidebar=function(){function IoGameSidebar(el){this.setup_comments=bind(this.setup_comments,this);this.el=$(el);I.has_follow_button(this.el);this.setup_comments();this.el.dispatch("click",{rate_game_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("url"),I.RateGameLightbox)}}(this)})}IoGameSidebar.prototype.setup_comments=function(){return this.el.on("focus",".click_input",function(_this){return function(e){var el;el=$(e.target).closest("[data-form_html]");return el.replaceWith(el.data("form_html"))}}(this))};return IoGameSidebar}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.UserLogin=function(){function UserLogin(el){this.el=$(el);I.tracked_links(this.el,"login");if(this.el.find(".g-recaptcha").length){I.event("recaptcha","show","login")}}return UserLogin}();I.ForgotPassword=function(){function ForgotPassword(el){I.tracked_links(this.el,"register");this.el=$(el);if(this.el.find(".g-recaptcha").length){I.event("recaptcha","show","forgot_password")}}return ForgotPassword}();I.PurchaseStatus=function(){function PurchaseStatus(el){var checking;this.el=$(el);checking=false;this.timer=setInterval(function(_this){return function(){if(checking){return}checking=true;return $.post("",function(res){checking=false;switch(res.status){case"failed":clearTimeout(_this.timer);return _this.el.addClass("failed");case"complete":clearTimeout(_this.timer);return window.location=res.download_url}})}}(this),1e3)}return PurchaseStatus}();I.ExportPurchases=function(){ExportPurchases.prototype.date_format="yy-mm-dd";ExportPurchases.prototype.time_format="HH:mm:ss";function ExportPurchases(el){this.setup_range_form=bind(this.setup_range_form,this);this.el=$(el);this.setup_range_form();new I.PurchaseList(this.el)}ExportPurchases.prototype.setup_range_form=function(){var end_picker,form,outer,start_picker,update_picker;outer=this.el.find(".range_form_outer");form=outer.find(".range_form");if(!form.length){return}form.find(".timezone_input").val(jstz.determine().name());start_picker=this.el.find(".date_picker.start_date");end_picker=this.el.find(".date_picker.end_date");update_picker=function(input,set_min){var real_date;if(set_min==null){set_min=true}if(set_min&&input.is(".start_date")){real_date=input.datetimepicker("getDate");return end_picker.datetimepicker("option","minDate",new Date(+real_date))}};form.find(".date_picker").datetimepicker({timeFormat:this.time_format,dateFormat:this.date_format,onSelect:function(val){return update_picker($(this))},beforeShow:function(_this){return function(){_.defer(function(){return $("#ui-datepicker-div").css("z-index",2)});return void 0}}(this)});outer.removeClass("has_purchases");return form.remote_submit(function(_this){return function(res){if(res.errors){alert(res.errors.join(", "));return}outer.toggleClass("is_plural",res.count!==1).toggleClass("no_results",res.count===0).find(".purchase_count").text(res.count);return outer.addClass("has_purchases").find(".purchases").html(res.content)}}(this))};return ExportPurchases}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.CollectionGameLightbox=function(superClass){extend(CollectionGameLightbox,superClass);function CollectionGameLightbox(){return CollectionGameLightbox.__super__.constructor.apply(this,arguments)}CollectionGameLightbox.prototype.init=function(game_cell){this.el.find("form").remote_submit(function(_this){return function(res){var blurb,drop;if(res.errors){alert(res.errors.join(", "));return}blurb=res.blurb;game_cell.toggleClass("has_blurb",!!blurb);if(blurb){drop=game_cell.find(".blurb_drop");if(!drop.length){drop=$('<div class="blurb_drop"></div>').appendTo(game_cell)}drop.html(blurb)}return I.Lightbox.close()}}(this));return I.redactor(this.el.find("textarea"),{minHeight:100,source:false,buttons:["bold","italic","deleted","lists","link"]})};return CollectionGameLightbox}(I.Lightbox);I.MyCollections=function(){function MyCollections(el){this.setup_load_more=bind(this.setup_load_more,this);this.swap_cells=bind(this.swap_cells,this);this.remove_cell=bind(this.remove_cell,this);var i,len,ref,toggle_state;I.event2("view my-collections");this.el=$(el);if(!I.is_mobile()){this.el.find(".antiscroll-wrap").antiscroll({x:true,y:false})}this.setup_load_more();this.el.on("change",".toggle_input",function(_this){return function(e){var data,i,inputs,len,name,toggle,toggle_name,url;toggle=$(e.currentTarget);url=toggle.data("url");data={};inputs=toggle.find("input[name]");for(i=0,len=inputs.length;i<len;i++){el=inputs[i];el=$(el);name=el.attr("name");toggle_name=name.replace(/\[([^[]+)\]$/,"[$1_changed]");data[toggle_name]="1";if(el.prop("checked")){data[name]="on"}}inputs.prop("disabled",true);return $.post(url,I.with_csrf(data),function(res){if(res.errors){alert(res.errors.join(","));return}return inputs.prop("disabled",false)})}}(this));toggle_state=function(checkbox){var collection,priv;priv=checkbox.prop("checked");collection=checkbox.closest(".game_collection");return collection.find(".show_on_profile_input").prop("disabled",priv).closest(".toggle_input").toggleClass("disabled",priv)};this.el.on("change",".privacy_input",function(_this){return function(e){return toggle_state($(e.currentTarget))}}(this));ref=this.el.find(".privacy_input");for(i=0,len=ref.length;i<len;i++){el=ref[i];toggle_state($(el))}this.el.dispatch("click",{edit_blurb_btn:function(_this){return function(btn){var cell;I.event("my_collections","collection","edit_blurb");cell=btn.closest(".game_cell");return I.Lightbox.open_remote(btn.data("lightbox_url"),I.CollectionGameLightbox,cell)}}(this),remove_btn:function(_this){return function(btn){var cell,grid;I.event("my_collections","collection","remove_game");cell=btn.closest(".game_cell");grid=cell.closest(".game_grid_widget");if(confirm("Remove this game from the collection?")){$.post(btn.data("href"),I.with_csrf());return _this.remove_cell(cell,function(){if(grid.is(":empty")){return grid.closest(".game_collection").addClass("no_games").end().remove()}})}}}(this),move_left_btn:function(_this){return function(btn){var cell,swap_cell;I.event("my_collections","collection","move_left");cell=btn.closest(".game_cell");swap_cell=cell.prev();_this.swap_cells(cell,swap_cell);return $.post(btn.data("href"),I.with_csrf())}}(this),move_right_btn:function(_this){return function(btn){var cell,swap_cell;I.event("my_collections","collection","move_right");cell=btn.closest(".game_cell");swap_cell=cell.next();_this.swap_cells(cell,swap_cell);return $.post(btn.data("href"),I.with_csrf())}}(this),edit_title_btn:function(_this){return function(btn){var collection,finished,input,old_val,save_changes,title_el,title_text_el;I.event("my_collections","collection","edit_title");collection=btn.closest(".game_collection");if(collection.is(".editing_title")){collection.data("finished_editing")();return}collection.addClass("editing_title");title_el=collection.find(".collection_title");title_text_el=title_el.find(".collection_title_wrap");old_val=title_text_el.text();input=$('<input type="text" class="live_edit_input" />').val(old_val).insertAfter(title_el.hide()).select();save_changes=function(confirm){var data;if(confirm==null){confirm=false}if(input.val()===old_val){return finished()}if(confirm){if(!window.confirm("Save changes to title?")){return finished()}}data=I.with_csrf({"collection[title]":input.val()});return $.post(btn.data("href"),data,function(_this){return function(res){if(res.title){title_text_el.text(res.title)}if(res.errors){alert(res.errors.join(", "))}return finished()}}(this))};finished=function(){input.remove();title_el.show();$(document).off("click.editing_title");return collection.removeClass("editing_title")};collection.data("finished_editing",finished);$(document).on("click.editing_title",function(e){if(!$(e.target).closest(".live_edit_input").length){return save_changes(true)}});return input.on("keydown",function(e){switch(e.keyCode){case 13:return save_changes();case 27:return finished()}})}}(this),delete_btn:function(_this){return function(btn){var collection;I.event("my_collections","collection","delete_collection");collection=btn.closest(".game_collection");if(confirm("Are you sure you want to delete this collection?")){return $.post(btn.data("href"),I.with_csrf(),function(res){if(res.errors){if(res.errors){return alert(res.errors.join(", "))}}return collection.slideUp()})}}}(this)})}MyCollections.prototype.remove_cell=function(cell,removed){var height,spacer,width;spacer=$("<span></span>");width=cell.outerWidth(true);height=cell.height();cell.after(spacer).detach().css({width:width+"px",height:height+"px",marginLeft:"0",marginRight:"0",overflow:"hidden"});spacer.replaceWith(cell);return _.defer(function(_this){return function(){cell.css("width",0).addClass("invisible");return setTimeout(function(){cell.remove();return typeof removed==="function"?removed():void 0},400)}}(this))};MyCollections.prototype.swap_cells=function(a,b){var a_offset,a_placeholder,b_offset,b_placeholder;if(!(a.length&&b.length)){return}a_offset=a.offset();b_offset=b.offset();a_placeholder=$("<span></span>").insertAfter(a);b_placeholder=$("<span></span>").insertAfter(b);a.remove().css({position:"relative",top:a_offset.top-b_offset.top+"px",left:a_offset.left-b_offset.left+"px"});b.remove().css({position:"relative",top:b_offset.top-a_offset.top+"px",left:b_offset.left-a_offset.left+"px"});a_placeholder.replaceWith(b);b_placeholder.replaceWith(a);return _.defer(function(_this){return function(){a.css({top:"",left:""});return b.css({top:"",left:""})}}(this))};MyCollections.prototype.setup_load_more=function(){var i,len,load_more,ref,results;ref=this.el.find(".load_more_cell");results=[];for(i=0,len=ref.length;i<len;i++){load_more=ref[i];results.push(function(load_more){var list_url,page,scroller;page=1;list_url=load_more.closest("[data-list_url]").data("list_url");return scroller=load_more.closest(".antiscroll-inner").on("scroll.load_more",_.debounce(function(_this){return function(){var offset;if(load_more.is(".loading")){return}if(load_more.position().left<scroller.outerWidth()){load_more.addClass("loading");offset=load_more.parent().find(".game_cell").length;I.event("my_collections","collection","load_more");return $.get(list_url,{page:++page},function(res){console.log(res);$(res.games).insertBefore(load_more);if(res.has_more){return load_more.removeClass("loading")}else{return load_more.remove()}})}}}(this),10))}($(load_more)))}return results};return MyCollections}();I.MyRatedGames=function(superClass){extend(MyRatedGames,superClass);function MyRatedGames(el){var grid;MyRatedGames.__super__.constructor.call(this,el);grid=this.el.find(".browse_game_grid");this.grid=new I.GameGrid(grid,{selector:".browse_game_grid .game_cell .game_thumb",width_selector:".browse_game_grid .game_cell"});I.format_dates(this.el)}return MyRatedGames}(I.InfiniteGameGrid)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.MyPurchases=function(superClass){extend(MyPurchases,superClass);MyPurchases.prototype.method="get";function MyPurchases(el){var grid;MyPurchases.__super__.constructor.apply(this,arguments);grid=this.el.find(".game_grid_widget");this.grid=new I.GameGrid(grid);I.format_dates(this.el)}return MyPurchases}(I.InfiniteGameGrid);I.MyDonations=function(superClass){extend(MyDonations,superClass);function MyDonations(){return MyDonations.__super__.constructor.apply(this,arguments)}return MyDonations}(I.MyPurchases)}).call(this);(function(){I.NewBundle=function(){function NewBundle(sel,opts){if(opts==null){opts={}}ReactDOM.render(R.NewBundle(opts),document.querySelector(sel+" form"))}return NewBundle}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.BankAccountLightbox=function(superClass){extend(BankAccountLightbox,superClass);function BankAccountLightbox(){return BankAccountLightbox.__super__.constructor.apply(this,arguments)}BankAccountLightbox.prototype.init=function(){var form,type_picker,update_type;form=this.el.find("form");type_picker=this.el.find(".type_picker");update_type=function(_this){return function(){var i,len,ref,results,selected,t;ref=["individual","business"];results=[];for(i=0,len=ref.length;i<len;i++){t=ref[i];selected=type_picker.val()===t;_this.el.toggleClass("is_"+t,selected);results.push(_this.el.find(".for_"+t+" input").prop("disabled",!selected))}return results}}(this);update_type();type_picker.on("change",update_type);return form.remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return window.location.reload()}}(this),function(_this){return function(){var account_number,errors,routing_number;account_number=form.find(".account_number_input").val();routing_number=form.find(".routing_number_input").val();errors=[];if(!Stripe.bankAccount.validateRoutingNumber(routing_number,"US")){errors.push("Invalid routing number")}if(!Stripe.bankAccount.validateAccountNumber(account_number,"US")){errors.push("Invalid account number")}if(errors.length){form.set_form_errors(errors);return false}return true}}(this))};return BankAccountLightbox}(I.Lightbox);I.Payouts=function(){function Payouts(el,opts){this.opts=opts;this.el=$(el);this.el.find(".initiate_payout_form").remote_submit(function(_this){return function(res){if(res.success){return window.location.reload()}}}(this));this.el.has_tooltips();this.el.dispatch("click",{bank_btn:function(_this){return function(btn){return I.Lightbox.open_tpl("bank_account_lightbox",I.BankAccountLightbox)}}(this)})}return Payouts}()}).call(this);(function(){var BuyBundleLightbox,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};BuyBundleLightbox=function(superClass){extend(BuyBundleLightbox,superClass);function BuyBundleLightbox(){return BuyBundleLightbox.__super__.constructor.apply(this,arguments)}BuyBundleLightbox.prototype.init=function(bundle,opts){this.bundle=bundle;this.buy=new I.BundleBuyForm(this.el,this.bundle,{});return this.buy.submit_handler=this.buy.remote_submit};return BuyBundleLightbox}(I.Lightbox);I.PromotionPage=function(){PromotionPage.prototype.track_category=function(){throw"override me"};PromotionPage.prototype.page_name=function(){throw"override me"};function PromotionPage(el,promotion){var base,c,grid_el,i,len,ref1;this.promotion=promotion;this.page_name=bind(this.page_name,this);this.track_category=bind(this.track_category,this);this.el=$(el);(base=this.promotion).small_grid||(base.small_grid=I.is_mobile());this.el.toggleClass("small_grid",!!this.promotion.small_grid);I.format_dates(this.el);this.el.has_tooltips();ref1=this.el.find(".game_grid_widget");for(i=0,len=ref1.length;i<len;i++){grid_el=ref1[i];new I.GameGrid($(grid_el),{cell_margin:this.promotion.small_grid||I.is_mobile()?20:40,available_width:I.GameGridSizer.sizers.el_rect,expected_size:this.promotion.small_grid&&!I.is_mobile()?250:315,selector:".promo_game_grid .game_cell .game_thumb",width_selector:".promo_game_grid .game_cell"})}this.carousels=function(){var j,len1,ref2,results;ref2=this.el.find(".game_carousel_widget");results=[];for(j=0,len1=ref2.length;j<len1;j++){c=ref2[j];results.push(new I.GameCarousel($(c)))}return results}.call(this);this.el.dispatch("click",{buy_game_btn:function(_this){return function(btn){var game;I.event(_this.track_category(),"buy");if(I.is_mobile()){window.location=I.add_params(btn.data("href"),{initiator:"mobile"});return"continue"}game=btn.data("game");return I.Lightbox.open_remote(btn.data("href"),I.BuyGameLightbox,game,{is_donate:false,event_category:"view_sale",pay_in_popup:false})}}(this),buy_bundle_btn:function(_this){return function(btn){var html;I.event(_this.track_category(),"buy");html=$("#buy_lightbox_tpl").html();return I.Lightbox.open(html,BuyBundleLightbox,_this.promotion,{})}}(this)});this.setup_sticking();this.setup_countdown();this.setup_referrer()}PromotionPage.prototype.setup_referrer=function(){var host,ref;if(I.ReferrerTracker.has_ref(this.page_name(),this.promotion.id)){return}host=$(document.body).data("host");ref=document.referrer;if(!ref){return}if(ref.indexOf(host)>=0){return}return I.ReferrerTracker.push(this.page_name(),this.promotion.id,this.page_name()+":"+ref)};PromotionPage.prototype.setup_sticking=function(){var body,check_can_stick,opts,stickable,sticking,win;win=$(window);opts={parent:".columns_wrapper"};stickable=this.el.find(".stick_wrapper");sticking=false;check_can_stick=function(){var should_be_sticking;should_be_sticking=win.width()>900;if(should_be_sticking&&!sticking){stickable.stick_in_parent(opts)}if(!should_be_sticking&&sticking){stickable.trigger("sticky_kit:detach")}return sticking=should_be_sticking};check_can_stick();win.on("resize",function(_this){return function(){check_can_stick()}}(this));body=$(document.body);return this.el.find(".columns_wrapper").on("i:grid_resize",function(_this){return function(){return body.trigger("sticky_kit:recalc")}}(this))};PromotionPage.prototype.setup_countdown=function(){var el,end,i,len,now,ref1,start;ref1=this.el.find(".countdown");for(i=0,len=ref1.length;i<len;i++){el=ref1[i];el=$(el);now=new Date;start=moment.utc(this.promotion.start_date).toDate();end=moment.utc(this.promotion.end_date).toDate();if(now<start||now>end){return}el.html(el.data("countdown"));new I.Countdown(el,moment(end),{max_blocks:3})}};return PromotionPage}();I.SalePage=function(superClass){extend(SalePage,superClass);function SalePage(){this.page_name=bind(this.page_name,this);this.track_category=bind(this.track_category,this);return SalePage.__super__.constructor.apply(this,arguments)}SalePage.prototype.track_category=function(){return"view_sale"};SalePage.prototype.page_name=function(){return"sale"};return SalePage}(I.PromotionPage);I.BundlePage=function(superClass){extend(BundlePage,superClass);BundlePage.prototype.track_category=function(){return"view_bundle"};BundlePage.prototype.page_name=function(){return"bundle"};function BundlePage(){this.page_name=bind(this.page_name,this);this.track_category=bind(this.track_category,this);BundlePage.__super__.constructor.apply(this,arguments);this.el.dispatch("click",{participants_btn:function(_this){return function(btn){return I.Lightbox.open_tpl("participant_lightbox")}}(this)})}return BundlePage}(I.PromotionPage)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.RegisterForm=function(){function RegisterForm(el,opts){I.event2("register form");if(opts.ref_action){I.set_register_referrer("email")}this.el=$(el);this.el.has_tooltips();this.setup_username_input();this.setup_slug_preview();this.setup_availability_check();if(this.username_input.val().trim().length){this.el.trigger("i:update_username")}if(this.el.find(".g-recaptcha").length){I.event("recaptcha","show","register")}new I.FilterPickers(this.el)}RegisterForm.prototype.setup_username_input=function(){this.username_input=this.el.find("input[name=username]");return this.username_input.on("keyup change",_.debounce(function(_this){return function(){return _this.el.trigger("i:update_username")}}(this),250))};RegisterForm.prototype.setup_slug_preview=function(){var slug;slug=this.el.find(".slug_preview");return this.el.on("i:update_username",function(_this){return function(){var name;name=_this.username_input.val().trim();if(name.length){return slug.val("http://"+I.slugify(name)+".itch.io/")}else{return slug.val(null)}}}(this))};RegisterForm.prototype.get_submit_button=function(){return this.el.find("input[type=submit]")};RegisterForm.prototype.setup_availability_check=function(){var row,submit;row=this.username_input.closest(".validated");submit=this.get_submit_button();return this.el.on("i:update_username",function(_this){return function(){if(_.isEmpty(_this.username_input.val())){row.removeClass("valid invalid");return}return $.ajax({url:"/user/check-availability",type:"POST",data:I.with_csrf({username:_this.username_input.val()}),success:function(res){var has_error,ref;row.removeClass("valid invalid");row.find(".input_error_message").text(((ref=res.errors)!=null?ref[0]:void 0)||"");has_error=!!res.errors;row.toggleClass("invalid",has_error).toggleClass("valid",!has_error);submit.toggleClass("disabled",has_error);submit.prop("disabled",has_error);return _this.el.trigger("i:got_availability")}})}}(this))};return RegisterForm}();I.ChangeUsernameForm=function(superClass){extend(ChangeUsernameForm,superClass);function ChangeUsernameForm(el,opts){ChangeUsernameForm.__super__.constructor.apply(this,arguments);this.setup_url_preview();this.el.on("i:got_availability",function(_this){return function(){return _this.el.find(".consequences").toggleClass("hidden",_this.get_submit_button().hasClass("disabled"))}}(this))}ChangeUsernameForm.prototype.setup_url_preview=function(){var url;url=this.el.find(".new_username");return this.el.on("i:update_username",function(_this){return function(){var name;name=_this.username_input.val().trim();if(name.length){return url.text(I.slugify(name))}else{return url.text("")}}}(this))};ChangeUsernameForm.prototype.get_submit_button=function(){return this.el.find("button.submit")};return ChangeUsernameForm}(I.RegisterForm)}).call(this);(function(){I.SaleAnalytics=function(){function SaleAnalytics(el,opts){var i,len,ref,tbl;this.el=$(el);ref=this.el.find(".remote_table");for(i=0,len=ref.length;i<len;i++){tbl=ref[i];$(tbl).remote_table()}I.format_dates(this.el);if(opts.cumulative_earnings){new I.CumulativeGraph("#cumulative_earnings_graph",opts.cumulative_earnings,{currency:opts.currency})}}return SaleAnalytics}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.SellerSettings=function(){function SellerSettings(el,opts){this.opts=opts;this.render_cut_picker=bind(this.render_cut_picker,this);this.el=$(el);this.setup_payout_picker();this.render_cut_picker()}SellerSettings.prototype.render_cut_picker=function(){var el;el=this.el.find(".cut_row_drop");return ReactDOM.render(R.UserSettings.SellerCutPicker({cut:this.opts.cut,default_cut:this.opts.default_cut,affiliate_cuts:_.toArray(this.opts.affiliate_props)}),el[0])};SellerSettings.prototype.setup_payout_picker=function(){var payout_modes,show_mode_settings;show_mode_settings=function(_this){return function(mode){return _this.el.find("[data-payout_mode]").removeClass("visible").filter("[data-payout_mode='"+mode+"']").addClass("visible")}}(this);payout_modes=this.el.find(".payout_mode");payout_modes.on("change","input",function(_this){return function(e){var input;payout_modes.removeClass("selected");input=$(e.target).closest(".payout_mode").addClass("selected").end();return show_mode_settings(input.val())}}(this));this.el.on("click",".payout_mode",function(_this){return function(e){var toggle;if($(e.target).closest("input").length){return}toggle=$(e.currentTarget).find("input");return toggle.prop("checked",true).trigger("change")}}(this));return show_mode_settings(this.el.find("input[name='data[payout_mode]']:checked").val())};return SellerSettings}()}).call(this);(function(){I.UserTfaApp=function(){function UserTfaApp(el,data){I.event2("tfa app");this.el=$(el);$(".qrcode").qrcode(data.url);this.el.dispatch("click",{show_secret_btn:function(_this){return function(){return _this.el.addClass("secret_shown")}}(this)});this.form=this.el.find("form").remote_submit(function(_this){return function(res){_this.form.set_form_errors(res.errors);if(res.success){return window.location=res.url}}}(this))}return UserTfaApp}();I.UserTfaScratchcodes=function(){function UserTfaScratchcodes(el){I.event2("tfa codes");this.el=$(el);this.el.dispatch("click",{print_btn:function(_this){return function(){return window.print()}}(this)})}return UserTfaScratchcodes}()}).call(this);(function(){var send_message;send_message=function(msg){return top.$(window.top.document).trigger("i:upload_popup_msg",[msg])};I.ManualUpload=function(){ManualUpload.prototype.image_types=/\.jpg$|\.gif$|\.png$/i;function ManualUpload(el,opts){var max_label;this.opts=opts;this.el=$(el);max_label=this.el.find(".max_size_value");if(max_label.length){max_label.text(_.str.formatBytes(+max_label.text()))}this.el.find("input[type=file]").on("change",function(_this){return function(e){var file;file=e.target.files[0];_this.filename=file.name;_this.size=file.size;_this.mime=file.type;_this.el.toggleClass("show_size_error",!!(_this.size&&_this.size>_this.opts.max_size));if(_this.opts.kind==="image"){return _this.el.toggleClass("show_type_error",!_this.filename.match(_this.image_types))}}}(this));this.el.find("form").on("submit",function(_this){return function(e){var form;if(_this.el.is(".show_size_error, .show_type_error")){e.preventDefault();return}form=$(e.target);if(form.is(".ready")){return}if(!_this.filename){return false}if(_this.mime){I.event("upload_popup","start_"+_this.opts.kind,_this.mime)}I.prepare_upload(_this.opts.prefix,{kind:_this.opts.kind,type:_this.opts.type,thumb_size:_this.opts.thumb_size,filename:_this.filename,redirect:true},function(res){var key,ref,val;if(!$.isPlainObject(res)){I.event("upload_popup","error","failed to prepare upload");alert("Server failed to prepare upload");return false}_this.el.addClass("uploading");send_message({type:"start_upload",name:_this.filename,size:_this.size,data:res},"*");form.find("input[type=hidden]").remove();form.attr("action",res.action);ref=res.post_params;for(key in ref){val=ref[key];$('<input type="hidden" />').attr("name",key).attr("value",val).prependTo(form)}form.addClass("ready");return form.submit()},function(res){I.event("upload_popup","error",res);return alert(res)});return false}}(this))}return ManualUpload}();I.SaveUpload=function(){function SaveUpload(data){this.data=data;I.event("upload_popup","save","save");setTimeout(function(_this){return function(){return send_message({type:"save_upload",data:_this.data})}}(this),100)}return SaveUpload}()}).call(this);(function(){I.UserOauthOob=function(){function UserOauthOob(el){this.el=$(el);this.el.dispatch("click",{api_key_input:function(_this){return function(input){return input.select()}}(this)})}return UserOauthOob}()}).call(this);(function(){var AvatarUpload,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};AvatarUpload=function(superClass){extend(AvatarUpload,superClass);function AvatarUpload(){return AvatarUpload.__super__.constructor.apply(this,arguments)}AvatarUpload.prototype.success_params={type:"cover",thumb_size:"avatar_preview"};return AvatarUpload}(I.ImageUpload);I.UserSettingsEmailNotifications=function(){function UserSettingsEmailNotifications(el){var global_disable,other_inputs,update;this.el=$(el);global_disable=this.el.find(".notification_toggle[name='email_settings[disable_all]']");other_inputs=this.el.find(".notification_toggle").not(global_disable);update=function(){return other_inputs.prop("disabled",global_disable.prop("checked"))};global_disable.on("change",update);update()}return UserSettingsEmailNotifications}();I.UserSettingsEmailAddresses=function(){function UserSettingsEmailAddresses(el){this.el=$(el);this.setup_email_verify();this.el.dispatch("click",{resend_verify_email_btn:function(_this){return function(btn){var email;email=btn.closest("[data-email]").data("email");btn.closest("tr").addClass("sent_verify");return $.post(btn.data("href"),I.with_csrf({email:email}),function(res){if(res.errors){alert(res.errors.join(", "))}})}}(this),delete_email_btn:function(_this){return function(btn){var email;email=btn.closest("[data-email]").data("email");if(!confirm("Are you sure you want to delete "+email)){return}btn.closest("tr").remove();return $.post(btn.data("href"),I.with_csrf({action:"delete",email:email}),function(res){if(res.errors){alert(res.errors.join(", "))}})}}(this)})}UserSettingsEmailAddresses.prototype.setup_email_verify=function(){var verify_warning;verify_warning=this.el.find(".verify_warning_box");if(!verify_warning.length){return}return verify_warning.dispatch("click",{verify_email_btn:function(_this){return function(btn){verify_warning.addClass("loading");btn.addClass("disabled").prop("disabled",true);return $.post(btn.data("url"),I.with_csrf(),function(res){verify_warning.removeClass("loading");btn.removeClass("disabled").prop("disabled",false);if(res.errors){alert(res.errors.join(","));return}return verify_warning.addClass("is_complete")})}}(this)})};return UserSettingsEmailAddresses}();I.UserSettingsProfile=function(){function UserSettingsProfile(el,slug){this.slug=slug;this.upload_prefix=bind(this.upload_prefix,this);this.el=$(el);this.el.has_tooltips();this.setup_redactor();this.setup_upload_button();this.el.dispatch("click",{change_username_btn:function(btn){return I.Lightbox.open_remote(btn.data("lightbox_url"),I.ChangeUsernameLightbox)}})}UserSettingsProfile.prototype.setup_redactor=function(){return I.redactor(this.el.find("textarea"))};UserSettingsProfile.prototype.upload_prefix=function(){return"/g/"+this.slug+"/-/profile"};UserSettingsProfile.prototype.setup_upload_button=function(){var btn,input,preview;btn=this.el.find(".upload_image_btn");if(!btn.length){return}input=this.el.find(".profile_image_id_input");preview=this.el.find(".profile_image_preview");this.upload_btn=I.make_popup_upload_button(this,btn,AvatarUpload,{start_uploading:function(_this){return function(){return btn.prop("disabled",true).addClass("disabled")}}(this),finish_upload:function(_this){return function(upload,file){btn.prop("disabled",false).removeClass("disabled");input.val(file.id);preview.attr("src",file.url);return _this.el.addClass("has_avatar")}}(this)});return this.el.dispatch("click",{remove_image_btn:function(_this){return function(btn){_this.el.removeClass("has_avatar");return input.val("-1")}}(this)})};return UserSettingsProfile}();I.ChangeUsernameLightbox=function(superClass){extend(ChangeUsernameLightbox,superClass);function ChangeUsernameLightbox(){this.close=bind(this.close,this);this.init=bind(this.init,this);return ChangeUsernameLightbox.__super__.constructor.apply(this,arguments)}ChangeUsernameLightbox.prototype.init=function(){var form;return form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return _this.el.addClass("done")}}(this))};ChangeUsernameLightbox.prototype.close=function(){if(this.el.hasClass("done")){window.location.reload()}return ChangeUsernameLightbox.__super__.close.apply(this,arguments)};return ChangeUsernameLightbox}(I.Lightbox);I.UserSettingsOauthAppsNew=function(){function UserSettingsOauthAppsNew(el){var form;this.el=$(el);form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return window.location=res.redirect_to}}(this))}return UserSettingsOauthAppsNew}();I.UserSettingsOauthAppsView=function(){function UserSettingsOauthAppsView(el){this.el=$(el);this.el.dispatch("click",{view_key_btn:function(_this){return function(btn){return btn.closest(".key_cell").toggleClass("show_key")}}(this),revoke_all_tokens_btn:function(_this){return function(btn){if(confirm("Are you sure you want to revoke ALL user tokens for this application? All users of this app will be forced back to the authorization flow before they can use your application again.")){return btn.closest("form").submit()}}}(this),reset_secret_btn:function(_this){return function(btn){if(confirm("Are you sure you want to reset your client secret? You will need to update your application to use the new secret. This will not invalidate any user tokens.")){return btn.closest("form").submit()}}}(this)});this.el.find("form").each(function(_this){return function(i,form){var $form;$form=$(form);return $form.remote_submit(function(res){if(res.errors){$form.set_form_errors(res.errors);return}return window.location.reload()})}}(this))}return UserSettingsOauthAppsView}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.UserSettingsCreditCards=function(superClass){extend(UserSettingsCreditCards,superClass);function UserSettingsCreditCards(el,opts){this.opts=opts;this.el=$(el);this.el.remote_link(function(_this){return function(){return location.reload()}}(this));this.el.dispatch("click",{new_card_btn:function(_this){return function(btn){return I.Lightbox.open_tpl("credit_card_lightbox",I.CreditCardLightbox,{publishable_key:_this.opts.publishable_key})}}(this),edit_card_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("href"),I.EditCreditCardLightbox)}}(this)})}return UserSettingsCreditCards}(I.Lightbox)}).call(this);(function(){var is_different,hasProp={}.hasOwnProperty,slice=[].slice;if(window.R){return}is_different=function(a,b){var key;for(key in a){if(!hasProp.call(a,key))continue;if(a[key]!==b[key]){return true}}for(key in b){if(!hasProp.call(b,key))continue;if(!(key in a)){return true}}return false};window.R=function(name,data,p,prefix){var cl,class_name;if(p==null){p=R}if(prefix==null){prefix=""}data.trigger=function(){var node;node=$(ReactDOM.findDOMNode(this));R.trigger.apply(R,[node].concat(slice.call(arguments)));return void 0};data.dispatch=function(){var node;node=$(ReactDOM.findDOMNode(this));R.dispatch.apply(R,[node].concat(slice.call(arguments)));return void 0};data.container=function(){return $(ReactDOM.findDOMNode(this))};data.extend_props=function(){var more;more=1<=arguments.length?slice.call(arguments,0):[];return $.extend.apply($,[{},this.props].concat(slice.call(more)))};class_name=_.once(function(){return(""+prefix+name).replace(/[A-Z]/g,"_$&").replace(/\./g,"_").replace(/__+/g,"_").replace(/^_+/,"").replace(/_+$/,"").toLowerCase()+"_widget"});data.enclosing_class_name=class_name;data.enclose=function(){var args,component,props;props=arguments[0],args=2<=arguments.length?slice.call(arguments,1):[];component=props.component||"div";delete props.component;return React.createElement.apply(React,[component,$.extend({},props,{className:classNames(class_name(),props.className)})].concat(slice.call(args)))};data.displayName=""+prefix+name;if(data.pure){data.shouldComponentUpdate=function(nextProps,nextState){return is_different(this.props,nextProps)||is_different(this.state,nextState)}}cl=React.createClass(data);p[name]=React.createFactory(cl);return p[name]._class=cl};R.scope_event_name=function(name){return"itch:"+name};R.trigger=function(){var args,name,node;node=arguments[0],name=arguments[1],args=3<=arguments.length?slice.call(arguments,2):[];return node.trigger(R.scope_event_name(name),slice.call(args))};R.dispatch=function(node,prefix,event_table){var event_name,fn,results;if(typeof prefix==="object"){event_table=prefix;prefix=false}results=[];for(event_name in event_table){if(!hasProp.call(event_table,event_name))continue;fn=event_table[event_name];if(prefix){event_name=prefix+":"+event_name}results.push(node.on(R.scope_event_name(event_name),fn))}return results};R.component=function(){return R.apply(null,arguments)};R["package"]=function(_this){return function(prefix){var p;p=R[prefix]||(R[prefix]=function(name,data){data.Package=p;return R.component(name,data,p,prefix+".")});p.component=function(){return p.apply(null,arguments)};return p}}(this)}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,sketchfab_pattern,span,strong,textarea,types,ul,vimeo_pattern,youtube_pattern,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("BlogPosts");types=React.PropTypes;youtube_pattern=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.\-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi;vimeo_pattern=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;sketchfab_pattern=/https?:\/\/(?:www\.)?sketchfab\.com\/models\/([\w]+)($|\/)/;P("AttachmentEditor",{propTypes:{available_attachments:types.array,selected_attachments:types.array,object:types.object},getInitialState:function(){return{visible_type:"files",selected_attachments:this.props.selected_attachments,available_attachments:this.props.available_attachments}},componentDidMount:function(){return this.dispatch({append_video:function(_this){return function(){var exists,is_valid,url;url=$.trim(_this.refs.video_url.value);if(url===""){return}is_valid=_.any([youtube_pattern,vimeo_pattern,sketchfab_pattern],function(p){return url.match(p)});if(!is_valid){_this.setState({video_error:"That URL is not recognized"});return}exists=_.any(_this.state.selected_attachments,function(attach){return attach.type==="video"&&attach.url===url});if(exists){_this.setState({video_error:"That video has already been added"});return}_this.refs.video_url.value="";return _this.setState({video_error:null,selected_attachments:_this.state.selected_attachments.concat([{type:"video",url:url}])})}}(this),pick_images:function(_this){return function(){var format_attachment,seen_attachments;_this.setState({upload_error:false});seen_attachments={};format_attachment=function(res){if(res.errors){_this.setState({upload_error:true});return}if(seen_attachments[res.upload.id]){return}seen_attachments[res.upload.id]=true;return{type:"image",upload:res.upload,id:res.upload.id,image_url:res.upload.thumb_url,medium_image_url:res.upload.thumb_url}};return I.upload_image({url:_this.props.upload_image_url,multiple:true}).progress(function(){var args,attachment,attachments,event,j,len,percents,prog,sent,total;if(!_this.state.uploading){_this.setState({uploading:true})}percents=[];attachments=[];args=typeof arguments[0]==="string"?[arguments]:arguments;for(j=0,len=args.length;j<len;j++){prog=args[j];if(!prog){continue}switch(prog[0]){case"progress":event=prog[0],sent=prog[1],total=prog[2];if(event!=="progress"){continue}percents.push(sent/total);break;case"upload_saved":attachment=format_attachment(prog[1]);if(!attachment){continue}attachments.push(attachment)}}if(percents.length){console.debug("got attachments",percents);_this.setState({image_upload_progress:Math.min.apply(Math,percents)})}if(attachments.length){console.debug("got attachments",attachments);return _this.setState({selected_attachments:_this.state.selected_attachments.concat(attachments)})}}).fail(function(){console.warn("upload failed",slice.call(arguments));return _this.setState({uploading:false,image_upload_progress:null,upload_error:true})}).done(function(){return _this.setState({uploading:false,image_upload_progress:null})})}}(this)})},render:function(){var o;return div({className:"attachment_picker input_row"},div({className:"label"},"Attachments"),(o=this.props.object)?p({className:"attach_summary",children:["You can attach things uploaded to ",a({href:o.url,target:"_blank"},o.title)," to this devlog post.",this.props.add_recently_changed?" We've automatically attached some things updated recently.":void 0]}):void 0,this.render_selected_attachments(),this.render_attachment_picker())},render_image_uploader:function(){return div({className:"image_uploader"},h3({},"Upload a new image for this post"),p({},"Note: this image will not be added to your project's screenshots, it will only be available for this post. If you'd like to add new screenshots add them to your project first, then you can pick them here."),button({type:"button",className:classNames("button",{disabled:!!this.state.uploading}),disabled:!!this.state.uploading,onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("pick_images")}}(this)},this.state.uploading?this.state.image_upload_progress?"Uploading "+((this.state.image_upload_progress||0)*100).toFixed(2)+"%":"Uploading...":"Select images"))},render_selected_attachments:function(){return div({className:"selected_attachments",children:this.state.selected_attachments.map(function(_this){return function(o,i){var input_name,is_first,is_last;is_first=i===0;is_last=i===_this.state.selected_attachments.length-1;input_name=function(field){return"attachment["+(i+1)+"]["+field+"]"};return _this.render_object(o,[!is_first?a({key:"moveup",className:"move_button",href:"javascript:void(0)",onClick:function(e){var reordered;reordered=slice.call(_this.state.selected_attachments);reordered.splice.apply(reordered,[i-1,0].concat(slice.call(reordered.splice(i,1))));_this.setState({selected_attachments:reordered});return e.preventDefault()}},"up"):void 0,!is_last?a({key:"movedown",className:"move_button",href:"javascript:void(0)",onClick:function(e){var reordered;reordered=slice.call(_this.state.selected_attachments);reordered.splice.apply(reordered,[i+1,0].concat(slice.call(reordered.splice(i,1))));_this.setState({selected_attachments:reordered});return e.preventDefault()}},"down"):void 0,button({key:"remove",type:"button",className:"button small outline remove_button",onClick:function(e){var sa;e.preventDefault();return _this.setState({available_attachments:[o].concat(slice.call(_this.state.available_attachments)),selected_attachments:function(){var j,len,ref1,results;ref1=this.state.selected_attachments;results=[];for(j=0,len=ref1.length;j<len;j++){sa=ref1[j];if(sa!==o){results.push(sa)}}return results}.call(_this)})}},"Remove"),o.attachment_id!=null?input({type:"hidden",name:input_name("attachment_id"),value:o.attachment_id,key:"oai"}):void 0,o.type==="video"?[input({type:"hidden",name:input_name("url"),value:o.url,key:"vurl"}),input({type:"hidden",name:input_name("type"),value:"video_link",key:"ot"}),o.id!=null?input({type:"hidden",name:input_name("id"),value:o.id,key:"oi"}):void 0]:[input({type:"hidden",name:input_name("object_type"),value:o.type,key:"ot"}),input({type:"hidden",name:input_name("object_id"),value:o.id,key:"oi"})]])}}(this))})},render_attachment_picker:function(){var options,visible_type;visible_type=this.state.visible_type;options=function(){switch(visible_type){case"upload_image":return this.render_image_uploader();case"video":return this.render_video_attach();default:return this.render_available_attachments()}}.call(this);return div({className:"object_picker tab_columns",children:[div({className:"type_filter tab_column",children:[button({type:"button",className:classNames("tab_btn",{selected:visible_type==="files"}),onClick:function(_this){return function(e){_this.setState({visible_type:"files"});return e.preventDefault()}}(this)},"Files"),button({type:"button",className:classNames("tab_btn",{selected:visible_type==="images"}),onClick:function(_this){return function(e){_this.setState({visible_type:"images"});return e.preventDefault()}}(this)},"Images"),button({type:"button",className:classNames("tab_btn",{selected:visible_type==="upload_image"}),onClick:function(_this){return function(e){e.preventDefault();return _this.setState({visible_type:"upload_image"})}}(this)},"Upload image"),button({type:"button",className:classNames("tab_btn",{selected:visible_type==="video"}),onClick:function(_this){return function(e){_this.setState({visible_type:"video"});return e.preventDefault()}}(this)},"Video")]}),div({className:"content_column type_"+visible_type},options)]})},render_video_attach:function(){return div({className:"video_attach"},h3({},"Add a video"),p({},"Provide the link to a video on YouTube, Vimeo, or Sketchfab attach it to the post"),this.state.video_error?p({className:"error_message"},this.state.video_error):void 0,section({className:"video_link_input",children:[input({type:"text",placeholder:"eg. https://www.youtube.com/watch?v=5JEaA47sPjQ",ref:"video_url",onKeyDown:function(_this){return function(e){if(e.keyCode===13){e.preventDefault();e.stopPropagation();return _this.trigger("append_video")}}}(this)}),button({type:"button",className:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("append_video")}}(this)},"Add video")]}))},render_available_attachments:function(){var options;options=this.available_attachments_by_type(this.state.visible_type).map(function(_this){return function(object){return _this.render_object(object,button({type:"button",className:"button small",onClick:function(e){var aa;e.preventDefault();return _this.setState({available_attachments:function(){var j,len,ref1,results;ref1=this.state.available_attachments;results=[];for(j=0,len=ref1.length;j<len;j++){aa=ref1[j];if(aa!==object){results.push(aa)}}return results}.call(_this),selected_attachments:slice.call(_this.state.selected_attachments).concat([object])})}},"Attach"))}}(this));if(!options.length){options=div({className:"empty_message"},"Nothing is available")}return options},available_attachments_by_type:function(type){var aa,j,len,ref1,results;ref1=this.state.available_attachments;results=[];for(j=0,len=ref1.length;j<len;j++){aa=ref1[j];switch(type){case"files":if(!(aa.type==="upload"||aa.type==="build")){continue}break;case"images":if(aa.type!=="image"){continue}}results.push(aa)}return results},render_object:function(){var children,key,object;object=arguments[0],children=2<=arguments.length?slice.call(arguments,1):[];key=object.type+"-"+(object.id||object.attachment_id||object.url);switch(object.type){case"video":return div.apply(null,[{key:key,className:"file_attachment video_attachment"},span({className:"attachment_title",children:[span({className:"video_tag"},"Video"),a({target:"_blank",className:"video_url",href:object.url},object.url)]})].concat(slice.call(children)));case"upload":case"build":return div.apply(null,[{key:key,className:"file_attachment"},span({className:"attachment_title",children:[object.name," ",object.sub_name?span({className:"title_tag"},object.sub_name):void 0]}),span({className:"attachment_date"},moment.utc(object.created_at).local().fromNow())].concat(slice.call(children)));case"image":return div({key:key,style:{backgroundImage:"url("+object.medium_image_url+")"},className:"image_preview",children:[div({className:"hover_overlay"},div.apply(null,[{className:"image_actions"}].concat(slice.call(children))))]})}}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("BundleBuyForm");types=React.PropTypes;P("AvailableItems",{propTypes:{tiers:types.array,price:types.number,currency:types.string,group_noun:types.string},count_total_items:function(){var count,i,len,ref1,t;count=0;ref1=this.props.tiers;for(i=0,len=ref1.length;i<len;i++){t=ref1[i];count+=t.items_count}return count},count_available_items:function(){var count,i,len,ref1,t;count=0;ref1=this.props.tiers;for(i=0,len=ref1.length;i<len;i++){t=ref1[i];if(t.price&&t.price>this.props.price){break}count+=t.items_count}return count},next_tier:function(){var i,len,ref1,t;ref1=this.props.tiers;for(i=0,len=ref1.length;i<len;i++){t=ref1[i];if(t.price&&t.price>this.props.price){return t}}},render:function(){var current_count,next,next_cents,next_price;next=this.next_tier();current_count=this.count_available_items();return div({className:"game_list_header"},h3({children:["You will receive "+current_count+" of "+this.count_total_items()+" "+this.props.group_noun,next?(next_cents=next.price-this.props.price,next_price=I.format_money(next_cents,this.props.currency).replace(/\.00$/,""),button({"data-amount":next_cents,className:"add_btn next_tier_btn textlike"},"Add "+next_price+" for "+next.items_count+" more "+this.props.group_noun)):void 0]}))}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Community");types=React.PropTypes;P("CategoryEditTags",{propTypes:{tags:types.arrayOf(types.shape({id:types.number.isRequired,label:types.string.isRequired,color:types.string}))},getInitialState:function(){return{tags:_.toArray(this.props.tags)}},push_tag:function(tag){tag=$.trim(tag);if(tag===""){return}this.state.tags.push({label:tag});return this.forceUpdate()},remove_tag:function(idx){this.state.tags.splice(idx,1);return this.forceUpdate()},input_name:function(name,idx){return"category_tags["+(idx+1)+"]["+name+"]"},render:function(){return div({children:[this.state.tags.length?div({className:"tag_list",children:_.map(this.state.tags,function(_this){return function(tag,idx){return div({className:"tag_row",children:[tag.id!=null?input({type:"hidden",name:_this.input_name("id",idx),value:""+tag.id}):void 0,tag.color!=null?input({type:"hidden",name:_this.input_name("color",idx),value:tag.color}):void 0,input({type:"hidden",name:_this.input_name("label",idx),value:tag.label}),span({className:"tag_label"},tag.label)," ",a({href:"",onClick:function(e){e.preventDefault();return _this.remove_tag(idx)}},"remove")]})}}(this))}):void 0,input({type:"text",placeholder:"Press enter to add tag",onKeyDown:function(_this){return function(e){if(e.keyCode!==13){return}e.preventDefault();_this.push_tag(e.target.value);return e.target.value=""}}(this)})]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Community");types=React.PropTypes;P("TopicVoter",{propTypes:{post_id:types.number.isRequired,vote:types.string,vote_url:types.string.isRequired,score:types.number.isRequired,adjustment:types.number,dir:types.string},getInitialState:function(){return{vote:this.props.vote}},vote:function(direction){var opts,removing,url;if(!I.current_user){window.location=this.login_url();return}this.setState({loading:true});url=_.template(this.props.vote_url)({post_id:this.props.post_id});removing=false;opts=direction===this.state.vote?(removing=true,{action:"remove"}):{direction:direction};return $.post(url,I.with_csrf(opts)).done(function(_this){return function(res){_this.setState({loading:false});if(res.success){_this.setState({vote:!removing&&direction,adjustment:res.score_adjustment});return $(ReactDOM.findDOMNode(_this)).find("button").trigger("i:refresh_tooltip")}}}(this))},login_url:function(){return"/login?"+$.param({return_to:window.location.toString(),intent:"community"})},render:function(){var ref1,score,vote_classes;score=this.props.score;if(this.state.vote){score+=(ref1=this.state.adjustment)!=null?ref1:this.props.adjustment}vote_classes="vote_btn button small";return div({children:[button({type:"button","aria-label":this.state.vote==="up"?"Remove up vote":"Vote up",className:classNames(vote_classes,"vote_up_btn icon-caret-up",{outline:this.state.vote!=="up",disabled:this.state.loading}),disabled:this.state.loading,onClick:function(_this){return function(){return _this.vote("up")}}(this)}),div({className:"vote_score"},score),this.props.dir!=="up"?button({type:"button","aria-label":this.state.vote==="down"?"Remove down vote":"Vote down",className:classNames(vote_classes,"vote_down_btn icon-caret-down",{outline:this.state.vote!=="down",disabled:this.state.loading}),disabled:this.state.loading,onClick:function(_this){return function(){return _this.vote("down")}}(this)}):void 0]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Dashboard");types=React.PropTypes;P("ToolGameTagsLightbox",{propTypes:{game:types.object.isRequired,tool:types.object.isRequired,selected_tags:types.array.isRequired,url:types.string.isRequired},render:function(){return R.Lightbox({className:"tool_game_tags_lightbox"},this.enclose({children:[h2({},"Edit tags for "+this.props.game.title),div({className:"content"},form({className:"form",action:this.props.url,method:"post",ref:"form",onSubmit:function(_this){return function(e){e.preventDefault();return I.remote_submit($(_this.refs.form)).then(_this.props.on_save)}}(this)},input({type:"hidden",name:"action",value:"update_tags"}),R.CSRF({}),R.GameEdit.EditToolOptions({tool:this.props.tool,selected_tags:this.props.selected_tags}),div({className:"buttons"},button({className:"button"},"Save tags"))))]}))}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;P("DownloadKeyLightbox",{propTypes:{new_key:types.bool,download_key:types.shape({id:types.number.isRequired,url:types.string.isRequired,label:types.string,must_be_claimed:types.bool,can_be_claimed:types.bool,owner:types.shape({display_name:types.string.isRequired,url:types.string.isRequired})}).isRequired,game:types.shape({noun:types.string.isRequired}).isRequired},lightbox_initialized:function(){return this.state.lightbox.el.on("i:lightbox_close",function(_this){return function(){if(_this.props.new_key){return window.location.reload()}}}(this))},getInitialState:function(){var key;key=this.props.download_key;return{changed:false,label:key.label,can_be_claimed:key.can_be_claimed||false,must_be_claimed:key.must_be_claimed||false}},close_lightbox:function(){if(this.state.loading){return}if(this.state.changed){return this.save_key()}else if(this.props.new_key){return window.location.reload()}else{return I.Lightbox.close()}},save_key:function(){var params;this.setState({loading:true});params=I.with_csrf({action:"update",download_key_id:this.props.download_key.id,"download_key[label]":this.state.label,"download_key[can_be_claimed]":this.state.can_be_claimed||void 0,"download_key[must_be_claimed]":this.state.must_be_claimed||void 0});return $.post("",params).done(function(_this){return function(res){return window.location.reload()}}(this))},render:function(){var key;key=this.props.download_key;return R.Lightbox({className:"key_lightbox",children:[h2({},"Download key"),div({className:"unclaimed_message",children:[key.owner?p({children:["This download key has been claimed by ",a({href:key.owner.url},key.owner.display_name),"."]}):p({},"Share this URL with someone to give them download access to your "+this.props.game.noun+" without paying."),div({className:"form",children:[input({type:"text",readOnly:true,className:"text_input key_url_input",value:key.url})]}),!key.owner?p({},"This URL can be used by anyone, so don't spread more than necessary. If you think it's being abused you can revoke it."):void 0,this.render_label_form(),this.render_claim_options(),div({className:"button_row"},button({disabled:this.state.loading,className:classNames("button",{disabled:this.state.loading}),onClick:this.close_lightbox},this.state.changed&&"Save & close"||"Close"))]})]})},render_label_form:function(){return div({className:"form label_form",children:[p({},"You can give a private label to the key to easily identify it later."),label({children:[div({className:"label"},"Label"),input({type:"text",className:"text_input label_input",placeholder:"Unlabeled",value:this.state.label,onChange:function(_this){return function(e){return _this.setState({changed:true,label:e.target.value})}}(this)}),span({className:"icon icon-checkmark",title:"Saved"})]})]})},render_claim_options:function(){if(this.props.download_key.owner){return}return div({className:"form claim_options",children:[p({},"Key claiming options:"),label({className:"claim_toggle",children:[input({type:"checkbox",name:"can_be_claimed",checked:this.state.can_be_claimed,onChange:function(_this){return function(){return _this.setState({changed:true,can_be_claimed:!_this.state.can_be_claimed})}}(this)}),p({},strong({},"Download key can be claimed")),p({},"Enables anyone with an itch.io account to take ownership of the download key, preventing anyone else from using it.")]}),this.state.can_be_claimed?label({className:"claim_toggle",children:[input({type:"checkbox",name:"must_be_claimed",checked:this.state.must_be_claimed,onChange:function(_this){return function(){return _this.setState({changed:true,must_be_claimed:!_this.state.must_be_claimed})}}(this)}),p({},strong({},"Require key to be claimed")),p({},"Forces the key to be claimed before allowing files to be downloaded. This can help prevent the key from being shared.")]}):void 0]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,key_counter,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Community");types=React.PropTypes;key_counter=0;P("EditCategories",{propTypes:{category:types.object},getInitialState:function(){return{children:_.toArray(this.props.category.children)}},componentDidMount:function(){return this.dispatch("category",{create:function(_this){return function(){_this.state.children.push({key:key_counter+=1});return _this.forceUpdate()}}(this),set_property:function(_this){return function(e,category,property,value){category[property]=value;return _this.forceUpdate()}}(this),create_child:function(_this){return function(e,category){category.children||(category.children=[]);category.children.push({key:key_counter+=1});return _this.forceUpdate()}}(this),remove_child:function(_this){return function(e,category,idx){var children;children=category===_this.props.category?_this.state.children:category.children;children.splice(idx,1);return _this.forceUpdate()}}(this),toggle:function(_this){return function(e,category,field){category[field]=!category[field];return _this.forceUpdate()}}(this),move_up:function(_this){return function(e,category,idx){var c,children,ref1,swap_with;children=category===_this.props.category?_this.state.children:category.children;swap_with=idx-1;if(!children[swap_with]){return}c=children;ref1=[c[swap_with],c[idx]],c[idx]=ref1[0],c[swap_with]=ref1[1];return _this.forceUpdate()}}(this),move_down:function(_this){return function(e,category,idx){var c,children,ref1,swap_with;children=category===_this.props.category?_this.state.children:category.children;swap_with=idx+1;if(!children[swap_with]){return}c=children;ref1=[c[swap_with],c[idx]],c[idx]=ref1[0],c[swap_with]=ref1[1];return _this.forceUpdate()}}(this)})},render:function(){return form({method:"POST",className:"edit_categories form",children:[R.CSRF({}),h2({},"Subcategories"),this.state.children.length?div({className:"category_list",children:_.map(this.state.children,function(_this){return function(cat,idx){return P.CategoryRow({is_first:idx===0,is_last:idx===_this.state.children.length-1,key:cat.key||"cat"+cat.id,parent_category:_this.props.category,category:cat,position:idx+1})}}(this))}):p({},em({className:"empty_message"},"There are no categories. You must have at least one non-directory category for your community to be usable.")),div({className:"button_row",children:[button({className:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("category:create")}}(this)},"New category")," ",button({className:"button"},"Save")]})]})}});P("CategoryRow",{propTypes:{is_first:types.bool,is_last:types.bool,position:types.number,category:types.shape({id:types.number,title:types.string}),input_prefix:types.string},input_name:function(name){var prefix;prefix=this.props.input_prefix||"categories";return prefix+"["+(this.props.position||"")+"]["+name+"]"},render:function(){var count,ref1;return div({className:"category_row",children:[this.props.category.id?input({type:"hidden",name:this.input_name("id"),value:this.props.category.id}):void 0,div({className:"category_primary_inputs",children:this.render_title_inputs()}),div({className:"category_secondary_inputs",children:this.render_button_inputs()}),div({className:"category_secondary_inputs",children:[label({children:[input({type:"checkbox",name:this.input_name("archived"),checked:this.props.category.archived||false,onChange:function(_this){return function(e){return _this.trigger("category:toggle",_this.props.category,"archived")}}(this)}),span({className:"label"},"Archive")]}),label({children:[input({type:"checkbox",name:this.input_name("hidden"),checked:this.props.category.hidden||false,onChange:function(_this){return function(e){return _this.trigger("category:toggle",_this.props.category,"hidden")}}(this)}),span({className:"label"},"Hidden")]}),label({children:[input({type:"checkbox",name:this.input_name("directory"),checked:this.props.category.directory||false,onChange:function(_this){return function(e){return _this.trigger("category:toggle",_this.props.category,"directory")}}(this)}),span({className:"label"},"Directory")]}),this.props.category.created_at?span({className:"created_at"},moment.utc(this.props.category.created_at).local().calendar()):void 0,!this.props.category.directory&&this.props.category.topics_count!=null?(count=this.props.category.topics_count,span({className:"topics_count"},count+" topic"+(count===1&&""||"s"))):void 0,this.props.category.url?a({className:"category_link",href:this.props.category.url},"View"):void 0,this.props.category.edit_url?a({className:"category_link",href:this.props.category.edit_url},"Edit"):void 0]}),((ref1=this.props.category.children)!=null?ref1.length:void 0)?div({className:"child_categories",children:_.map(this.props.category.children,function(_this){return function(cat,idx){return P.CategoryRow({is_first:idx===0,is_last:idx===_this.props.category.children-1,key:cat.key||"cat"+cat.id,input_prefix:(_this.props.input_prefix||"categories")+"["+_this.props.position+"][children]",parent_category:_this.props.category,category:cat,position:idx+1})}}(this))}):void 0]})},render_title_inputs:function(){return[!this.props.category.id?span({className:"new_flag"},"New"):void 0,input({type:"text",className:"title_input text_input",name:this.input_name("title"),required:"required",value:this.props.category.title||"",placeholder:"Title",onChange:function(_this){return function(e){return _this.trigger("category:set_property",_this.props.category,"title",e.target.value)}}(this)}),!this.props.category.directory?input({type:"text",className:"short_description_input text_input",name:this.input_name("short_description"),value:this.props.category.short_description||"",placeholder:"Short description",onChange:function(_this){return function(e){return _this.trigger("category:set_property",_this.props.category,"short_description",e.target.value)}}(this)}):void 0]},render_button_inputs:function(){return[button({className:"button small",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("category:create_child",_this.props.category)}}(this)},"Add child"),!this.props.is_first?a({href:"javascript:void(0)",className:"move_btn move_up_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("category:move_up",_this.props.parent_category,_this.props.position-1)}}(this)},"Move up"):void 0,!this.props.is_last?a({href:"javascript:void(0)",className:"move_btn move_down_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("category:move_down",_this.props.parent_category,_this.props.position-1)}}(this)},"Move down"):void 0,a({href:"javascript:void(0)",className:"remove_btn",onClick:function(_this){return function(e){if(confirm("Are you sure you want to remove?")){return _this.trigger("category:remove_child",_this.props.parent_category,_this.props.position-1)}}}(this)},"Remove")]}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,stores,strong,textarea,types,ul,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;stores=[{label:"Steam",name:"steam_url",example:"http://store.steampowered.com/app/220/HalfLife_2/"},{label:"Apple App Store",name:"app_store_url",example:"https://itunes.apple.com/us/app/my-game/id879877684?mt=8&uo=4"},{label:"Google Play",name:"google_play_url",example:"https://play.google.com/store/apps/details?id=com.mygame.example"},{label:"Amazon App Store",name:"amazon_appstore_url",example:"http://www.amazon.com/Foobar/dp/B00992CF6W"},{label:"Windows Store",name:"windows_phone_url",example:"https://www.microsoft.com/en-us/store/apps/itchio/9nblgggz6166"}];P("GameLinks",{propTypes:{tags:types.array,app_store_url:types.string,google_play_url:types.string,amazon_appstore_url:types.string,windows_phone_url:types.string},getInitialState:function(){var name,open_stores;open_stores=function(){var i,len,results;results=[];for(i=0,len=stores.length;i<len;i++){name=stores[i].name;if(!this.props[name]){continue}results.push(name)}return results}.call(this);return{open_stores:open_stores}},store_by_name:function(_this){return function(name){var i,len,store;for(i=0,len=stores.length;i<len;i++){store=stores[i];if(store.name===name){return store}}}}(this),render:function(){return div({className:"links_editor",children:[this.render_ludum_dare_input(),div({className:"input_row app_store_links_row",children:[div({className:"label",children:["App store links",p({className:"sub"},"If your project is available on any other stores we'll link to it.")]}),this.render_store_links()]})]})},has_ludum_dare:function(){var i,len,ref1,tag;ref1=this.props.tags;for(i=0,len=ref1.length;i<len;i++){tag=ref1[i];if(tag.match(/^ludum-dare/)){return true}}return false},render_ludum_dare_input:function(){if(!this.has_ludum_dare()){return}return div({className:"input_row ludum_dare_input_row",children:[label({children:[div({className:"label"},"Ludum Dare submission URL",span({className:"sub"}," — You can add this later")),input({type:"text",name:"game[ludum_dare_url]",defaultValue:this.props.ludum_dare_url,ref:"ludum_dare_input",placeholder:"eg. https://ldjam.com/events/ludum-dare/39/your-game-name"})]})]})},render_store_links:function(){var closed_stores,n,open_stores,store;open_stores=function(){var i,len,ref1,results;ref1=this.state.open_stores;results=[];for(i=0,len=ref1.length;i<len;i++){n=ref1[i];results.push(this.store_by_name(n))}return results}.call(this);closed_stores=function(){var i,len,ref1,results;results=[];for(i=0,len=stores.length;i<len;i++){store=stores[i];if(ref1=store.name,indexOf.call(this.state.open_stores,ref1)<0){results.push(store)}}return results}.call(this);return div({children:[this.render_open_stores(open_stores),div.apply(null,[{className:"add_buttons"}].concat(slice.call(this.render_closed_stores(closed_stores)))),this.empty_values(closed_stores)]})},render_open_stores:function(stores){return div({className:"store_url_inputs",children:stores.map(function(_this){return function(store){return div({className:"input_row",key:store.name,children:[p({className:"sub"},store.label),div({className:"input_wrapper",children:[input({type:"text",ref:store.name,name:"game["+store.name+"]",placeholder:"eg. "+store.example,defaultValue:_this.props[store.name]}),button({className:"clear_store_button",onClick:function(e){var s;e.preventDefault();return _this.setState({open_stores:function(){var i,len,ref1,results;ref1=this.state.open_stores;results=[];for(i=0,len=ref1.length;i<len;i++){s=ref1[i];if(s!==store.name){results.push(s)}}return results}.call(_this)})}},"×")]})]})}}(this))})},empty_values:function(stores){return stores.map(function(_this){return function(store){return input({type:"hidden",name:"game["+store.name+"]",value:""})}}(this))},render_closed_stores:function(stores){return stores.map(function(_this){return function(store){return button({className:"add_link_button",onClick:function(e){_this.setState({open_stores:_this.state.open_stores.concat([store.name])});_.defer(function(){var ref1;return(ref1=_this.refs[store.name])!=null?ref1.focus():void 0});return e.preventDefault()}},span({className:"icon icon-plus"}),store.label)}}(this))}});P("AccessControl",{propTypes:{game:types.object,noun:types.string,published:types.bool,active:types.bool,unlisted:types.bool,restricted:types.bool,password:types.string,purchases_count:types.number},getInitialState:function(){var published,unlisted;published=this.props.published?this.props.restricted?"restricted":"published":"draft";unlisted=published!=="restricted"?this.props.unlisted:void 0;return{published:published,custom_settings_open:!this.props.active||unlisted,prevent_new:!this.props.active,unlisted:unlisted,require_password:!!this.props.password,password:this.props.password}},render:function(){return div({className:"access_control input_row",children:[div({className:"label"},"Visibility & access"),p({className:"sub",children:["Use Draft to finalize your page's design before making it public. ",a({href:"/docs/creators/access-control"},"Learn more")]}),this.render_draft_warning(),R.Forms.RadioButtons({name:"game[published]",value:this.state.published,onChange:function(_this){return function(e){return _this.setState({published:e.target.value})}}(this),options:[["draft","Draft","Only those who can edit the project can view the page"],["restricted","Restricted","Only owners & authorized people can view the page"],["published","Public",["Anyone can view the page",this.props.game.id==null?[", ",strong({},"you can enable this after you've saved")]:void 0,!this.state.custom_settings_open&&this.state.published==="published"?[" ",a({href:"javascript:void(0)",className:"configure_link",onClick:function(_this){return function(e){e.preventDefault();return _this.setState({custom_settings_open:!_this.state.custom_settings_open})}}(this)},"Configure settings...")]:void 0],{disabled:this.props.game.id==null}]]}),this.show_access_settings()?this.render_access_settings():void 0]})},show_access_settings:function(){if(this.state.published==="restricted"){return true}if(this.state.published==="published"){return this.state.custom_settings_open}return false},render_draft_warning:function(){var people;if(this.state.published!=="draft"){return}if(!(this.props.purchases_count&&this.props.purchases_count>0)){return}people=this.props.purchases_count>1?"people":"person";return p({className:"sub warning"},strong({},"Warning: "),"The "+this.props.purchases_count+" "+people+" who bought the "+this.props.noun+" will not be able to access it while it's draft.")},render_public_access_options:function(){return[div({className:"input_row"},label({children:[input({type:"checkbox",name:"game[prevent_new]",checked:this.state.prevent_new,onChange:function(_this){return function(e){return _this.setState({prevent_new:e.target.checked})}}(this)}),"Disable new downloads & purchases",div({className:"help_hover","data-tooltip":"Only those who already own the game or get a download key can download. Does not effect embedded files"})]})),div({className:"input_row"},label({children:[input({type:"checkbox",name:"game[unlisted]",checked:this.state.unlisted,onChange:function(_this){return function(e){return _this.setState({unlisted:e.target.checked})}}(this)}),"Unlisted in search & browse"]}))]},render_restricted_access_options:function(){return[p({className:"sub"},"Only people who own the "+this.props.noun+" can view the page. You can give access by generating a download key. The page will be unlisted in browse and search."),div({className:"input_row"},label({children:[input({type:"checkbox",name:"game[require_password]",checked:this.state.require_password,onChange:function(_this){return function(e){return _this.setState({require_password:e.target.checked})}}(this)}),"Also allow a password to view page",div({className:"help_hover","data-tooltip":"Password not required for owners"})]}),this.state.require_password?input({type:this.state.password_focused?"text":"password",required:true,className:"password_input",name:"game[password]",autoComplete:"new-password",placeholder:"Password",value:this.state.password,onFocus:function(_this){return function(){return _this.setState({password_focused:true})}}(this),onBlur:function(_this){return function(){return _this.setState({password_focused:false})}}(this),onChange:function(_this){return function(e){return _this.setState({password:e.target.value})}}(this)}):void 0)]},render_access_settings:function(){var box_title,closable;closable=this.state.published==="published";box_title=function(){switch(this.state.published){case"published":return"Public access settings";case"restricted":return"Restricted access settings";default:return"Access settings"}}.call(this);return div({className:"publish_toggles",children:[div({className:"toggle_header"},span({},box_title),closable?button({type:"button",onClick:function(_this){return function(e){return _this.setState({custom_settings_open:false})}}(this)},"×"):void 0),function(){switch(this.state.published){case"published":return this.render_public_access_options();case"restricted":return this.render_restricted_access_options()}}.call(this)]})}});P("DeleteBlockedLightbox",{render:function(){return R.Lightbox({className:this.enclosing_class_name(),children:[h2({},"This project can't be deleted"),p({},"This project currently has owners. Deleting this project would prevent them from being able to access it. If you want to prevent new people from seeing or buying the page please put it in ",em({},"Restricted")," mode. Alternatively you can just disable purchases."),p({},"If you actually need to delete the project please ",a({href:"/support"},"contact support"),"."),p({},a({href:"javascript:void(0)",className:"close_btn"},"Got it"))]})}});P("GameTags",{propTypes:{genres:types.array.isRequired,classification:types.string,suggested_tags:types.array,on_change_tags:types.func},getInitialState:function(){return{tags:_.toArray(this.props.tags)}},has_tag:function(tag){var i,len,ref1,t;ref1=this.state.tags;for(i=0,len=ref1.length;i<len;i++){t=ref1[i];if(tag===t){return true}}return false},add_tag:function(tag){var s;s=this.tags_input[0].selectize;return s.createItem(tag,false)},componentDidMount:function(){var default_tags,items,suggested_tags,tags_input;suggested_tags=_.toArray(this.props.suggested_tags);tags_input=$(this.refs.tags_input);items=tags_input.data("json_value")||[];default_tags=_.toArray(this.props.tags);return this.tags_input=tags_input.selectize({delimiter:",",plugins:["remove_button"],persist:false,placeholder:tags_input.attr("placeholder"),valueField:"slug",labelField:"slug",searchField:["slug"],closeAfterSelect:true,options:suggested_tags.concat(default_tags).map(function(x){return{slug:x}}),create:function(tag){return{slug:I.slugify(tag)}},onChange:function(_this){return function(){var base,tags;tags=_this.tags_input[0].selectize.items||[];_this.setState({tags:tags});return typeof(base=_this.props).on_change_tags==="function"?base.on_change_tags(tags):void 0}}(this)})},hide_genre:function(){return this.props.classification!=="game"},render:function(){return this.enclose({children:[this.hide_genre()?input({type:"hidden",name:"game[genre]",value:"none"}):div({className:"input_row"},div({className:"label"},"Genre"),p({className:"sub"},"Select the category that best describes your game. You can pick additional genres with tags below"),R.Forms.Select({name:"game[genre]",defaultValue:this.state.genre||this.props.genre,selectize:true,onChange:function(_this){return function(e){return _this.setState({genre:e.target.value})}}(this),options:[["none","No genre"]].concat(slice.call(this.props.genres.map(function(_this){return function(arg){var slug,title;title=arg.title,slug=arg.slug;return[slug,title]}}(this))))})),div({className:"input_row tags_input_row"},div({className:"label"},"Tags",span({className:"sub"},"— ",a({href:this.props.tag_guide_url,target:"blank"},"Tips for choosing tags"))),p({className:"sub"},"Any other keywords someone might search to find your game. Max of 10"),p({className:"sub"},"Avoid using the genre or platforms provided above."),this.state.tags.length>this.props.max_tags?p({className:"sub error"},"Too many tags! Please choose at most "+this.props.max_tags+" tags."):void 0,div({className:"selectize_group"},input({type:"text",name:"game[tags]",className:"tag_input",ref:"tags_input",defaultValue:_.toArray(this.props.tags).join(","),placeholder:"Click to view options, type to filter or enter custom tag"})),this.props.ludum_dare_tag&&!this.has_tag(this.props.ludum_dare_tag)?div({className:"ludum_dare_tagger"},p({},strong({},"Ludum Dare submission?")," ",button({type:"button",className:"button small add_tag_btn",onClick:function(_this){return function(e){return _this.add_tag(_this.props.ludum_dare_tag)}}(this)},"Add Ludum Dare tag"))):void 0)]})}});P("EmbedOptions",{getInitialState:function(){return $.extend({embed_type:"frame",size_type:"manual",width:"",height:"",mobile_friendly:false,fullscreen:false,scrollbars:false,autostart:false},this.props)},render:function(){var ref1;if((ref1=this.props.type)!=="unity"&&ref1!=="java"&&ref1!=="html"){return null}return this.enclose({children:[h2({},"Embed options"),this.render_embed_mode(),this.render_dimensions(),this.render_frame_options()]})},render_dimensions:function(){if(this.props.type==="html"){if(this.state.embed_type!=="frame"){return}if(this.state.size_type!=="manual"){return}}return div({className:"input_row"},div({className:"label"},"Viewport dimensions"),div({className:"dimensions_inputs"},label({},span({className:"dimension_label"},"Width"),input({className:classNames("inline_input",{has_error:this.state.width===""}),name:"embed[width]",type:"text",value:this.state.width,required:true,onChange:function(_this){return function(e){if(e.target.value.match(/^\d*$/)){return _this.setState({width:e.target.value})}}}(this)}),span({className:"size_unit"},"px")),span({className:"mult"},"×"),label({},span({className:"dimension_label"},"Height"),input({className:classNames("inline_input",{has_error:this.state.height===""}),name:"embed[height]",type:"text",required:true,value:this.state.height,onChange:function(_this){return function(e){if(e.target.value.match(/^\d*$/)){return _this.setState({height:e.target.value})}}}(this)}),span({className:"size_unit"},"px"))))},checkbox:function(name){return input({type:"checkbox",name:"embed["+name+"]",checked:this.state[name],onChange:function(_this){return function(e){var update;update={};update[name]=e.target.checked;return _this.setState(update)}}(this)})},render_frame_options:function(){if(this.props.type!=="html"){return}return div({className:"input_row"},div({className:"label"},"Frame options"),ul({className:"check_list frame_options"},li({},label({},this.checkbox("mobile_friendly"),"Mobile friendly",span({className:"sub"}," — Your project can run on mobile phones (smaller resolution and touch support)"))),this.state.embed_type!=="maximized"?li({},label({},this.checkbox("autostart"),"Automatically start on page load",span({className:"sub"}," — Not recommended for Unity games, since they can lag the browser when loading"))):void 0,this.state.embed_type!=="maximized"?li({},label({},this.checkbox("fullscreen"),"Fullscreen button",span({className:"sub"}," — Add a button to the bottom right corner of your embed to make it fullscreen"))):void 0,li({},label({},this.checkbox("scrollbars"),"Enable scrollbars",span({className:"sub"}," — Enable scrollbars in the iframe that contains your project")))))},render_embed_mode:function(){if(this.props.type!=="html"){return[input({type:"hidden",name:"embed[embed_type]",value:"frame"}),input({type:"hidden",name:"embed[size_type]",value:"manual"})]}return div({className:"input_row"},p({className:"sub"},"How should your project be run in your page?"),div({className:"dimensions_row"},R.Forms.SimpleSelect({name:"embed[embed_type]",value:this.state.embed_type,onChange:function(_this){return function(type){return _this.setState({embed_type:type})}}(this),options:[{name:"Embed in page",value:"frame"},{name:"Click to launch in fullscreen",value:"maximized"}]})," ",this.state.embed_type==="frame"?R.Forms.SimpleSelect({name:"embed[size_type]",value:this.state.size_type,onChange:function(_this){return function(type){return _this.setState({size_type:type})}}(this),options:[{name:"Manually set size",value:"manual"},{name:"Auto-detect size (Unity HTML only)",value:"auto"}]}):void 0))}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;P("EmbedUpload",{propTypes:{embed_url_template:types.string,noun:types.string,uploads:types.array},componentDidMount:function(){this.pick_upload(this.state.selected_upload);return $(document.body).on("keydown",function(_this){return function(e){if(e.keyCode===27){return _this.setState({show_preview:false})}}}(this))},getInitialState:function(){return{show_preview:false,width:this.props.default_width,height:this.props.default_height,color:this.props.default_color,selected_upload:this.default_upload()}},default_upload:function(){var i,j,len,ref1,u;if(!this.props.uploads){return}ref1=this.props.uploads;for(i=j=0,len=ref1.length;j<len;i=++j){u=ref1[i];if(u["default"]){return i}}return 0},pick_upload:function(idx){var ref1,s,upload;idx=+idx;s={selected_upload:idx};upload=(ref1=this.props.uploads)!=null?ref1[idx]:void 0;if(!upload){return}if(upload.height){s.height=upload.height}if(upload.width){s.width=upload.width}return this.setState(s)},current_upload:function(){return this.props.uploads[this.state.selected_upload]},set_int:function(field,val){var props;if(!(""+val).match(/^\d*$/)){return}props={};props[field]=val;return this.setState(props)},render:function(){if(!this.props.uploads||this.props.uploads.length===0){return this.render_empty()}return div({className:"embed_upload",children:[this.state.show_preview?this.render_preview():void 0,div({className:"form"},div({className:"upload_list",children:[label({},div({className:"label"},"Select a file"),select({value:this.state.selected_upload,onChange:function(_this){return function(e){return _this.pick_upload(e.target.value)}}(this),children:this.props.uploads.map(function(_this){return function(u,idx){return option({value:idx},u.name)}}(this))}))]}),div({className:"embed_options",children:[label({},span({className:"label"},"Width"),input({type:"text",value:this.state.width,onChange:function(_this){return function(e){return _this.set_int("width",e.target.value)}}(this)})),label({},span({className:"label"},"Height"),input({type:"text",value:this.state.height,onChange:function(_this){return function(e){return _this.set_int("height",e.target.value)}}(this)})),label({},span({className:"label"},"Color"),input({className:"color_input",type:"color",value:this.state.color,onChange:function(_this){return function(e){return _this.setState({color:e.target.value})}}(this)})),div({className:"spacer"}),button({className:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.setState({show_preview:true})}}(this)},"Preview")]}),textarea({readOnly:true,className:"embed_code",ref:function(_this){return function(code_el){_this.code_el=code_el}}(this),onClick:function(_this){return function(e){return e.target.select()}}(this)}),P.RenderMarkup({children:this.render_embed(),on_html:function(_this){return function(html){if(_this.code_el){return _this.code_el.value=html}}}(this)}),div({className:"embed_directions",children:[strong({},"Directions")," Copy and paste this HTML into your website where you want the "+this.props.noun+" to appear."]}),div({className:"ludum_dare_directions",children:[p({},strong({},"Direct link?")," Use this link to go directly to your game:",input({type:"text",readOnly:true,value:this.embed_url(),onClick:function(_this){return function(e){return e.target.select()}}(this)}))]}))]})},render_empty:function(){return div({className:"empty_message"},p({},"You currently don't have any uploads available to be embedded."))},render_preview:function(){return div({className:"preview_container",onClick:function(_this){return function(e){if($(e.target).is(".preview_container")){return _this.setState({show_preview:false})}}}(this)},this.render_embed())},embed_url:function(){var c,params,upload,url;upload=this.current_upload();params={};if(c=this.state.color.match(/#([a-fA-F\d]{6})/)){params.color=c[1]}params=$.param(params);url=_.template(this.props.embed_url_template)({id:upload.id});if(params!==""){url+="?"+params}return url},render_embed:function(){var upload;upload=this.current_upload();if(!upload){return}return iframe({frameBorder:"0",src:this.embed_url(),allowFullScreen:true,width:this.state.width,height:this.state.height})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;P("EditLinks",{propTypes:{game_link_types:types.array.isRequired,link_names:types.object.isRequired,links:types.arrayOf(types.shape({id:types.number,name:types.string,url:types.string.isRequired,type:types.string.isRequired}))},getInitialState:function(){var l;return{links:function(){var i,len,ref1,results;ref1=this.props.links||[];results=[];for(i=0,len=ref1.length;i<len;i++){l=ref1[i];results.push(l)}return results}.call(this)}},add_link:function(type){this.state.links.push({type:type,name:"",url:""});return this.forceUpdate()},remove_link:function(idx){this.state.links.splice(idx,1);return this.forceUpdate()},update_link:function(idx,prop,value){this.state.links[idx][prop]=value;return this.forceUpdate()},move_up:function(idx){var ref1;if(idx===0){return}(ref1=this.state.links).splice.apply(ref1,[idx-1,0].concat(slice.call(this.state.links.splice(idx,1))));return this.forceUpdate()},move_down:function(idx){var ref1;if(idx===this.state.links.length-1){return}(ref1=this.state.links).splice.apply(ref1,[idx+1,0].concat(slice.call(this.state.links.splice(idx,1))));return this.forceUpdate()},render:function(){return form({method:"post",className:"game_links_editor form",children:[input({type:"hidden",name:"csrf_token",value:I.get_csrf()}),this.render_links(),div({className:"add_buttons",children:[label({children:[span({className:"type_label label"},"Add new link to")," ",R.Forms.SimpleSelect({ref:"next_link_type",options:this.props.game_link_types.map(function(_this){return function(type){return{value:type,name:_this.props.link_names[type]}}}(this))})]})," ",button({className:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.add_link(_this.refs.next_link_type.current_option().value)}}(this)},"Enter URL...")]}),div({className:"buttons",children:[button({className:"button"},"Save links")]})]})},input_name:function(idx,name){return"links["+(idx+1)+"]["+name+"]"},render_link:function(link,idx){return div({className:"link_row",children:[input({type:"hidden",name:this.input_name(idx,"type"),value:link.type}),div({className:"label_column",children:[link.type==="other"?input({type:"text",name:this.input_name(idx,"name"),value:link.name,placeholder:"Name",required:true,onChange:function(_this){return function(e){return _this.update_link(idx,"name",e.target.value)}}(this)}):span({className:"link_type_name"},this.props.link_names[link.type])]}),input({type:"text",name:this.input_name(idx,"url"),value:link.url,placeholder:"http://",required:true,onChange:function(_this){return function(e){return _this.update_link(idx,"url",e.target.value)}}(this)}),a({href:"javascript:void(0)",className:classNames("move_link",{disabled:idx===0}),onClick:function(_this){return function(e){e.preventDefault();return _this.move_up(idx)}}(this)},"Up"),a({href:"javascript:void(0)",className:classNames("move_link",{disabled:idx===this.state.links.length-1}),onClick:function(_this){return function(e){e.preventDefault();return _this.move_down(idx)}}(this)},"Down"),a({href:"javascript:void(0)",className:"remove_btn",onClick:function(_this){return function(e){e.preventDefault();if(link.name||link.url){if(!confirm("Are you sre you want to remove this link?")){return}}return _this.remove_link(idx)}}(this)},span({className:"icon icon-cross"}))]})},render_links:function(){return div({className:"link_list",children:this.state.links.length?this.state.links.map(function(_this){return function(link,idx){return _this.render_link(link,idx)}}(this)):em({className:"empty_message"},"No links added yet")})}})}).call(this);(function(){var DEFAULT_DONATION,DEFAULT_MIN_PRICE,P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;DEFAULT_MIN_PRICE=100;DEFAULT_DONATION=200;P("PricePicker",{pure:true,propTypes:{currency:types.string.isRequired,min_price:types.number,suggested_price:types.number,disable_payments:types.bool,reward_required:types.bool,is_embed:types.bool,default_donation_amount:types.number},getInitialState:function(){return{payment_mode:this.props.disable_payments?"disable_payments":this.props.min_price>0?"paid":"free",show_suggested_price:this.props.suggested_price&&this.props.suggested_price>this.props.min_price||false,min_price:this.props.min_price,suggested_price:this.props.suggested_price}},render:function(){var default_price,payment_modes,price_error;payment_modes=[{label:I.format_money(0,this.props.currency).replace(/\.00$/,"")+" or donate",name:"free"},{label:"Paid",name:"paid"},{label:"No payments",name:"disable_payments"}];return this.enclose({children:[input({type:"hidden",name:"game[payment_mode]",value:this.state.payment_mode}),this.props.reward_required?p({className:"reward_notice"},strong({},"A reward is required to download. "),"You projects's minimum price is fixed to the lowest available reward. ",a({className:"forward_link",target:"_blank",href:this.props.rewards_url},"Configure rewards")):void 0,div({className:"payment_modes",children:payment_modes.map(function(_this){return function(mode){var active;active=mode.name===_this.state.payment_mode;return button({type:"button",className:classNames("payment_mode_"+mode.name,{active:active}),onClick:function(){var min_price;_this.setState({payment_mode:mode.name});min_price=mode.name==="paid"?_this.state.min_price||DEFAULT_MIN_PRICE:0;return _this.trigger("game:set_state",{disable_payments:mode.name==="disable_payments",min_price:min_price})},children:[span({className:classNames("icon",{"icon-checkbox-checked":active,"icon-checkbox-unchecked":!active})}),span({className:"label"},mode.label)]})}}(this))}),function(){switch(this.state.payment_mode){case"paid":default_price=this.state.min_price||DEFAULT_MIN_PRICE;price_error=default_price<DEFAULT_MIN_PRICE;return div({className:"price_inputs",children:[this.props.is_embed?p({className:"price_note"},"Setting a minimum price will only restrict access to downloadable files. Embedded content is freely available."):void 0,R.Forms.TextInputRow({title:"Minimum price",sub:"Minimum price to pay to get download access to game",name:"game[min_price]",defaultValue:I.format_money(default_price,this.props.currency),money_input:true,currency:this.props.currency,placeholder:I.format_money(0,this.props.currency),has_error:price_error,error_message:price_error?"Please enter a price of at least "+I.format_money(DEFAULT_MIN_PRICE,this.props.currency):void 0,onKeyUp:function(_this){return function(e){var min_price;min_price=I.parse_money(e.target.value);_this.setState({min_price:min_price});return _this.trigger("game:set_state",{min_price:min_price})}}(this)}),this.render_suggested_price()]});case"free":return[input({type:"hidden",name:"game[min_price]",value:I.format_money(0,this.props.currency)}),p({className:"sub"},"Someone downloading your project will be asked for a donation before getting access. They can skip to download for free"),div({className:"price_inputs"},this.render_suggested_price({sub:"Default donation amount"}))];case"disable_payments":return[input({type:"hidden",name:"game[min_price]",value:I.format_money(0,this.props.currency)}),this.props.reward_required?p({className:"warning"},"Your project will be unable to be downloaded or purchased if payments are disabled and a reward is required. Please change one of the options. (Existing owners will still maintain access)"):p({className:"sub"},"The project's files will be freely available and no donations can be made")]}}.call(this)]})},suggested_price_enabled:function(){return this.state.show_suggested_price||this.state.payment_mode==="free"},render_suggested_price:function(opts){var default_value,price_error;if(opts==null){opts={}}return div({className:"suggested_price",children:[this.state.payment_mode==="paid"?div({className:"input_row suggest_alt_input_row"},label({},input({type:"checkbox",className:"suggested_price_toggle",checked:this.state.show_suggested_price,onChange:function(_this){return function(e){var update;update={show_suggested_price:e.target.checked};if(_this.state.payment_mode==="paid"&&update.show_suggested_price){update.suggested_price=Math.max(_this.props.default_donation_amount||DEFAULT_DONATION,_this.state.min_price||0)}return _this.setState(update)}}(this)}),"Suggest an alternate default price")):void 0,this.suggested_price_enabled()?(price_error=this.state.payment_mode==="paid"?(this.state.min_price||0)>(this.state.suggested_price||0):void 0,default_value=this.state.suggested_price||this.props.default_donation_amount||DEFAULT_DONATION,R.Forms.TextInputRow({title:this.state.payment_mode==="free"?"Suggested donation":"Suggested price",sub:opts.sub||"Default price shown when someone attempts to buy your project",defaultValue:I.format_money(default_value,this.props.currency),name:"game[suggested_price]",money_input:true,currency:this.props.currency,has_error:price_error,error_message:price_error?"Please provide an amount greater than the project price":void 0,onKeyUp:function(_this){return function(e){var suggested_price;suggested_price=I.parse_money(e.target.value);return _this.setState({suggested_price:suggested_price})}}(this),placeholder:I.format_money(0,this.props.currency)})):void 0]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,key_counter,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;key_counter=0;P("EditRewards",{propTypes:{currency:types.string.isRequired,has_multi_rewards:types.bool,has_tickets:types.bool,game:types.object.isRequired,rewards:types.array},getInitialState:function(){return{rewards:_.toArray(this.props.rewards)}},componentDidMount:function(){$(ReactDOM.findDOMNode(this)).has_tooltips();return this.dispatch("reward",{update:function(_this){return function(e,idx,field,value,render){console.log("updating reward "+idx+" "+field+" to",value);_this.state.rewards[idx][field]=value;if(render){return _this.forceUpdate()}}}(this),remove:function(_this){return function(e,idx){_this.state.rewards.splice(idx,1);return _this.forceUpdate()}}(this),add_field:function(_this){return function(e,idx){var r;r=_this.state.rewards[idx];r.fields||(r.fields=[]);r.fields.push({});return _this.forceUpdate()}}(this),remove_field:function(_this){return function(e,reward_idx,field_idx){var r;r=_this.state.rewards[reward_idx];r.fields.splice(field_idx,1);return _this.forceUpdate()}}(this),update_field:function(_this){return function(e,reward_idx,field_idx,field,value){var r;r=_this.state.rewards[reward_idx];r.fields[field_idx][field]=value;return _this.forceUpdate()}}(this)})},new_reward:function(){this.state.rewards.push({key:"new-reward-"+(key_counter+=1),title:"",price:""});return this.forceUpdate()},render:function(){return this.enclose({className:"game_edit_rewards",children:[this.render_reward_settings(),this.render_rewards(),div({className:"button_row",children:[button({className:"button new_reward_btn",type:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.new_reward()}}(this)},"New reward"),button({className:"button save_btn"},"Save")]})]})},render_rewards:function(){if(!this.state.rewards.length){return}return[h3({},"Rewards"),div.apply(null,[{className:"reward_list"}].concat(slice.call(this.state.rewards.map(this.render_reward))))]},render_reward:function(reward,idx){return P.RewardEditor({key:reward.id||reward.key,idx:idx,has_multi_rewards:this.props.has_multi_rewards,has_tickets:this.props.has_tickets,reward:reward,game:this.props.game})},render_reward_settings:function(){if(!this.state.rewards.length){return}return div({className:"reward_settings",children:[h3({},"Reward settings"),div({className:"input_row reward_noun",children:[label({children:[div({className:"label"},"Custom noun",span({className:"sub"}," — Give a custom name to your reward program, optional")),input({type:"text",name:"reward_noun",placeholder:"Rewards",defaultValue:this.props.reward_noun})]})]}),div({className:"input_row require_rewards_toggle",children:[label({children:[input({type:"checkbox",name:"reward_required",defaultChecked:this.props.reward_required}),span({className:"label"},"New purchases & downloads require a reward",span({className:"sub"}," — Your project can only be purchased/downloaded by those who claim a reward. Existing purchases and keys are not affected. ",a({className:"forward_link",target:"_blank",href:"/docs/creators/exclusive-content#running-a-limited-release-with-rewards"},"Learn more")))]})]})]})}});P("RewardEditor",{propTypes:{reward:types.object.isRequired,has_multi_rewards:types.bool,has_tickets:types.bool,game:types.object.isRequired,idx:types.number.isRequired},getInitialState:function(){return{collapsed:this.props.reward.archived,allow_multiple:this.props.reward.max_purchase_quantity>1}},input_name:function(){var names;names=1<=arguments.length?slice.call(arguments,0):[];return"rewards["+this.props.idx+"]["+names.join("][")+"]"},update_field:function(field,render){if(render==null){render=true}return function(_this){return function(e){return _this.trigger("reward:update",_this.props.idx,field,e.target.value,render)}}(this)},componentDidMount:function(){I.money_input($(this.refs.price));return I.redactor($(this.refs.description),{minHeight:80})},render:function(){var numberFormat,reward;reward=this.props.reward;numberFormat=_.string.numberFormat;return div({className:classNames("reward_row",{collapsed:this.state.collapsed}),children:[this.state.collapsed?div({className:"collapsed_notification",children:[div({className:"collapsed_message",children:["Archived reward  — ",strong({className:"reward_title"},reward.title),span({className:"claimed_count"}," — Claimed: "+numberFormat(reward.claimed_count))]}),button({type:"button",className:"outline_button",onClick:function(_this){return function(){return _this.setState({collapsed:false})}}(this)},"Open")]}):void 0,this.render_form()]})},render_form:function(){var numberFormat,price_error,quantity_error,reward;reward=this.props.reward;numberFormat=_.string.numberFormat;price_error=reward.price&&this.props.game.min_price>reward.price;quantity_error=reward.amount!=null&&reward.amount<(reward.claimed_count||0);return div({className:"reward_editor_form",children:[reward.id?input({type:"hidden",name:this.input_name("id"),value:reward.id}):void 0,a({href:"javascript:void(0)",className:"remove_button",onClick:function(_this){return function(e){e.preventDefault();if(_this.props.reward.claimed_count>0){_this.trigger("reward:update",_this.props.idx,"archived",true);return _this.setState({collapsed:true})}else{return _this.trigger("reward:remove",_this.props.idx)}}}(this)},this.props.reward.claimed_count>0?"Hide":"Remove"),div({className:"reward_primary_column",children:[label({className:"input_row title_row",children:[div({className:"label"},"Title"),input({type:"text",name:this.input_name("title"),className:"reward_title_input",required:true,value:reward.title,onChange:this.update_field("title")})]}),label({className:"input_row description_row",children:[div({className:"label"},"Description"),textarea({ref:"description",placeholder:"Description",name:this.input_name("description"),className:"reward_description_input",defaultValue:reward.description})]})]}),div({className:"reward_secondary_column",children:[label({className:"input_row",children:[div({className:"label"},"Minimum price"),input({type:"text",name:this.input_name("price"),"data-currency":this.props.currency,ref:"price",className:classNames("reward_price_input",{has_error:price_error}),defaultValue:reward.price,placeholder:I.format_money(0,this.props.currency),onKeyUp:function(_this){return function(e){return _this.trigger("reward:update",_this.props.idx,"price",I.parse_money($(e.target).val()),true)}}(this)}),price_error?div({className:"input_error"},"Must be greater than "+I.format_money(this.props.game.min_price,this.props.currency)):void 0]}),label({className:"input_row",children:[div({className:"label"},"Total quantity"),input({type:"text",className:classNames("amount_input_row",{has_error:quantity_error}),name:this.input_name("amount"),pattern:"\\d+",required:true,value:reward.amount||"",onChange:this.update_field("amount")}),quantity_error?div({className:"input_error"},"Quantity must be greater or equal to amount already claimed"):void 0]}),reward.id!=null?label({className:"input_row",title:"No new purchases can claim this reward",children:[input({type:"checkbox",name:this.input_name("archived"),checked:!!reward.archived,onChange:function(_this){return function(e){return _this.trigger("reward:update",_this.props.idx,"archived",e.target.checked,true)}}(this)}),span({className:"label"},"Archived")]}):void 0,this.props.has_tickets&&label({className:"input_row",children:[div({className:"label"},"Reward type"),select({name:this.input_name("type"),value:reward.type,disabled:reward.claimed_count>0,onChange:function(_this){return function(e){return _this.trigger("reward:update",_this.props.idx,"type",e.target.value,true)}}(this),children:[option({value:"default"},"Default"),option({value:"ticket"},"Ticket")]})]}),this.props.has_multi_rewards&&label({className:"input_row",children:[input({type:"checkbox",checked:this.state.allow_multiple,onChange:function(_this){return function(e){return _this.setState({allow_multiple:e.target.checked})}}(this)}),span({className:"label"},"Allow buying more than one")]}),this.props.has_multi_rewards&&this.state.allow_multiple&&label({className:"input_row",children:[div({className:"label"},"Max quantity per purchase"),input({type:"number",name:this.input_name("max_purchase_quantity"),min:1,max:10,value:reward.max_purchase_quantity,onChange:function(_this){return function(e){var max,min,value;value=parseInt(e.target.value,10);min=parseInt(e.target.min,10);max=parseInt(e.target.max,10);if(value<min){value=min}if(value>max){value=max}return _this.trigger("reward:update",_this.props.idx,"max_purchase_quantity",value,true)}}(this)})]}),this.render_fields_editor(),reward.claimed_count!=null?div({className:"input_row",children:[div({className:"label"},"Amount claimed"),div({className:"claimed_count"},""+numberFormat(reward.claimed_count))]}):void 0]})]})},render_field:function(field,idx){var prefix,update_field;prefix=this.input_name("fields",""+(idx+1));update_field=function(_this){return function(name){return function(e){var value;value=e.target.value;return _this.trigger("reward:update_field",_this.props.idx,idx,name,value)}}}(this);return div({className:"reward_field",children:[field.id!=null?input({type:"hidden",name:prefix+"[id]",value:field.id}):void 0,div({className:"field_header",children:[select({name:prefix+"[type]",className:"field_type_input",value:field.type||"text",onChange:update_field("type"),children:[option({value:"text"},"Single-line text"),option({value:"text_multi"},"Multi-line text"),option({value:"single_choice"},"Single choice"),option({value:"address"},"Address")]}),button({className:"remove_field_button",type:"button",title:"Remove reward","data-tooltip":"Remove field",onClick:function(_this){return function(e){if(field.filled_count){if(!confirm("Because people have already filled out this field it will be archived instead of deleted")){return}}$(e.target).trigger("i:hide_tooltip");e.preventDefault();return _this.trigger("reward:remove_field",_this.props.idx,idx)}}(this)},"×")]}),R.Forms.TextInputRow({title:"Field name",required:true,name:prefix+"[name]",required:true,placeholder:"required",value:field.name||"",onChange:update_field("name")}),function(){switch(field.type){case"single_choice":return R.Forms.TextInputRow({title:"Choices",sub:"separate by commas",name:prefix+"[choices]",required:true,placeholder:"required",value:field.choices||"",onChange:update_field("choices")});case"ticket":return label({className:"input_row",children:[input({type:"checkbox"}),span({className:"label"},"Ask for usual name")]})}}()]})},render_fields_editor:function(){var ref1,ref2;return div({className:"fields_editor",children:[((ref1=this.props.reward.fields)!=null?ref1.length:void 0)?div({className:"fields_list",children:(ref2=this.props.reward.fields)!=null?ref2.map(this.render_field):void 0}):void 0,div({},button({type:"button",className:"button small new_field_btn",onClick:function(_this){return function(){return _this.trigger("reward:add_field",_this.props.idx)}}(this)},"New field"))]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;P("EditTools",{propTypes:{tool_tags_url:types.string.isRequired,tools:types.oneOfType([types.array,types.object]),tool_tags:types.oneOfType([types.array,types.object]),selected_tools:types.oneOfType([types.array,types.object]),feedback_url:types.string},getInitialState:function(){var id,out,ref1,tool;out={selected_tools:_.toArray(this.props.selected_tools),loading_tools:{},loading_count:0,loaded_tools:{}};if(this.props.preloaded_tool_tags){ref1=this.props.preloaded_tool_tags;for(id in ref1){tool=ref1[id];out.loading_tools[id]=$.when(tool);out.loaded_tools[id]=tool}}return out},componentDidUpdate:function(){return this.load_selected_tools()},load_selected_tools:function(){var i,id,len,ref1,results;ref1=this.state.selected_tools;results=[];for(i=0,len=ref1.length;i<len;i++){id=ref1[i];results.push(this.get_tool_tags(id))}return results},find_tool:function(id){var i,len,ref1,tool;ref1=this.props.tools;for(i=0,len=ref1.length;i<len;i++){tool=ref1[i];if(tool.id===id){return tool}}},get_tool_tags:function(tool_id){var cache;cache=this.state.loading_tools;if(cache[tool_id]){return cache[tool_id]}this.setState({loading_count:this.state.loading_count+1});cache[tool_id]=$.ajax({url:this.props.tool_tags_url.replace(/:tool_id\b/,tool_id),dataType:"json"}).done(function(_this){return function(res){_this.state.loaded_tools[res.id]=res;return _this.setState({loading_count:_this.state.loading_count-1})}}(this));return this.setState({loading_tools:cache})},componentDidMount:function(){var el;this.load_selected_tools();el=$(this.refs.tool_selector_input.refs.input);return el.selectize({delimiter:",",plugins:["remove_button"],closeAfterSelect:true,valueField:"id",labelField:"name",searchField:["name"],options:this.props.tools,onChange:function(_this){return function(){var id;return _this.setState({selected_tools:function(){var i,len,ref1,results;ref1=el[0].selectize.items;results=[];for(i=0,len=ref1.length;i<len;i++){id=ref1[i];results.push(+id)}return results}()})}}(this)})},render:function(){var loading;loading=this.state.loading_count>0;return this.enclose({className:"tool_picker"},form({className:"form",method:"post",children:[R.CSRF({}),R.Forms.TextInputRow({ref:"tool_selector_input",title:"Engines & tools",sub:this.props.explanation,name:"tools",placeholder:"Click to view options, type to filter",defaultValue:this.state.selected_tools.join(",")}),p({},"Are we missing an option? Please help our database: ",a({target:"_blank",href:this.props.tool_suggestion_url},"suggest new tool, engine, or device")),this.render_tool_options(),div({className:"button_row",children:[button({className:classNames("button",{disabled:loading}),disabled:loading},"Save"),loading?div({className:"loader"}):void 0]})]}))},render_tool_options:function(){if(!this.state.selected_tools.length){return}return div({className:"tool_option_list"},this.state.selected_tools.map(function(_this){return function(tool_id){var ref1,selected_tags,tool_options;selected_tags=_.toArray(_this.props.tool_tags).filter(function(t){return t.tool_id===tool_id});tool_options=_this.state.loaded_tools[tool_id];if(!(tool_options!=null?(ref1=tool_options.groups)!=null?ref1.length:void 0:void 0)){return}return R.GameEdit.EditToolOptions({tool:tool_options,key:tool_id,feedback_url:_this.props.feedback_url,selected_tags:selected_tags})}}(this)))}});P("EditToolOptions",{propTypes:{tool:types.object.isRequired,selected_tags:types.array},componentDidMount:function(){var container,el,g,group,group_id,groups_by_id,i,j,len,len1,ref1,ref2,results;groups_by_id={};ref1=this.props.tool.groups;for(i=0,len=ref1.length;i<len;i++){g=ref1[i];groups_by_id[g.id]=g}container=$(ReactDOM.findDOMNode(this));ref2=container.find(".multi_input");results=[];for(j=0,len1=ref2.length;j<len1;j++){el=ref2[j];el=$(el);group_id=+el.data("group_id");group=groups_by_id[group_id];if(!group){continue}results.push(function(el,group){return el.selectize({delimiter:",",plugins:["remove_button"],closeAfterSelect:true,valueField:"id",labelField:"name",searchField:["name"],options:group.tags})}(el,group))}return results},render:function(){return this.enclose({className:"tool",children:[h3({},this.props.tool.name),div({className:"tool_tag_groups",children:this.props.tool.groups.map(function(_this){return function(group){var selected;selected=_this.props.selected_tags.filter(function(t){return t.tool_tag_group_id===group.id});return div({className:"tool_tag_group input_row",children:[label({children:[div({className:"group_title label"},group.name),function(){switch(group.type){case"multi":return this.render_multi(group,selected);case"single":return this.render_single(group,selected)}}.call(_this)]})]})}}(this))}),this.props.feedback_url?div({className:"missing_something",children:["Don't see something that should be here? ",a({href:"javascript:void(0)",onClick:function(_this){return function(e){var url;url=_this.props.feedback_url+"?"+$.param({url:window.location.href,type:"tool",tool_id:_this.props.tool.id});I.Lightbox.open_remote(url,I.FeedbackLightbox);return e.preventDefault()}}(this)},"Tell us")]}):void 0]})},input_name:function(group){return"tool_group_taggings["+group.id+"]"},render_single:function(group,selected){var options,ref1;options=group.tags.map(function(_this){return function(option){return[option.id,option.name]}}(this));options.unshift(["",""]);return R.Forms.Select({name:this.input_name(group),defaultValue:(ref1=selected[0])!=null?ref1.tool_tag_id:void 0,selectize:{placeholder:"Select one, backspace to clear"},options:options})},render_multi:function(group,selected){var s,value;value=function(){var i,len,results;results=[];for(i=0,len=selected.length;i<len;i++){s=selected[i];results.push(s.tool_tag_id)}return results}().join(",");return input({type:"text",className:"multi_input","data-group_id":group.id,name:this.input_name(group),defaultValue:value,placeholder:"Select all that apply"})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,key_counter,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;key_counter=0;P("UploadList",{propTypes:{uploads:types.array.isRequired,game_min_price:types.number,disable_payments:types.bool,currency:types.string.isRequired,money_placeholder:types.string.isRequired},componentDidMount:function(){this.dispatch("upload",{move_up:function(_this){return function(e,idx){var old,uploads;uploads=_this.props.uploads;old=uploads[idx-1];uploads[idx-1]=uploads[idx];uploads[idx]=old;return _this.forceUpdate()}}(this),move_down:function(_this){return function(e,idx){var old,uploads;uploads=_this.props.uploads;old=uploads[idx+1];uploads[idx+1]=uploads[idx];uploads[idx]=old;return _this.forceUpdate()}}(this),delete:function(_this){return function(e,idx){var file_upload;file_upload=_this.props.uploads[idx];if(confirm("Are you sure you want to delete "+(file_upload.upload.filename||"this file")+"?")){return file_upload.delete_upload()}}}(this),update_upload:function(_this){return function(e,upload,field,value){var file,i,len,ref1,update,updated_file;updated_file=false;ref1=_this.props.uploads;for(i=0,len=ref1.length;i<len;i++){file=ref1[i];if(file.upload!==upload){continue}update={};update[field]=value;file.upload=$.extend({},upload,update);updated_file=file;break}if(!updated_file){console.error("failed to update upload",upload);return}if(field==="embed"&&value){_this.clear_other_embeds(updated_file)}_this.forceUpdate();return _this.trigger("game:update_upload",updated_file)}}(this),open_channel:function(_this){return function(e,upload){var lightbox_data;lightbox_data={channel_name:upload.channel_name,game:{id:_this.props.game_id}};return I.Lightbox.open_remote(upload.channel_lightbox_url,I.DashboardGameChannelLightbox,lightbox_data)}}(this)});return document.addEventListener("DOMContentLoaded",function(_this){return function(){var i,len,ref1,results,upload;ref1=_this.props.uploads;results=[];for(i=0,len=ref1.length;i<len;i++){upload=ref1[i];if(upload.upload.open_lightbox){_this.trigger("upload:open_channel",upload.upload);break}else{results.push(void 0)}}return results}}(this))},clear_other_embeds:function(current_file){var file,i,len,ref1,results,upload_idx;ref1=this.props.uploads;results=[];for(upload_idx=i=0,len=ref1.length;i<len;upload_idx=++i){file=ref1[upload_idx];if(file===current_file){continue}results.push(file.upload=$.extend({},file.upload,{embed:false}))}return results},render:function(){var upload_in_progress,uploaders;upload_in_progress=false;uploaders=this.props.uploads.map(function(_this){return function(upload,idx){upload._react_id||(upload._react_id="key-"+key_counter++);if(upload.state==="uploading"){upload_in_progress=true}return P.Uploader(_this.extend_props({key:upload._react_id,idx:idx,upload:upload.upload,progress_percent:upload.progress_percent,state:upload.state,can_embed:upload.valid_for_embed()}))}}(this));return this.enclose({children:[div({className:classNames("file_list",{has_files:this.props.uploads.length>0}),children:uploaders}),upload_in_progress?div({className:"uploading_message"},div({className:"loader"}),"Do not close this page while uploads are in progress"):void 0]})}});P("Uploader",{pure:true,propTypes:{currency:types.string.isRequired,money_placeholder:types.string.isRequired,can_embed:types.bool,state:types.oneOf(["uploading","ready","failed"]).isRequired,idx:types.number.isRequired,progress_percent:types.number,upload:types.shape({id:types.number,position:types.number,filename:types.string}).isRequired},getInitialState:function(){return{min_price_enabled:this.props.upload.min_price&&this.props.upload.min_price>0}},componentDidMount:function(){if(this.props.upload.just_created){delete this.props.upload.just_created;return this.setState({edit_display_name:true})}},input_name:function(name){if(!this.props.upload){return}return"upload["+this.props.upload.id+"]["+name+"]"},update_upload:function(field,value){return this.trigger("upload:update_upload",this.props.upload,field,value)},render:function(){switch(this.props.state){case"ready":return this.render_ready();case"failed":return this.render_failed();case"uploading":return this.render_uploading()}},render_uploading:function(){var truncate,upload;upload=this.props.upload;truncate=_.string.truncate;return div({className:"uploader is_uploading",children:[div({className:"upload_content",children:[div({className:"upload_title",children:[upload.external?span({className:"progress_message"},"Creating"):[strong({className:"upload_display_name"},truncate(upload.display_name||upload.filename,80)),span({className:"progress_message"}," · Uploading")]]}),div({className:"progress"},div({className:"progress_inner",style:{right:100-this.props.progress_percent+"%"}}))]})]})},render_failed:function(){return div({className:"uploader",children:[div({className:"upload_content",children:[div({className:"error_message",children:["There was a problem completing your upload. Try again. If the problem persists ",a({target:"_blank",href:"/support"},"contact support"),"."]})]})]})},render_ready:function(){var classes,numberFormat,ref1,truncate,upload;ref1=_.string,truncate=ref1.truncate,numberFormat=ref1.numberFormat;upload=this.props.upload;classes=classNames("uploader",{is_hidden:this.props.upload.hidden,is_embed:this.props.can_embed&&this.props.upload.embed,is_demo:this.props.upload.demo,is_preorder:this.props.upload.preorder,is_external:this.props.upload.external,delete_hover:this.state.hover_delete});return div({className:classes,children:[input({type:"hidden",name:this.input_name("position"),value:this.props.idx}),input({type:"hidden",name:this.input_name("description"),value:upload.description}),a({href:"javascript:void(0)",className:"delete_btn",onMouseEnter:function(_this){return function(){return _this.setState({hover_delete:true})}}(this),onMouseLeave:function(_this){return function(){return _this.setState({hover_delete:false})}}(this),onClick:function(_this){return function(){return _this.trigger("upload:delete",_this.props.idx)}}(this)},"Delete file"),div({className:"upload_content",children:[div({className:"upload_title",children:[input({name:this.input_name("display_name"),type:"hidden",value:upload.display_name||""}),this.state.edit_display_name?P.InlineEdit({initial_value:upload.display_name||upload.filename||"",placeholder:"Enter a display name",finished:function(_this){return function(value){_this.setState({edit_display_name:false});if(value.match(/^\s*$/)){value=null}if(value===upload.filename){value=null}return _this.update_upload("display_name",value)}}(this)}):[strong({className:"upload_display_name"},truncate(upload.display_name||upload.filename,80)),this.props.just_uploaded?span({className:"success_message"}," · Success"):void 0,upload.display_name?div({className:"upload_fname"},truncate(upload.filename,80)):void 0]]}),this.render_meta_data(),upload.uploaded_at||upload.downloads?div({className:"upload_stats",children:[!(this.props.can_embed&&upload.embed)&&upload.downloads!=null?[numberFormat(upload.downloads)+" Download"+(upload.downloads===1&&""||"s"),upload.uploaded_at?", ":void 0]:void 0,upload.uploaded_at?span({title:upload.uploaded_at+" UTC"},moment.utc(upload.uploaded_at).local().calendar()):void 0]}):void 0,div({className:"upload_type"},this.render_type_picker(),this.render_platform_picker(),this.render_channel()),this.render_external_url_row(),this.render_price_picker(),this.render_demo_toggle(),this.render_preorder_toggle(),this.render_embed_toggle(),this.render_hidden_toggle()]})]})},render_external_url_row:function(){if(!this.props.upload.external){return false}return div({className:"external_url_row"},input({type:"text",defaultValue:this.props.upload.url||"",className:"external_url_input",name:this.input_name("url"),placeholder:"http://",required:"required"}))},render_meta_data:function(){var formatBytes,numberFormat,ref1,upload;ref1=_.string,formatBytes=ref1.formatBytes,numberFormat=ref1.numberFormat;upload=this.props.upload;return div({className:"meta_data",children:[upload.external?span({className:"external_label"},"External file"):span({className:"file_size"},formatBytes(upload.size)),span({className:"display_name_wrap",children:[" · ",a({href:"javascript:void(0)",className:"set_display_name_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.setState({edit_display_name:!_this.state.edit_display_name})}}(this)},"Change display name")]}),span({className:"move_up_wrap",children:[" · ",a({href:"javascript:void(0)",className:"move_up_btn",onClick:function(_this){return function(){return _this.trigger("upload:move_up",_this.props.idx)}}(this)},"Move up")]}),span({className:"move_down_wrap",children:[" · ",a({href:"javascript:void(0)",className:"move_down_btn",onClick:function(_this){return function(){return _this.trigger("upload:move_down",_this.props.idx)}}(this)},"Move down")]})]})},render_type_picker:function(){var can_embed,ref1,upload;ref1=this.props,upload=ref1.upload,can_embed=ref1.can_embed;if(can_embed&&upload.embed){return}return R.Forms.SimpleSelect({name:this.input_name("type"),value:this.props.upload.type||"default",onChange:function(_this){return function(type){return _this.update_upload("type",type)}}(this),options:[{name:"Executable",value:"default"},{name:"Soundtrack",value:"soundtrack"},{name:"Source code",value:"sourcecode"},{name:"Book",value:"book"},{name:"Video",value:"video"},{name:"Documentation",value:"documentation"},{name:"Mod",value:"mod"},{name:"Graphical assets",value:"graphical_assets"},{name:"Audio assets",value:"audio_assets"},{name:"Other",value:"other"}]})},render_channel:function(){if(!this.props.upload.channel_name){return}return a({href:"javascript:void(0)",title:"Channel: "+this.props.upload.channel_name,className:"channel_link open_channel_btn",onClick:function(_this){return function(){return _this.trigger("upload:open_channel",_this.props.upload)}}(this),children:[span({className:"icon icon-upload"}),this.props.upload.channel_name]})},render_platform_picker:function(){var can_embed,ref1,upload;ref1=this.props,upload=ref1.upload,can_embed=ref1.can_embed;if(can_embed&&upload.embed){return}if(!(this.props.upload.type==="default"||!this.props.upload.type)){return}return div({className:"platform_list"},span({className:"platforms_for"}," for "),[["p_windows","windows8","Download for Windows"],["p_linux","tux","Download for Linux"],["p_osx","apple","Download for Mac OS X"],["p_android","android","Download for Android"]].map(function(_this){return function(arg){var classes,field,icon,title;field=arg[0],icon=arg[1],title=arg[2];classes=classNames({platform_picker:true,chosen:_this.props.upload[field]});return label({key:field,className:classes,children:[input({name:_this.input_name(field),"data-name":field,type:"checkbox",className:"checkbox",checked:_this.props.upload[field]||false,onChange:function(){return _this.update_upload(field,!_this.props.upload[field])}}),span({title:title,className:"icon icon-"+icon})]})}}(this)))},render_price_picker:function(){var default_value,has_price_error,min_price,ref1;if(this.props.can_embed&&this.props.upload.embed){return false}if(this.props.upload.demo){return false}if(this.props.disable_payments){return false}has_price_error=this.props.upload.min_price&&this.props.upload.min_price<=this.props.game_min_price;return div({className:"upload_price_picker",children:[div({className:"min_price_toggle"},label({children:[input({type:"checkbox",className:"checkbox min_price_toggle_input",checked:this.state.min_price_enabled||false,onChange:function(_this){return function(){return _this.setState({min_price_enabled:!_this.state.min_price_enabled})}}(this)}),"Set a different price for this file"]})),this.state.min_price_enabled?(min_price=(ref1=this.props.upload.min_price)!=null?ref1:0,default_value=I.format_money(min_price,this.props.currency),div({className:"min_price_input_row input_row"},label({children:[div({className:"label"},"Minimum Price"),p({className:"sub"},"The minimum price for a file should be greater than the minimum price for the entire project. You should only set this if the file's minimum price is different than the project's."),P.MoneyInput({"data-currency":this.props.currency,name:this.input_name("min_price"),placeholder:this.props.money_placeholder,className:classNames("file_min_price",{has_error:has_price_error}),defaultValue:default_value,onKeyUp:function(_this){return function(e){return _this.update_upload("min_price",I.parse_money($(e.target).val()))}}(this)}),has_price_error?span({className:"price_error"},"Should be greater than the project's minimum price"):void 0]}))):void 0]})},render_field_toggle:function(opts){var classes;if(!opts.field){throw"missing field"}classes=classNames("upload_field_toggle",opts.className);return div({className:classes},label({children:[input({name:this.input_name(opts.field),type:"checkbox","data-field":opts.field,className:"checkbox",checked:this.props.upload[opts.field]||false,onChange:function(_this){return function(){return _this.update_upload(opts.field,!_this.props.upload[opts.field])}}(this)}),opts.label]}))},render_demo_toggle:function(){if(this.props.upload.hidden){return false}if(this.props.can_embed&&this.props.upload.embed){return false}if(this.props.game_min_price===0){return false}if(this.props.disable_payments){return false}return this.render_field_toggle({field:"demo",label:"This file is a demo and can be downloaded for free"})},render_preorder_toggle:function(){if(this.props.upload.hidden){return false}if(this.props.can_embed&&this.props.upload.embed){return false}if(this.props.upload.demo){return false}if(this.props.upload.external){return false}if(this.props.game_min_price===0){return false}if(this.props.disable_payments){return false}return this.render_field_toggle({field:"preorder",label:"This file is a pre-order placeholder"})},render_embed_toggle:function(){if(this.props.upload.hidden){return false}if(this.props.upload.demo){return false}if(this.props.upload.external){return false}if(!this.props.can_embed){return false}return this.render_field_toggle({field:"embed",label:"This file will be played in the browser"})},render_hidden_toggle:function(){if(this.props.upload.embed){return false}return this.render_field_toggle({field:"hidden",label:"Hide this file and prevent it from being downloaded"})}});P("InlineEdit",{propTypes:{initial_value:types.string.isRequired,placeholder:types.string,finished:types.func},componentDidMount:function(){var click_handler,el;el=$(ReactDOM.findDOMNode(this));el.focus().select();click_handler=function(_this){return function(e){var base,inside;if(_this.isMounted()){inside=$(e.target).closest(el).length;if(inside){return}if(typeof(base=_this.props).finished==="function"){base.finished(_this.value())}}return $(document.body).off("click",click_handler)}}(this);return $(document.body).on("click",click_handler)},value:function(){return $(ReactDOM.findDOMNode(this)).val()},render:function(){return input({type:"text",className:"inline_edit_input",placeholder:this.props.placeholder,defaultValue:this.props.initial_value,onKeyDown:function(_this){return function(e){var base,base1;switch(e.keyCode){case 9:return _.defer(function(){var base;return typeof(base=_this.props).finished==="function"?base.finished(_this.value()):void 0});case 13:e.preventDefault();return typeof(base=_this.props).finished==="function"?base.finished(_this.value()):void 0;case 27:e.preventDefault();return typeof(base1=_this.props).finished==="function"?base1.finished(_this.props.initial_value):void 0}}}(this)})}});P("MoneyInput",{componentDidMount:function(){var el;el=$(ReactDOM.findDOMNode(this));return I.money_input(el)},render:function(){return input($.extend({type:"text",ref:"input"},this.props))}})}).call(this);(function(){var COLOR_FIELDS,P,SIZES,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;SIZES={rectangle:{width:552,height:167},square:{width:208,height:167}};COLOR_FIELDS=[["Background color","bg_color"],["Text color","fg_color"],["Button color","link_color"],["Border color","border_color"]];P("RenderMarkup",{getInitialState:function(){return{}},componentDidUpdate:function(){return this.updateHTML()},componentDidMount:function(){return this.updateHTML()},updateHTML:function(){var el;el=document.createElement("div");return ReactDOM.render(div({ref:function(_this){return function(container){var base,html;html=container.innerHTML;if(_this.state.html!==html){_this.setState({html:html});return typeof(base=_this.props).on_html==="function"?base.on_html(html):void 0}}}(this)},this.props.children),el)},render:function(){return React.createElement("script",{type:"text/render"})}});P("Widget",{propTypes:{widget_url:types.string,default_style:types.object,dark_style:types.object},getInitialState:function(){return{border_width:1}},render:function(){return this.enclose({className:"edit_widget",children:[p({},"Customize the widget below, then paste the code into a website where you'd like to embed it."),h3({},"Preview"),div({className:"preview"},this.render_widget(true,false)),form({className:"form",children:[this.render_check_options([{label:"Square",name:"square"},!this.state.square?{label:"Include link to itch.io page",name:"linkback"}:void 0]),div({className:"style_group"},this.render_presets(),this.render_color_options(),this.render_border_option()),div({className:"widget_code"},label({children:[div({className:"label"},"Code"),textarea({readOnly:true,ref:function(_this){return function(code_el){_this.code_el=code_el}}(this),onClick:function(_this){return function(e){return e.target.select()}}(this)}),P.RenderMarkup({children:this.render_widget(false),on_html:function(_this){return function(html){if(_this.code_el){return _this.code_el.value=html}}}(this)})]}))]}),div({className:"embed_directions"},strong({},"Directions:")," Copy and paste this HTML into your website where you want the widget to appear.")]})},render_check_options:function(options){return div({className:"input_row widget_options"},div({className:"label"},"Options"),ul({className:"check_list"},options.map(function(_this){return function(opt,idx){if(!opt){return}return li({key:opt.name},label({children:[input({type:"checkbox",checked:!!_this.state[opt.name],onChange:function(e){var u;u={};u[opt.name]=e.target.checked;return _this.setState(u)}}),opt.label,opt.sub?span({className:"sub"}," — "+opt.sub):void 0]}))}}(this))))},is_dark_style:function(){var _,i,len,name,ref1;if(!this.props.dark_style){return}for(i=0,len=COLOR_FIELDS.length;i<len;i++){ref1=COLOR_FIELDS[i],_=ref1[0],name=ref1[1];if(this.state[name]!==this.props.dark_style[name]){return false}}return true},render_widget:function(primary_widget,with_colors){var _,c,field,i,len,ref1,size,url,url_params;if(primary_widget==null){primary_widget=true}if(with_colors==null){with_colors=true}url=this.props.widget_url;url_params={};if(this.state.linkback){url_params.linkback="true"}if(with_colors){if(this.state.border_width!==1){url_params.border_width=this.state.border_width}if(this.is_dark_style()){url_params.dark="true"}else{for(i=0,len=COLOR_FIELDS.length;i<len;i++){ref1=COLOR_FIELDS[i],_=ref1[0],field=ref1[1];c=this.state[field];if(!c){continue}url_params[field]=c.replace(/^#/,"")}}}if(!$.isEmptyObject(url_params)){url=url+="?"+$.param(url_params)}size=this.state.square?SIZES.square:SIZES.rectangle;return iframe({ref:primary_widget?"iframe":void 0,frameBorder:"0",src:url,width:size.width+(this.state.border_width-1)*2,height:size.height+(this.state.border_width-1)*2,onLoad:primary_widget?function(_this){return function(){return _this.refresh_style()}}(this):void 0})},refresh_style:function(){var ref1,ref2,w;w=this.refs.iframe.contentWindow;if(!w){return}return(ref1=w.I)!=null?(ref2=ref1.embed)!=null?typeof ref2.set_style==="function"?ref2.set_style(this.state):void 0:void 0:void 0},render_color_options:function(){return div({className:"color_options",children:COLOR_FIELDS.map(function(_this){return function(arg){var key,name,value;name=arg[0],key=arg[1];value=_this.state[key]||_this.props.default_style[key];return div({key:key,className:"color_column"},label({children:[div({className:"label"},name),R.Forms.ColorInput({name:key,value:value,onChange:function(color){if(color===_this.props.default_style[key]){delete _this.state[key]}else{_this.state[key]=color}return _this.forceUpdate(_this.refresh_style)}})]}))}}(this))})},render_border_option:function(){return div({className:"input_row border_option",children:[label({children:[div({className:"label"},"Border size"),R.Forms.Slider({min:0,max:5,value:this.state.border_width,onChange:function(_this){return function(width){return _this.setState({border_width:width},_this.refresh_style)}}(this)}),span({className:"border_value"},this.state.border_width+"px")]})]})},set_preset:function(t){var _,i,j,len,len1,name,ref1,ref2,u;if(t){u={};for(i=0,len=COLOR_FIELDS.length;i<len;i++){ref1=COLOR_FIELDS[i],_=ref1[0],name=ref1[1];u[name]=t[name]}return this.setState(u)}else{for(j=0,len1=COLOR_FIELDS.length;j<len1;j++){ref2=COLOR_FIELDS[j],_=ref2[0],name=ref2[1];delete this.state[name]}return this.forceUpdate()}},render_presets:function(){return div({className:"style_presets",children:[div({className:"label"},"Preset: "),button({type:"button",className:"button small",onClick:function(_this){return function(){return _this.set_preset(null)}}(this)},"Default"),button({type:"button",className:"button small",onClick:function(_this){return function(){return _this.set_preset(_this.props.dark_style)}}(this)},"Dark"),this.props.game_style?button({type:"button",className:"button small",onClick:function(_this){return function(){return _this.set_preset(_this.props.game_style)}}(this)},"Your page style"):void 0]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("EditSale");types=React.PropTypes;P("SaleConditions",{propTypes:{games:types.array.isRequired,selected_games:types.array.isRequired,sale_triggers:types.array.isRequired},getInitialState:function(){var by_id,game,j,len,ref1;by_id={};ref1=this.props.games;for(j=0,len=ref1.length;j<len;j++){game=ref1[j];by_id[game.id]=game}return{trigger_games:this.props.sale_triggers.map(function(_this){return function(t){return by_id[t.game_id]}}(this))}},componentDidMount:function(){return this.dispatch({add_trigger:function(_this){return function(e){var game;game=_this.available_for_selection()[0];if(!game){return}return _this.setState({trigger_games:_this.state.trigger_games.concat([game])})}}(this),remove_trigger:function(_this){return function(e,idx){var g,gi;return _this.setState({trigger_games:function(){var j,len,ref1,results;ref1=this.state.trigger_games;results=[];for(gi=j=0,len=ref1.length;j<len;gi=++j){g=ref1[gi];if(gi!==idx){results.push(g)}}return results}.call(_this)})}}(this)})},available_games:function(){var g,j,k,len,len1,ref1,ref2,results,taken_games;taken_games={};ref1=this.props.selected_games;for(j=0,len=ref1.length;j<len;j++){g=ref1[j];taken_games[g.id]=true}ref2=this.props.games;results=[];for(k=0,len1=ref2.length;k<len1;k++){g=ref2[k];if(g.paid_status>1&&!taken_games[g.id]){results.push(g)}}return results},render:function(){var games;games=this.available_games();return div({className:"sale_conditions",children:[h2({},"Sale conditions"),p({},"You can restrict who has access to this sale based on their purchase history."),games.length?this.render_trigger_picker():p({},"You don't have any available games to create a condition.")]})},render_trigger_picker:function(){var available_games;available_games=this.available_games();return[div({className:"condition_rows"},this.state.trigger_games.map(function(_this){return function(game,idx){var game_picker;game_picker=_this.available_games_select(game.id,idx);if(!game_picker){return}return div({key:idx,className:"condition_row",children:["Must own ",game_picker,button({type:"button",className:"button small",onClick:function(e){return _this.trigger("remove_trigger",idx)}},"Remove condition")]})}}(this))),this.available_for_selection().length?div({className:"button_row"},button({type:"button",className:"button",onClick:function(_this){return function(){return _this.trigger("add_trigger")}}(this)},"Add condition")):void 0]},available_for_selection:function(current_id){return this.available_games().filter(function(_this){return function(g){if(g.id===current_id){return true}return!_this.state.trigger_games.some(function(tg){return tg.id===g.id})}}(this))},available_games_select:function(chosen_game_id,idx){var games;games=this.available_for_selection(chosen_game_id);if(chosen_game_id){if(!games.some(function(_this){return function(g){return g.id===chosen_game_id}}(this))){return}}return R.Forms.SimpleSelect({value:chosen_game_id,name:"sale_triggers["+(idx+1)+"]",onChange:function(_this){return function(game_id){var g,j,len,ref1,results,trigger_games;game_id=+game_id;ref1=_this.props.games;results=[];for(j=0,len=ref1.length;j<len;j++){g=ref1[j];if(g.id===game_id){trigger_games=slice.call(_this.state.trigger_games);trigger_games[idx]=g;results.push(_this.setState({trigger_games:trigger_games}))}else{results.push(void 0)}}return results}}(this),options:games.map(function(_this){return function(game,idx){return{value:game.id,name:game.title}}}(this))})}});P("BundlePrice",{propTypes:{rate:types.number,bundle_price:types.number,selected_games:types.array.isRequired,suggested_price:types.number,currency:types.string},getInitialState:function(){return{custom_price:!!this.props.bundle_price}},can_bundle:function(){var game,paid_games;paid_games=function(){var j,len,ref1,results;ref1=this.props.selected_games;results=[];for(j=0,len=ref1.length;j<len;j++){game=ref1[j];if(game.paid_status>1){results.push(game)}}return results}.call(this);return(this.props.rate||0)<100&&paid_games.length>1},render:function(){return div({className:"input_row bundle_input_row",children:[h2({},"Bundle"),this.can_bundle()?this.render_bundle_settings():p({},"If your sale has at least two projects and a rate less than 100% it can be bought as a bundle.")]})},render_bundle_settings:function(){var default_value,suggested_price;suggested_price=I.format_money(this.props.suggested_price,this.props.currency);default_value=this.props.bundle_price||this.props.suggested_price;return[p({children:["Because you've selected multiple paid projects, your sale will also be available as a bundle for ",strong({},suggested_price)," or more. (Sum of all items with rate applied)"]}),div({className:"custom_bundle_price_toggle"},label({children:[input({type:"checkbox",checked:this.state.custom_price,name:"sale[allow_bundle]",onChange:function(_this){return function(e){return _this.setState({custom_price:e.target.checked})}}(this)}),"Provide a custom bundle price"]})),this.state.custom_price?R.Forms.TextInputRow({title:"Bundle price",sub:"Minimum price to buy all items in sale at once",money_input:true,currency:this.props.currency,name:"sale[bundle_price]",class:"medium_input bundle_price_input money_input",placeholder:I.format_money(0,this.props.currency),defaultValue:default_value?I.format_money(default_value,this.props.currency):void 0}):void 0]}});P("RatePicker",{propTypes:{set_rate:types.func,rate:types.number,allow_promotion_claim:types.bool},componentDidMount:function(){var base,slider;slider=$(this.refs.rate_slider).slider({range:"min",min:0,value:this.state.rate,max:100,slide:function(_this){return function(e,ui){var base,rate;rate=parseInt(ui.value,10);_this.setState({rate:rate});return typeof(base=_this.props).set_rate==="function"?base.set_rate(rate,_this.state.reverse):void 0}}(this)});return typeof(base=this.props).set_rate==="function"?base.set_rate(this.state.rate,this.state.reverse):void 0},getInitialState:function(){var ref1;return{rate:Math.abs((ref1=this.props.rate)!=null?ref1:50),reverse:this.props.rate?this.props.rate<0:false}},render_rate_picker:function(){return div({className:"input_row rate_row",children:[div({className:"label",children:["Rate",span({className:"sub"}," — What percentage "+(this.state.reverse&&"increase"||"off")+" is this sale?")]}),div({className:"inner_toggle"},label({children:[input({type:"checkbox",name:"sale[reverse_rate]",checked:this.state.reverse,onChange:function(_this){return function(e){var base;_this.setState({reverse:e.target.checked});return typeof(base=_this.props).set_rate==="function"?base.set_rate(_this.state.rate,e.target.checked):void 0}}(this)}),"Reverse sale",span({className:"sub"}," — Make your projects more expensive!")]})),div({className:"slider_row",children:[div({className:"rate_slider_outer",children:[div({className:"rate_slider",ref:"rate_slider"}),input({type:"hidden",name:"sale[rate]",className:"rate_slider_input",value:this.state.rate})]}),span({className:"rate_value"},this.state.rate+"%"),span({className:"sub",children:[this.state.reverse?" increased minimum prices":" off all minimum prices"]})]})]})},render_rate_settings:function(){var ref1;if(!(this.state.rate===100&&!this.state.reverse)){return}return div({className:"input_row"},div({className:"label"},"Additional settings"),ul({className:"check_list"},li({},label({children:[input({type:"checkbox",defaultChecked:(ref1=this.props.allow_promotion_claim)!=null?ref1:true,name:"sale[allow_promotion_claim]"}),"Allow items to be claimed",span({className:"sub"}," — People can permanently claim a free copy while the sale is active")]}))))},render:function(){return div({className:"rate_picker"},this.render_rate_picker(),this.render_rate_settings())}});P("CouponSettings",{propTypes:{user_slug:types.string.isRequired,coupon:types.string,max_redeems:types.number,redeems:types.number,taken_slugs:types.array,rate:types.number},getInitialState:function(){return{coupon:this.props.coupon,max_redeems:this.props.max_redeems===0?"":this.props.max_redeems}},randomize_coupon:function(){var coupon_charset,i;coupon_charset="ABCDEFGHJKMNPQRSTUVWXY3456789";code=function(){var j,results;results=[];for(i=j=1;j<=10;i=++j){results.push(coupon_charset[Math.floor(Math.random()*coupon_charset.length)])}return results}().join("");return this.setState({coupon:code})},render:function(){return div({className:"",children:[h2({},"Coupon code"),p({},"If a coupon code is provided then the coupons's special URL must be used to access the promotion. The sale will not be listed anywhere on itch.io. You can also limit the quantity available. Coupons are case insensitive."),this.props.redeems&&this.props.redeems>0?p({className:classNames({coupon_error:this.state.redeem_error})},"This coupon has already been claimed ",strong({},this.props.redeems+" times.")):void 0,div({className:"joint_input_row",children:[R.Forms.TextInputRow({title:"Coupon code",name:"sale[coupon]",placeholder:"Optional",multi:true,slug_input:true,value:this.state.coupon||"",has_error:this.state.slug_error,onChange:function(_this){return function(e){var ref1,slug_error;code=e.target.value;slug_error=(ref1=code.toLowerCase(),indexOf.call(_this.props.taken_slugs,ref1)>=0);return _this.setState({coupon:code,slug_error:slug_error})}}(this),sub:button({"data-tooltip":"Generate random",className:"icon icon-dice random_coupon_btn",onClick:function(_this){return function(e){_this.randomize_coupon();return e.preventDefault()}}(this)})}),this.props.rate!==100?R.Forms.TextInputRow({title:"Maximum redeems",sub:"How many times can the coupon be used",name:"sale[coupon_max_redeems]",has_error:this.state.redeem_error,value:this.state.max_redeems,placeholder:"No limit",pattern:"[0-9]*",integer_input:true,onChange:function(_this){return function(e){var redeem_error,value;value=e.target.value;redeem_error=value&&+value>0?(_this.props.redeems||0)>+value:false;return _this.setState({max_redeems:value,redeem_error:redeem_error})}}(this)}):void 0]}),(this.state.coupon||"")!==""?this.state.slug_error?p({className:"coupon_error"},"That name is already taken by a project on your account"):p({className:"coupon_preview"},strong({},"Your coupon URL:"),br({}),span({className:"preview_url"},"https://"+this.props.user_slug+".itch.io/"+(this.state.coupon||""))):void 0]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Forms");types=React.PropTypes;P("FileUploader",{propTypes:{label:types.string,upload:types.shape({id:types.number,url:types.string}),upload_func:types.func},getInitialState:function(){return{upload:this.props.upload}},componentDidMount:function(){return this.dispatch({delete_upload:function(_this){return function(e){_this.setState({loading:true});return $.ajax({url:_this.state.upload.url,type:"post",data:I.with_csrf({action:"delete",upload_id:_this.state.upload.id})}).done(function(res){if(res.errors){alert(res.errors.join());return}return _this.setState({loading:false,upload:null})})}}(this),pick_file:function(_this){return function(e){if(_this.state.uploading||_this.state.loading){return}_this.setState({uploading:true});return(_this.props.upload_func||I.upload_file)({url:_this.props.upload_url}).progress(function(event,sent,total){console.warn.apply(console,arguments);if(event==="progress"){return _this.setState({progress:sent/total})}}).fail(function(){_this.setState({uploading:false});return console.error.apply(console,["upload failed"].concat(slice.call(arguments)))}).done(function(res){return _this.setState({uploading:false,upload:res.upload})})}}(this)})},render_preview_upload:function(){if(this.props.render_preview_upload){return this.props.render_preview_upload()}else{return span({className:"upload_filename"},this.state.upload.filename)}},render:function(){var disabled,text;text=this.state.uploading?"Uploading"+(this.state.progress&&" ("+Math.floor(this.state.progress*100)+"%)"||""):this.state.loading?"Loading...":this.props.label?this.props.label:this.state.upload?"Replace upload":"Upload";disabled=this.state.uploading||this.state.loading;return div({className:"file_uploader",children:[button({className:classNames("button",{disabled:disabled}),disabled:disabled,onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("pick_file")}}(this)},text)," ",this.state.upload?input({type:"hidden",name:this.props.name,value:this.state.upload.id}):void 0,this.state.upload&&!this.state.loading?a({href:"javascript:void(0)",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("delete_upload")}}(this)},"Remove upload"):void 0,this.state.upload?this.render_preview_upload():void 0]})}})}).call(this);(function(){var a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;types=React.PropTypes;R("FollowButton",{propTypes:{following:types.bool,show_name:types.bool,name:types.string,login_url:types.string,user_id:types.number,follow_data:types.object,follow_url:types.string.isRequired,unfollow_url:types.string.isRequired},getInitialState:function(){return{following:this.props.following}},getDefaultProps:function(){return{show_name:true}},componentDidUpdate:function(prev_props,prev_state){if(!prev_state.animate_class&&this.state.animate_class){if(this.timer){window.clearTimeout(this.timer);delete this.timer}return this.timer=setTimeout(function(_this){return function(){return _this.setState({animate_class:null})}}(this),500)}},componentWillUnmount:function(){if(this.timer){window.clearTimeout(this.timer);return delete this.timer}},render:function(){var inside;inside=this.state.following?this.state.hovering?["Unfollow ",this.props.show_name?this.props.name:void 0]:[span({className:"icon icon-checkmark","aria-hidden":true,role:"img"}),"Following ",this.props.show_name?this.props.name:void 0]:[span({className:"icon icon-plus","aria-hidden":true,role:"img"}),"Follow ",this.props.show_name?this.props.name:void 0];return this.enclose.apply(this,[{component:this.props.login_url?"a":"button",href:this.props.login_url,"data-label":"follow_btn",className:classNames("button",{is_following:this.state.following,disabled:this.state.loading},this.state.animate_class,this.props.className),onMouseEnter:function(_this){return function(){return _this.setState({hovering:true})}}(this),onMouseLeave:function(_this){return function(){return _this.setState({hovering:false})}}(this),target:this.props.target,onClick:function(_this){return function(e){var btn,url;if(_this.props.login_url){return}if(_this.state.loading){return}e.preventDefault();btn=$(e.target);_this.setState({loading:true,animate_class:null});_this.container().trigger("i:track_link");url=_this.state.following?_this.props.unfollow_url:_this.props.follow_url;return $.post(url,I.with_csrf(_this.props.follow_data),function(res){if(res.errors){I.flash(res.errors.join(", "));_this.setState({loading:false});return}btn.trigger("i:follow_updated",[{user_id:_this.props.user_id,following:res.following,btn:btn}]);return _this.setState({following:res.following,animate_class:res.following?"animate_bounce":"animate_drop_down",loading:false},function(){var base;return typeof(base=_this.props).on_follow_change==="function"?base.on_follow_change(_this.state.following):void 0})})}}(this)}].concat(slice.call(inside)))}})}).call(this);(function(){var P,a,br,button,c,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;if(R.Redactor){return}c=function(_this){return function(){return R.component.apply(R,arguments)}}(this);types=React.PropTypes;c("Redactor",{componentDidMount:function(){return I.redactor($(ReactDOM.findDOMNode(this)),{minHeight:80,source:false})},render:function(){return textarea({name:this.props.name,value:this.props.value,defaultValue:this.props.defaultValue})}});c("CSRF",{pure:true,render:function(){return input({type:"hidden",name:"csrf_token",value:$("meta[name=csrf_token]").attr("value")})}});P=R["package"]("Forms");P("TextInputRow",{pure:true,propTypes:{title:types.string,sub:types.any,name:types.string.isRequired,value:types.any},componentDidMount:function(){var valid_slug_chars;if(this.props.money_input){if(!this.props.currency){throw new Error("missing currency")}I.money_input(this.refs.input,{currency:this.props.currency})}if(this.props.slug_input){I.slug_input($(this.refs.input))}if(this.props.integer_input){valid_slug_chars=/[0-9]/g;return $(this.refs.input).on("keypress",function(_this){return function(e){var char;if(e.keyCode>=32){char=String.fromCharCode(e.keyCode);if(!char.match(valid_slug_chars)){return false}}}}(this))}},render:function(){var inside;inside=[div({className:"label"},this.props.title,this.props.sub?span({className:"sub"}," — ",this.props.sub):void 0),input({type:"text",name:this.props.name,ref:"input",value:this.props.value,defaultValue:this.props.defaultValue,onChange:this.props.onChange,onKeyUp:this.props.onKeyUp,className:classNames({has_error:this.props.has_error}),required:this.props.required,placeholder:this.props.placeholder,disabled:this.props.disabled,pattern:this.props.pattern}),this.props.error_message?p({className:"input_error"},this.props.error_message):void 0];if(!this.props.multi){inside=label({children:inside})}return div({className:"input_row",children:inside})}});P("SimpleSelect",{propTypes:{options:types.array.isRequired,name:types.string},getInitialState:function(){return{}},render:function(){var children,current,current_group,push_group,render_current_option;current=this.current_option();render_current_option=this.props.render_current_option;render_current_option||(render_current_option=function(_this){return function(current){return current.short_name||current.name}}(this));children=[];current_group=null;push_group=function(){if(!current_group){return}children.push(optgroup.apply(null,[{label:current_group.label}].concat(slice.call(current_group.children))));return current_group=null};this.props.options.map(function(_this){return function(o,idx){var opt;opt=option({key:""+idx,value:o.value},o.name);if(o.group){if((current_group!=null?current_group.label:void 0)!==o.group){push_group()}current_group||(current_group={label:o.group,children:[]});return current_group.children.push(opt)}else{push_group();return children.push(opt)}}}(this));push_group();return this.enclose({className:classNames({focused:this.state.focused,disabled:this.props.disabled}),children:[div({className:"selected_option"},span({className:"selected_option_name"},render_current_option(current)),span({className:"icon icon-triangle-down"})),select({disabled:this.props.disabled,value:current.value,name:this.props.name,onFocus:function(_this){return function(e){return _this.setState({focused:true})}}(this),onBlur:function(_this){return function(e){return _this.setState({focused:false})}}(this),onChange:this.on_change,children:children})]})},on_change:function(e){var value;value=e.target.value;if(this.props.onChange){if(value===this.props.value){return}return this.props.onChange(value)}else{if(value===this.state.value){return}return this.setState({value:value})}},find_option:function(value){var i,len,opt,ref1;ref1=this.props.options;for(i=0,len=ref1.length;i<len;i++){opt=ref1[i];if(opt.value===value){return opt}}},current_option:function(){var current,search_value;search_value=this.props.value||this.state.value;current=search_value!=null?this.find_option(search_value):void 0;return current||this.props.options[0]}});P("Select",{propTypes:{name:types.string.isRequired,value:types.any,options:types.array.isRequired},componentDidMount:function(){var el,opts;if(!this.props.selectize){return}opts=this.props.selectize===true?{}:this.props.selectize;el=$(this.refs.input);el.selectize(opts);if(this.props.onChange){return el.on("change",function(_this){return function(e){return _this.props.onChange(e)}}(this))}},render:function(){return select({ref:"input",name:this.props.name,onChange:this.props.onChange,value:this.props.value,defaultValue:this.props.defaultValue,children:this.props.options.map(function(_this){return function(arg){var label,value;value=arg[0],label=arg[1];return option({value:value},label||value)}}(this))})}});P("RadioButtons",{propTypes:{name:types.string.isRequired,value:types.any,options:types.array.isRequired},getValue:function(){var i,len,name,ref1,ref2,value;ref1=this.container().find("input").serializeArray();for(i=0,len=ref1.length;i<len;i++){ref2=ref1[i],name=ref2.name,value=ref2.value;return value}},render:function(){return ul({className:"radio_list",children:this.props.options.map(function(_this){return function(arg){var input_label,more_opts,sub,value;value=arg[0],input_label=arg[1],sub=arg[2],more_opts=arg[3];return li({className:classNames({disabled:more_opts!=null?more_opts.disabled:void 0})},label({children:[input($.extend({type:"radio",name:_this.props.name,value:value,defaultChecked:_this.props.defaultValue?value===_this.props.defaultValue:void 0,checked:_this.props.value!=null?value===_this.props.value:void 0,onChange:_this.props.onChange},more_opts)),span({className:"radio_label"},input_label),sub?span({className:"sub",children:[" — ",sub]}):void 0]}))}}(this))})}});P("ColorInput",{propTypes:{name:types.string,value:types.any,defaultValue:types.any,allow_empty:types.bool},palette:["#193D3F","#3F2832","#743F39","#9E2835","#B86F50","#327345","#E53B44","#4F6781","#0484D1","#FB922B","#AFBFD2","#63C64D","#E4A672","#2CE8F4","#FFE762"],componentDidMount:function(){var base;(base=R.Forms.ColorInput).active_inputs||(base.active_inputs=[]);R.Forms.ColorInput.active_inputs.push(this);if(!$._farbtastic){throw new Error("Need farb to create color picker")}this.farb=new $._farbtastic($());if(c=this.props.defaultValue){this.farb.setColor(c)}return this.refresh_preview=_.debounce(function(){return this.set_color_from_input(false)},500)},componentDidUpdate:function(prev_props,prev_state){var current_value,new_value,popup_farb;current_value=prev_props.value||"";new_value=this.props.value||"";if(current_value!==new_value){if(c=this.set_color(new_value)){this.refs.input.value=c}}if(!prev_state.open&&this.state.open){popup_farb=$.farbtastic($(this.refs.farb),function(_this){return function(color){if(c=_this.set_color(color)){return _this.refs.input.value=c}}}(this));if(this.state.last_value){popup_farb.setColor(this.state.last_value)}return this.setState({popup_farb:popup_farb})}},getInitialState:function(){return{open:false,last_value:this.props.value||this.props.defaultValue||""}},set_color_from_input:function(){var color,f;if(!this.refs.input){return}color=this.set_color.apply(this,[this.refs.input.value].concat(slice.call(arguments)));if(!color){return}if(color!==this.refs.input.value){this.refs.input.value=color}if(f=this.state.popup_farb){return f.setColor(color)}},set_color:function(color,fix_input){var base,base1;if(fix_input==null){fix_input=true}color||(color="");if(this.props.allow_empty&&color===""){this.farb.setColor("#ffffff");this.setState({last_value:""});if(fix_input){this.refs.input.value=""}if(typeof(base=this.props).onChange==="function"){base.onChange("")}return""}if(!color.match(/^#/)){color="#"+color}this.farb.setColor(color);if(color===this.farb.color){this.setState({last_value:color});if(typeof(base1=this.props).onChange==="function"){base1.onChange(color)}return color}else{if(fix_input){this.refs.input.value=this.state.last_value||""}return false}},open:function(){if(this.state.open){return}this.setState({open:true,on_left:this.popup_on_left()});this.click_outside_handler||(this.click_outside_handler=function(_this){return function(e){var self;self=ReactDOM.findDOMNode(_this);if($(e.target).closest(self).length){return}return _this.close()}}(this));return $(document.body).on("mousedown",this.click_outside_handler)},componentWillUnmount:function(){if(this.click_outside_handler){return $(document.body).off("mousedown",this.click_outside_handler)}},close:function(){if(!this.state.open){return}this.setState({open:false,popup_farb:void 0});return $("document.body").off("mousedown",this.click_outside_handler)},popup_on_left:function(){var el,popup_right;el=$(ReactDOM.findDOMNode(this));popup_right=el.offset().left+el.width()+250;return popup_right>$(window).width()+$(window).scrollLeft()},render_color_popout:function(){var palette;palette=this.props.palette||this.palette;return div({className:"color_popout",children:[this.props.allow_empty&&this.state.last_value?button({type:"button",className:"clear_color_btn",onClick:function(_this){return function(){return _this.set_color("")}}(this)},"Clear"):void 0,div({className:"farb_drop",ref:"farb"}),palette?div({className:"palette_options"},palette.map(function(_this){return function(color){return button({key:color,type:"button",style:{backgroundColor:color},onClick:function(e){return _this.set_color(color)}},color)}}(this))):void 0]})},render:function(){var current_color;current_color=this.state.last_value||"#ffffff";return this.enclose({className:classNames(this.props.className,{picker_open:this.state.open,picker_left:this.state.on_left}),children:[input({ref:"input",type:"text",className:"color_text_input",name:this.props.name,defaultValue:this.props.value||this.props.defaultValue,placeholder:this.props.defaultValue||"Color",onBlur:this.set_color_from_input,onFocus:this.open,onKeyDown:function(_this){return function(e){switch(e.keyCode){case 9:_this.close();break;case 13:_this.set_color_from_input();e.preventDefault()}return _this.refresh_preview()}}(this)}),div({className:"color_swatch",onClick:this.open,style:{backgroundColor:current_color}}),this.state.open?this.render_color_popout():void 0]})}});P("Slider",{propTypes:{min:types.number,max:types.number,value:types.number,onChange:types.func,disabled:types.bool},getInitialState:function(){return{}},on_change:function(value){value=Math.round(value);if(this.props.onChange){if(this.props.value===value){return}return this.props.onChange(value)}else{if(this.state.value===value){return}return this.setState({value:value})}},start_drag:function(start_x,start_y){var move_listener,start_value,up_listener,width;if(this.props.disabled){return}width=this.refs.track.clientWidth;start_value=this.current_value();this.setState({dragging:true});move_listener=function(_this){return function(e){var dx,new_value,x,y;if(e.buttons===0){up_listener();return}x=e.pageX;y=e.pageX;dx=x-start_x;new_value=dx/width*(_this.props.max-_this.props.min)+start_value;new_value=Math.min(_this.props.max,Math.max(_this.props.min,new_value));if(new_value!==_this.current_value()){return _this.on_change(new_value)}}}(this);up_listener=function(_this){return function(e){_this.setState({dragging:false});document.body.removeEventListener("mousemove",move_listener);document.body.removeEventListener("mouseup",up_listener);return delete _this.up_listener}}(this);document.body.addEventListener("mousemove",move_listener);document.body.addEventListener("mouseup",up_listener);return this.up_listener=up_listener},current_value:function(){if("value"in this.state){return this.state.value||this.props.min}else{return this.props.value||this.props.min}},percent:function(){return(this.current_value()-this.props.min)/(this.props.max-this.props.min)},componentWillUnmount:function(){if(this.up_listener){return this.up_listener()}},render:function(){var offset_style;offset_style={left:this.percent()*100+"%"};return this.enclose({className:classNames("slider_input",{disabled:this.props.disabled}),onClick:function(_this){return function(e){var new_value,rect;if(e.target===_this.refs.slider_nub){return}rect=_this.refs.track.getBoundingClientRect();p=Math.min(rect.width,Math.max(0,e.pageX-rect.left))/rect.width;new_value=_this.props.min+p*(_this.props.max-_this.props.min);new_value=Math.min(_this.props.max,Math.max(_this.props.min,new_value));if(new_value!==_this.current_value()){return _this.on_change(new_value)}}}(this),children:[this.props.name?input({type:"hidden",name:this.props.name,value:this.current_value()}):void 0,div({ref:"track",className:"slider_track"},div({className:"slider_fill",style:{width:this.percent()*100+"%"}}),this.state.focused&&this.props.show_tooltip?div({style:offset_style,className:"value_tooltip"},this.current_value()):void 0,button({type:"button",ref:"slider_nub",className:"slider_nub",onFocus:function(_this){return function(){return _this.setState({focused:true})}}(this),onBlur:function(_this){return function(){return _this.setState({focused:false})}}(this),onMouseDown:function(_this){return function(e){return _this.start_drag(e.pageX,e.pageY)}}(this),onKeyDown:function(_this){return function(e){switch(e.keyCode){case 37:_this.on_change(Math.max(_this.props.min,_this.current_value()-1));break;case 39:_this.on_change(Math.min(_this.props.max,_this.current_value()+1));break;default:return}return e.preventDefault()}}(this),style:offset_style}))]})}})}).call(this);(function(){var IndiegogoRow,KickstarterRow,P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,next_group_id,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("GameEdit");types=React.PropTypes;next_group_id=1;KickstarterRow=function(){function KickstarterRow(){}KickstarterRow.is_valid=function(row){if(!(row&&row["Pledge Amount"]&&row["Email"]&&row["Pledged Status"])){return false}return true};KickstarterRow.get_currency=function(row){var currency,m;currency="USD";if(row){m=row!=null?row["Pledge Amount"].match(/[ ](\w+)$/):void 0;if(m){currency=m[1]}}return currency};KickstarterRow.normalize_row=function(row){if(row["Pledged Status"]!=="collected"){return}if(!row["Email"]){return}return{original:row,amount:I.parse_money(row["Pledge Amount"]),name:row["Backer Name"],email:row["Email"]}};return KickstarterRow}();IndiegogoRow=function(){function IndiegogoRow(){}IndiegogoRow.is_valid=function(row){if(!(row&&row["Amount"]&&row["Email"])){return false}return true};IndiegogoRow.get_currency=function(row){return"USD"};IndiegogoRow.normalize_row=function(row){var amount;if(!row["Email"]){return}amount=row["Amount"];if(!amount.match(/\.\d\d$/)){amount=amount+".00"}return{original:row,email:row["Email"],amount:I.parse_money(amount),name:row["Name"]}};return IndiegogoRow}();P("KickstarterImport",{propTypes:{currency:types.string.isRequired,money_placeholder:types.string.isRequired,download_key_groups:types.array},getInitialState:function(){return{groups:[],uploads:_.toArray(this.props.uploads)}},assign_backers_to_groups:function(){var backer,found,group,j,k,l,len,len1,ref1,ref2,ref3,ungrouped_backers;if(!this.state.backers){return}this.state.groups.sort(function(a,b){return(a.cutoff_price||0)-(b.cutoff_price||0)});ref1=this.state.groups;for(j=0,len=ref1.length;j<len;j++){group=ref1[j];group.backers=[]}ungrouped_backers=[];ref2=this.state.backers;for(k=0,len1=ref2.length;k<len1;k++){backer=ref2[k];found=false;ref3=this.state.groups;for(l=ref3.length-1;l>=0;l+=-1){group=ref3[l];if((group.cutoff_price||0)<=backer.amount){group.backers.push(backer);found=true;break}}if(!found){ungrouped_backers.push(backer)}}return this.setState({ungrouped_backers:ungrouped_backers})},do_submit:function(e){var data,request;e.preventDefault();if(this.state.loading){return}this.setState({loading:true});data=new FormData(this.refs.form);request=new XMLHttpRequest;request.open("POST","");request.send(data);return request.onload=function(_this){return function(e){var res;res=JSON.parse(request.responseText);if(res.errors){return _this.setState({loading:false,error_message:res.errors.join(",")})}else{return window.location.reload()}}}(this)},componentDidMount:function(){return this.dispatch("ks",{set_group_price:function(_this){return function(e,idx,price){_this.state.groups[idx].cutoff_price=price;return _this.assign_backers_to_groups()}}(this),add_group:function(_this){return function(){_this.state.groups.push({id:next_group_id++});return _this.assign_backers_to_groups()}}(this),remove_group:function(_this){return function(e,idx){_this.state.groups.splice(idx,1);return _this.assign_backers_to_groups()}}(this),pick_csv:function(_this){return function(){return I.pick_files({accept:".csv",input:_this.refs.csv_file}).done(function(files){var file,reader;_this.setState({loading:true,file_contents:null,file_name:null,parsed_file:null,backers:null});file=files[0];if(!file){return}reader=new FileReader;reader.readAsText(file);reader.onerror=function(){return _this.setState({loading:false,error_message:"There was an issue reading that file: "+reader.error})};return reader.onload=function(){return _this.load_file(file.name,reader.result)}})}}(this)})},render:function(){return this.enclose({className:"kickstarer_uploader"},form({encType:"multipart/form-data",method:"POST",ref:"form",className:"form group_form",onSubmit:this.do_submit,children:[input({type:"file",ref:"csv_file",name:"csv_file",className:"csv_file"}),input({type:"hidden",name:"file_format_type",value:this.state.file_format_type||""}),this.state.file_contents?this.render_current_file():this.render_action_buttons(),this.state.error_message?p({className:"error_message"},this.state.error_message):void 0]}))},render_current_file:function(){var ref1,ref2;return div({className:"current_file",children:[h3({className:"filename_row"},"File: ",span({className:"filename"},this.state.file_name)),div({className:"backer_summary",children:[this.render_summary_stat("Backers",this.state.total_backers),this.render_summary_stat("Min pledge",I.format_money(this.state.min_pledge,this.state.import_currency)),this.render_summary_stat("Max pledge",I.format_money(this.state.max_pledge,this.state.import_currency)),this.render_summary_stat("Currency",this.state.import_currency)]}),R.Forms.TextInputRow({name:"import_name",title:"Import name",sub:"So you can identify the import later",required:true,placeholder:"required"}),div({},button({className:"button small",type:"button",ref:"split_backers",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("ks:add_group")}}(this)},"Split backers by pledge amount...")),div({className:"backer_groups",children:this.render_groups()}),this.state.groups.length&&((ref1=this.state.ungrouped_backers)!=null?ref1.length:void 0)?div({className:"ungrouped_backers"},((ref2=this.state.ungrouped_backers)!=null?ref2.length:void 0)+" backers not assigned. ",a({href:"#",onClick:function(_this){return function(e){e.preventDefault();return I.Lightbox.open(R.GameEdit.KickstarterBackersLightbox({unassigned:true,backers:_this.state.ungrouped_backers}))}}(this)},"View list")):void 0,div({className:"account_require"},label({},input({defaultChecked:true,type:"checkbox",name:"require_account"}),span({},"Require backers to claim their key with an itch.io account to access it"),R.GameEdit.HelpTooltip({tooltip:"A key that is claimed can not be shared by copying the URL"}))),this.render_action_buttons()]})},render_groups:function(){if(!this.state.groups.length){return R.GameEdit.KickstarterBackerGroup({key:"default",currency:this.props.currency,import_currency:this.state.import_currency,money_placeholder:this.props.money_placeholder,backers:_.toArray(this.state.ungrouped_backers),default:true,uploads:this.state.uploads,download_key_groups:_.toArray(this.props.download_key_groups)})}return this.state.groups.map(function(_this){return function(group,i){return R.GameEdit.KickstarterBackerGroup({idx:i,default:false,import_currency:_this.state.import_currency,key:group.id,backers:_.toArray(group.backers),currency:_this.props.currency,money_placeholder:_this.props.money_placeholder,uploads:_this.state.uploads,group:group,download_key_groups:_.toArray(_this.props.download_key_groups),update_pledge_cutoff:function(val){group.pledge_cutoff=val;return _this.forceUpdate()}})}}(this))},render_summary_stat:function(label,value){return div({className:"summary_stat"},div({className:"summary_value"},value),div({className:"summary_label"},label))},validate_csv:function(parsed){var first;if(!(parsed&&parsed.data)){return false}first=parsed.data[0];if(KickstarterRow.is_valid(first)){return"kickstarter"}if(IndiegogoRow.is_valid(first)){return"indiegogo"}return false},summarize_file:function(parsed_file,row_parser){var amount,backer,backers,currency,max_pledge,min_pledge,row;if(parsed_file==null){parsed_file=this.state.parsed_file}if(!parsed_file){return}min_pledge=void 0;max_pledge=void 0;currency=row_parser.get_currency(parsed_file.data[0]);backers=function(){var j,len,ref1,results;ref1=parsed_file.data;results=[];for(j=0,len=ref1.length;j<len;j++){backer=ref1[j];row=row_parser.normalize_row(backer);if(!row){continue}amount=row.amount;if(min_pledge==null||amount<min_pledge){min_pledge=amount}if(max_pledge==null||amount>max_pledge){max_pledge=amount}results.push(row)}return results}();if(!backers.length){this.setState({error_message:"No backers could be retrieved from the file",file_contents:null,file_name:null,parsed_file:null});return}return this.setState({total_backers:backers.length,import_currency:currency,max_pledge:max_pledge,min_pledge:min_pledge,backers:backers})},load_file:function(name,text){var parsed,row_parser,row_type;parsed=Papa.parse(text,{header:true});row_type=this.validate_csv(parsed);if(!row_type){this.setState({loading:false,error_message:"Failed to parse backers, is the file the correct format?"});return}row_parser=function(){switch(row_type){case"kickstarter":return KickstarterRow;case"indiegogo":return IndiegogoRow;default:throw new Error("No parser for row type: "+row_type)}}();this.summarize_file(parsed,row_parser);return this.setState({error_message:null,file_format_type:row_type,row_parser:row_parser,loading:false,file_contents:text,file_name:name,parsed_file:parsed},function(_this){return function(){return _this.assign_backers_to_groups()}}(this))},render_action_buttons:function(){return div({className:"bottom_buttons",children:[this.state.file_name?[button({className:classNames("button",{disabled:this.state.loading}),disabled:this.state.loading},"Create keys for backers")," or ",a({href:"#",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("ks:pick_csv")}}(this)},"Select a different CSV")]:[button({className:"button",disabled:!!this.state.loading,onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("ks:pick_csv")}}(this)},"Select a CSV to import...")," or ",a({href:"#",onClick:function(_this){return function(e){e.preventDefault();return I.Lightbox.open(R.GameEdit.KickstarterApiLightbox({}))}}(this)},"Import using Kickstarter API...")]]})}});P("KickstarterBackerGroup",{propTypes:{idx:types.number,default:types.bool.isRequired,currency:types.string.isRequired,money_placeholder:types.string.isRequired,backers:types.array.isRequired,uploads:types.array.isRequired,download_key_groups:types.array},getInitialState:function(){return{unlock_all_files:false,download_key_group_id:""}},componentDidMount:function(){if(this.refs.cutoff_price){return $(this.refs.cutoff_price.refs.input).focus()}},input_name:function(name){var idx;idx=this.props.idx!=null?this.props.idx+1:"default";return"group["+idx+"]["+name+"]"},render:function(){return div({className:classNames("backer_group",{default_group:this.props["default"]}),children:[this.render_header(),div({className:"group_columns",children:[this.render_uploads(),this.render_key_destination()]})]})},render_header:function(){return[!this.props["default"]?div({className:"group_header",children:[div({className:"group_summary"},"Backers that pledge",R.GameEdit.MoneyInput({"data-currency":this.props.import_currency,ref:"cutoff_price",className:"cutoff_price",name:this.input_name("cutoff_price"),placeholder:I.format_money(0,this.props.import_currency),onKeyUp:function(_this){return function(e){var val;val=I.parse_money(e.target.value);return _this.trigger("ks:set_group_price",_this.props.idx,val)}}(this)}),"and above"),a({href:"#",className:"sub",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("ks:remove_group",_this.props.idx)}}(this)},"Delete group")]}):void 0,div({className:classNames("group_counts",{has_error:!this.props.backers.length}),children:["Matching ",strong({},this.props.backers.length+" backers"),this.props.backers.length>0?[" (",a({href:"#",onClick:function(_this){return function(e){e.preventDefault();return I.Lightbox.open(R.GameEdit.KickstarterBackersLightbox({group:_this.props.group,import_currency:_this.props.import_currency,backers:_this.props.backers}))}}(this)},"View list"),")"]:void 0]})]},render_key_destination:function(){return div({className:"key_destination",children:[div({className:"column_header",children:["Put keys in ",R.Forms.SimpleSelect({value:this.state.download_key_group_id,name:this.input_name("download_key_group_id"),onChange:function(_this){return function(value){return _this.setState({download_key_group_id:value})}}(this),options:[{value:"",name:"New download key group"}].concat(this.props.download_key_groups.map(function(_this){return function(group){return{value:""+group.id,name:group.name}}}(this)))})]}),this.state.download_key_group_id===""?div({className:"new_download_key_group"},this.render_file_unlock(),this.render_external_key_unlock()):p({},strong({},"Note: "),"Email addresses already imported will be skipped")]})},render_file_unlock:function(){return div({className:"file_unlock",children:[R.Forms.TextInputRow({money_input:true,name:this.input_name("unlock_price"),title:"Unlock price",currency:this.props.currency,placeholder:this.props.money_placeholder,disabled:this.state.unlock_all_files,onKeyUp:function(_this){return function(e){return _this.setState({unlock_price:I.parse_money(e.target.value)})}}(this)}),div({className:"unlock_alt",children:[span({className:"or"}," or "),label({},input({type:"checkbox",name:this.input_name("unlock_all_files"),value:this.state.unlock_all_files,onChange:function(_this){return function(e){return _this.setState({unlock_all_files:e.target.checked})}}(this)}),"Unlock all files")]})]})},render_external_key_unlock:function(){return div({className:"key_unlock",children:[label({},input({name:this.input_name("unlock_keys"),type:"checkbox"}),"Unlock external keys (Steam, etc.)")]})},render_uploads:function(){var ref1,upload_unlock_price,uploads;upload_unlock_price=this.state.download_key_group_id===""?this.state.unlock_price:(ref1=_.toArray(this.props.download_key_groups).find(function(_this){return function(group){return""+group.id===""+_this.state.download_key_group_id}}(this)))!=null?ref1.unlock_price:void 0;uploads=this.props.uploads.map(function(_this){return function(upload){var is_available;is_available=false;if(!upload.min_price){is_available=true}if(upload.min_price&&upload_unlock_price){is_available=upload_unlock_price===-1?true:upload_unlock_price>=upload.min_price}if(_this.state.unlock_all_files){is_available=true}return div({className:classNames("upload",{available:is_available})},span({className:"icon-download icon"}),span({className:"filename"},upload.filename),upload.min_price?span({className:"price"},"at "+I.format_money(upload.min_price,_this.props.currency)):void 0,span({className:"size"},_.str.formatBytes(upload.size)))}}(this));if(!uploads.length){uploads=div({className:"empty_message"},"You don't have any files available")}return div({className:"uploads"},div({className:"column_header"},"Files to be given"),div({className:"available_uploads",children:uploads}))}});P("KickstarterBackersLightbox",{propTypes:{import_currency:types.string,group:types.object,backers:types.array.isRequired},render:function(){return R.Lightbox({className:this.enclosing_class_name(),children:[this.props.group?h2({},"Backers that pledged more than "+I.format_money(this.props.group.cutoff_price,this.props.import_currency)):this.props.unassigned?h2({},"Unassigned backers"):h2({},"Selected backers"),div({className:"backer_list_table",children:[div({className:"backer_list_header"},div({},"Name"),div({},"Email"),div({},"Pledge")),div({className:"backer_list",children:this.props.backers.map(function(_this){return function(backer){return div({className:"backer_row"},div({title:backer.name},backer.name||span({className:"sub"},"n/a")),div({title:backer.email},backer.email),div({},I.format_money(backer.amount,_this.props.import_currency)))}}(this))})]})]})}});P("KickstarterApiLightbox",{render:function(){return R.Lightbox({className:this.enclosing_class_name(),children:[h2({},"Import using Kickstarter API"),p({},"You can import your backer list through Kickstarter's API by adding itch.io's account as a collaborator to your project. Add the following email address as a collaborator to begin:"),p({className:"account_email"},"support@itch.io"),p({},"CSV backer import is self-service, so before using the API you might want to try a CSV import."),p({},a({className:"forward_link",href:"#"},"Read more about connecting your Kickstarter account"))]})}});P("HelpTooltip",{propTypes:{tooltip:types.string.isRequired},componentDidMount:function(){return $(ReactDOM.findDOMNode(this)).has_tooltips()},render:function(){return div({className:"help_hover","data-tooltip":this.props.tooltip})}})}).call(this);(function(){var P,a,br,button,code,counter,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Forms");types=React.PropTypes;counter=0;P("Image",{getInitialState:function(){return{loaded:false}},render:function(){return img({className:classNames(this.enclosing_class_name(),this.props.className,{image_loading:!this.state.loaded}),src:this.props.src,onLoad:function(_this){return function(){var base;_this.setState({loaded:true});return typeof(base=_this.props).on_load==="function"?base.on_load():void 0}}(this)})}});P("ImageUploader",{propTypes:{upload_url:types.string.isRequired,name:types.string.isRequired,thumb_size:types.string,label:types.string,upload:types.object,show_replace:types.bool},getInitialState:function(){return{uploads:this.props.upload?[this.props.upload]:this.props.uploads}},componentDidMount:function(){return this.dispatch({remove_image:function(_this){return function(e,upload_idx){var base,to_remove,upload;to_remove=_this.state.uploads[upload_idx];_this.setState({uploads:function(){var i,len,ref1,results;ref1=this.state.uploads;results=[];for(i=0,len=ref1.length;i<len;i++){upload=ref1[i];if(upload!==to_remove){results.push(upload)}}return results}.call(_this)});if(!_this.props.multiple){return typeof(base=_this.props).on_upload==="function"?base.on_upload(null):void 0}}}(this),pick_image:function(_this){return function(e,image_uploading_fn){var completed_uploads,mark_uploads_complete;completed_uploads={};mark_uploads_complete=function(uploads){var base,i,len,newly_completed,upload;newly_completed=function(){var i,len,results;results=[];for(i=0,len=uploads.length;i<len;i++){upload=uploads[i];if(completed_uploads[upload.id]){continue}completed_uploads[upload.id]=true;results.push(upload)}return results}();if(!newly_completed.length){return}for(i=0,len=newly_completed.length;i<len;i++){upload=newly_completed[i];if(typeof(base=_this.props).on_upload==="function"){base.on_upload(upload)}}return _this.setState({uploads:(_this.state.uploads||[]).concat(newly_completed)})};return I.upload_image({url:_this.props.upload_url,thumb_size:_this.props.thumb_size,multiple:_this.props.multiple,on_start_upload:function(){if(!_this.state.uploading){_this.setState({uploading:true})}return typeof image_uploading_fn==="function"?image_uploading_fn.apply(null,arguments):void 0}}).progress(function(event,sent,total){var args,i,len,percents,prog,res,uploads;percents=[];uploads=[];args=typeof arguments[0]==="string"?[arguments]:arguments;for(i=0,len=args.length;i<len;i++){prog=args[i];if(!prog){continue}switch(prog[0]){case"progress":event=prog[0],sent=prog[1],total=prog[2];percents.push(sent/total);break;case"upload_saved":res=prog[1];if(res.errors){continue}uploads.push(res.upload)}}if(percents.length){_this.setState({progress:Math.min.apply(Math,percents)})}return mark_uploads_complete(uploads)}).fail(function(){console.error.apply(console,["upload failed"].concat(slice.call(arguments)));return _this.setState({uploading:false,upload_error:true})}).done(function(res){if(res.upload){mark_uploads_complete([res.upload])}if(res.errors){_this.setState({uploading:false,upload_error:true});return}return _this.setState({uploading:false})})}}(this)})},render_existing_upload:function(upload,idx){var input_name;input_name=this.props.multiple?this.props.name+"["+(idx+1)+"]":this.props.name;return div({className:"existing_upload",key:upload.id},input({type:"hidden",name:input_name,value:upload.id}),upload.thumb_url?div({className:"preview_image"},P.Image({src:upload.thumb_url})):void 0,this.props.children,div({className:"existing_upload_tools"},button({className:"button outline small remove_image_btn",type:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("remove_image",idx)}}(this)},"Remove image"),this.props.show_replace?button({className:"button outline small replace_image_btn",type:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("pick_image",function(){return _this.trigger("remove_image",idx)})}}(this)},"Replace image"):void 0))},render:function(){var have_uploads,ref1,ref2,ref3,ref4;this.autogen_id="image-uploader-"+counter++;have_uploads=!!((ref1=this.state.uploads)!=null?ref1.length:void 0);return this.enclose({className:classNames(this.props.className,{no_upload:!have_uploads,have_upload:!!have_uploads}),children:[this.props.label?label({className:"label",htmlFor:this.autogen_id},this.props.label):void 0,!(this.props.multiple||((ref2=this.state.uploads)!=null?ref2.length:void 0))?input({type:"hidden",name:this.props.name,value:""}):void 0,this.state.uploading?div({className:"upload_progress"},"Uploading "+((this.state.progress||0)*100).toFixed(2)+"%"):void 0,this.props.multiple||!((ref3=this.state.uploads)!=null?ref3.length:void 0)?button({id:this.autogen_id,disabled:!!this.state.uploading,className:classNames("button",{small:this.props.compact,disabled:!!this.state.uploading}),type:"button",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("pick_image")}}(this)},this.props.upload_label||(this.props.multiple?"Upload images":"Upload image")):void 0,((ref4=this.state.uploads)!=null?ref4.length:void 0)?div({className:"existing_uploads",children:this.state.uploads.map(this.render_existing_upload)}):void 0]})}})}).call(this);(function(){var a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;R.component("Lightbox",{render:function(){return div({className:classNames("lightbox",this.props.className),children:[this.props.close!==false?div({className:"close_button"},"×"):void 0,this.props.children]})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,ul;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Bundle");P("Timezone",{render:function(){return input({type:"hidden",name:"timezone_offset",className:"timezone_offset",value:(new Date).getTimezoneOffset()/60})}});P("Submit",{render:function(){return div({className:"button save_btn",onClick:function(_this){return function(){return $(ReactDOM.findDOMNode(_this)).closest("form").submit()}}(this),children:[this.props.name,div({className:"loader form_loader"})]})}});P("Label",{render:function(){return div({className:"label",children:[this.props.title,this.props.sub?span({className:"sub"}," — ",this.props.sub):void 0]})}});P("BasicInfo",{render:function(){return div({children:[div({className:"input_row",children:[label({children:[P.Label({title:"Title",sub:"What is the name of your bundle?"}),input({type:"text",name:"bundle[title]",className:"big_input title_input"})]})]}),div({className:"input_row",children:[label({children:[P.Label({title:"Description",sub:"Optional description of bundle"}),R.Redactor({name:"bundle[description]"})]})]})]})}});P("Slider",{componentDidMount:function(){return this.slider=$(ReactDOM.findDOMNode(this)).slider({range:"min",animate:"fast",min:0,max:100,step:.001,value:this.props.value,disabled:!!this.props.disabled,slide:function(_this){return function(e,s){return _this.props.onChange(s.value)}}(this)})},componentWillReceiveProps:function(props){this.slider.slider("value",props.value);return this.slider.slider("option","disabled",props.disabled)},render:function(){return div({className:"split_slider"},input({type:"hidden",name:"bundle[split]["+this.props.name+"]",className:"split_slider_input",value:this.props.intValue}))}});P("SplitSlider",{render:function(){return li({className:"split_slider_container"},div({children:[img({className:"avatar",src:this.props.user.avatar}),div({className:"username"},this.props.user.name),div({className:"split_slider_outer"},P.Slider({name:this.props.user.id,value:this.props.value,intValue:this.props.intValue,onChange:this.props.onChange,disabled:this.props.disabled})),div({className:"split_summary"},span({className:"split_value"},[this.props.intValue,"%"]))]}))}});P("RevenueSplit",{getInitialState:function(){return{parts:[]}},render:function(){if(!(this.state.parts.length>0)){return false}return div({children:[P.Label({title:"Developer cut distribution",sub:"How revenue is split among participants"}),div({className:"input_row split_row",children:[ul({className:"split_list",children:this.state.parts.map(function(_this){return function(p,i){return P.SplitSlider({key:p.user.id,user:p.user,value:p.split,intValue:_this.intSplit(i),disabled:_this.state.parts.length===1,onChange:_this.setSplit.bind(_this,p.user.id)})}}(this))}),div({className:"split_presets",children:["Choose a preset: ",a({href:"#",className:"equal_split_btn",onClick:this.setEqualSplit},"equal split")]})]})]})},setSplit:function(id,v,parts){var diff,index,numOthers,otherTotal,totalValue,wiggle;if(parts==null){parts=this.state.parts}index=_.findIndex(parts,function(p){return p.user.id===id});parts[index].split=v;numOthers=parts.length-1;totalValue=0;otherTotal=0;wiggle=1e-5;parts.forEach(function(p,i){totalValue+=p.split;if(i!==index){return otherTotal+=p.split+wiggle}});diff=100-totalValue;parts.forEach(function(p,i){var weight;if(i===index){return}weight=(p.split+wiggle)/otherTotal;return p.split+=diff*weight});parts.forEach(function(p,i){var backers,deficit,deficitDiff;if(p.split>=0){return}deficit=p.split;backers=parts.filter(function(p,i){return i!==index&&i.split>0});deficitDiff=deficit/backers.length;p.split=0;return backers.forEach(function(_this){return function(backer){return backer.split+=deficitDiff}}(this))});return this.setState({parts:parts})},intSplit:function(i){var idx,j,len,part,parts,rest;parts=function(){var j,len,ref1,results;ref1=this.state.parts;results=[];for(j=0,len=ref1.length;j<len;j++){part=ref1[j];results.push($.extend({},part))}return results}.call(this);rest=100;if(parts.length===0){return rest}for(j=0,len=parts.length;j<len;j++){part=parts[j];part.split=Math.floor(part.split);rest-=part.split}idx=0;while(rest>0){rest-=1;parts[idx%parts.length].split+=1;idx+=1}return parts[i].split},setEqualSplit:function(e){var idx,j,len,part,parts,rest,share;if(e!=null){e.preventDefault()}parts=function(){var j,len,ref1,results;ref1=this.state.parts;results=[];for(j=0,len=ref1.length;j<len;j++){part=ref1[j];results.push(part)}return results}.call(this);if(parts.length===0){return}share=Math.floor(100/parts.length);rest=100;for(j=0,len=parts.length;j<len;j++){part=parts[j];part.split=share;rest-=share}idx=0;while(rest>0){rest-=1;parts[idx%parts.length].split+=1;idx+=1}return this.setState({parts:parts})},getTotal:function(){return _.reduce(this.state.parts,function(m,p){return m+p.split},0)}});P("GameList",{getInitialState:function(){return{game_url:"",games:[],loading:false}},render_game:function(game){return li({key:game.id,className:"game_row",children:[input({type:"hidden",name:"bundle[games]["+game.id+"][checked]",value:"true"}),a({className:"remove_game",onClick:this.removeGame.bind(this,game.id)},"Remove"),label({className:"minimum_price_checkbox",children:[input({type:"checkbox",onChange:this.minPriceToggle.bind(this,game.id)}),"Set minimum price"]}),div({className:"cover",style:{backgroundImage:"url('"+game.cover+"')"}}),div({className:"game_info",children:[a({href:game.url,className:"game_link",target:"_blank"},game.title)," by ",a({href:game.user.url,className:"user_link",target:"_blank"},game.user.name)]}),div({className:"price_tag"},I.format_money(game.price,game.currency)),game.has_min_price?div({className:"minimum_price_picker",children:[div({className:"label"},"Minimum price"),p({className:"sub"},"The minimum price for an item should be greater than the minimum price for the entire bundle. You should only set this if the item's minimum price is different than the bundle's."),P.MoneyInput({name:"bundle[games]["+game.id+"][min_price]",className:"item_price_input",currency:"USD"})]}):void 0]})},render:function(){return div({className:"input_row game_list_row "+(this.state.loading&&"loading"),children:[p({},"Paste the URL of one game or more on itch.io and click add"),P.Label({title:"Game URL"}),input({type:"text",className:"game_url_input",placeholder:"e.g. http://example.itch.io/game",onChange:function(_this){return function(e){return _this.setState({game_url:e.target.value})}}(this),onKeyPress:function(_this){return function(e){if(e.charCode===13){return _this.submitGame()}}}(this),value:this.state.game_url,disabled:this.state.loading}),a({className:"button add_game_btn",onClick:this.submitGame},"Add"),div({className:"loader form_loader",style:{display:this.state.loading&&"inline-block"}}),this.state.games.length>0?div({children:[ul({className:"bundle_game_list",children:this.state.games.map(this.render_game)}),div({className:"game_list_summary",children:["Sum of all games: ",span({className:"price"},this.priceSummary())]})]}):void 0]})},submitGame:function(e){$.ajax({url:"/bundle/game-info",type:"post",data:I.with_csrf({urls:this.state.game_url}),success:function(_this){return function(res){var ref1;if(res.errors){I.flash("Error: "+res.errors.join(", "),"error");return}if((ref1=I.flasher)!=null){ref1.dismiss()}return _this.add_games(res)}}(this),error:function(){return I.flash("Server error, try again later")},complete:function(_this){return function(){return _this.setState({loading:false})}}(this)});return this.setState({loading:true})},add_games:function(data){var games;games=_.union(this.state.games,data.games);games=_.uniq(games,function(g){return g.id});return this.setState({games:games,game_url:""})},removeGame:function(id){var games;games=_.filter(this.state.games,function(g){return g.id!==id});return this.setState({games:games})},minPriceToggle:function(id,e){var games,has;has=e.target.checked;games=_.map(this.state.games,function(g){if(g.id===id){return _.extend(g,{has_min_price:has})}else{return g}});return this.setState({games:games})},componentWillUpdate:function(newProps,newState){return this.props.on_games(newState.games)},priceSummary:function(){var groups,prices;groups=_.groupBy(this.state.games,"currency");prices=_.map(groups,function(games,currency){var g,j,len,total;total=0;for(j=0,len=games.length;j<len;j++){g=games[j];total+=g.price}return I.format_money(total,currency)});return _.reduce(prices,function(memo,price){return memo+" + "+price})}});P("MoneyInput",{componentDidMount:function(){return I.money_input($(ReactDOM.findDOMNode(this)))},render:function(){return input({type:"text",name:this.props.name,className:"medium_input money_input "+this.props.className,placeholder:"$0.00"})}});P("Price",{render:function(){return div({className:"input_row bundle_price_row",children:[label({children:[P.Label({title:"Minimum price",sub:"Minimum price to buy this bundle, can be 0"}),P.MoneyInput({name:"bundle[price]",className:"bundle_price_input",currency:"USD"})]})]})}});P("DatePicker",{componentDidMount:function(){var $el;$el=$(ReactDOM.findDOMNode(this));return I.datetimepicker($el,{onSelect:function(_this){return function(val){return _this.props.onChange($el.datetimepicker("getDate"))}}(this)})},render:function(){return input({type:"text",className:"date_picker",name:this.props.name,readOnly:"readonly"})}});P("Duration",{getInitialState:function(){return{}},render:function(){return div({className:"input_row duration_row",children:[P.Label({title:"Duration",sub:"When the bundle starts and ends in your local time"}),div({children:[label({children:[span({className:"duration_label"},"Start date:"),P.DatePicker({name:"bundle[start_date]",onChange:this.setDate.bind(this,"start")})]}),label({children:[span({className:"duration_label"},"End date:"),P.DatePicker({name:"bundle[end_date]",onChange:this.setDate.bind(this,"end")})]}),span({className:"duration_summary"},this.state.summary)]})]})},setDate:function(which,time){var state;state=this.state;state[which]=time;if(state.start&&state.end){state.summary=I.specific_humanize(moment.duration(state.end-state.start))}return this.setState(state)}});P("Published",{render:function(){return div({className:"input_row",children:[P.Label({title:"Published"}),p({className:"sub"},"A bundle can not be seen by anyone until it is marked public. Once every participant has approved the bundle, you'll receive an e-mail notification and you'll be able to publish the bundle.")]})}});R("NewBundle",{getInitialState:function(){return{errors:[]}},componentDidMount:function(){return this.form=$(ReactDOM.findDOMNode(this)).closest("form").remote_submit(function(_this){return function(res,form){if(res.errors){_this.setState({errors:res.errors});form.set_form_errors(res.errors);return}form.set_form_errors([]);return window.location=res.url}}(this))},render:function(){return div({children:[R.CSRF({}),P.Timezone({}),p({},"A co-op bundle is a bundle between multiple creators on itch.io. From this page you can invite others into your bundle by picking their content. After you've created the bundle each participant must approve it before it can be enabled and go live."),this.props.warn_payouts?p({className:"payouts_warning",children:["Due to the complexity of distributing purchases across multiple sellers, all purchases of co-op bundles go through ",a({href:"/dashboard/payouts"},"itch.io's payout system"),". Prices are done in USD and VAT will automatically be added if necessary."]}):void 0,P.BasicInfo({}),h2({},"Add games"),P.GameList({on_games:this.on_games,price:this.state.price,ref:"game_list"}),h2({},"Price & date"),P.Price({}),P.Duration({}),P.Published({}),P.RevenueSplit({ref:"split"}),P.Submit({name:"Create co-op bundle"}),p({className:"readonly_warning",children:["Please take a moment to verify that the data you've provided is correct. Once you create the bundle the price and games become locked to allow the other developers to approve it without any surprises."]})]})},on_games:function(games){var had_newcomer,oldParts,parts,rest,split,split_factor,total_split,users;split=this.refs.split;oldParts=_.indexBy(split.state.parts,function(p){return p.user.id});users=_.map(games,function(g){return g.user});users=_.indexBy(users,function(u){return u.id});parts=_.groupBy(games,function(g){return g.user.id});parts=_.map(parts,function(games,userId){var ref1;return{user:users[userId],numGames:games.length,split:((ref1=oldParts[userId])!=null?ref1.split:void 0)||-1}});if(parts.length===1){parts[0].split=100}else if(parts.length>0){had_newcomer=false;_.each(parts,function(p){if(p.split===-1){had_newcomer=true;return split.setSplit(p.user.id,Math.ceil(100/parts.length),parts)}});if(!had_newcomer){total_split=0;_.each(parts,function(p){return total_split+=p.split});split_factor=100/total_split;rest=100;_.each(parts,function(p){p.split=Math.floor(p.split*split_factor);return rest-=p.split});parts[0].split+=rest}}return split.setState({parts:parts})}})}).call(this);(function(){var P,SLIDE_DELAY,TransitionGroup,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("Queue");types=React.PropTypes;TransitionGroup=React.createFactory(React.addons.TransitionGroup);SLIDE_DELAY=200;P("TickIcon",{render:function(){return React.DOM.svg({viewBox:"0 0 37 20","aria-hidden":"true",width:this.props.width,height:this.props.height,className:"svgicon",role:"img",version:"1.1"},React.DOM.path({d:"m2.0858 0c-1.1535 0-2.0858 0.86469-2.0858 1.9331 0 0.5139 0.21354 1.0183 0.38704 1.1881l18.113 16.879 18.112-16.879c0.174-0.1696 0.388-0.674 0.388-1.1879 0-1.0684-0.932-1.9331-2.086-1.9331-0.577 0-1.111 0.23008-1.49 0.57992l-14.924 13.894-14.925-13.893c-0.3777-0.34998-0.9134-0.581-1.4902-0.581z"}))}});P("SlidingRow",{render:function(){return div.apply(null,[{className:"animating_row"}].concat(slice.call(this.props.children)))},componentWillEnter:function(callback){return this.container().hide().slideDown(SLIDE_DELAY,callback)},componentWillLeave:function(callback){return this.container().slideUp(SLIDE_DELAY,callback)}});P("CurrentGame",{pure:true,getInitialState:function(){var blurb,ref1;blurb=((ref1=this.props.game.blurb)!=null?ref1.content:void 0)||"";return{blurb_open:blurb.length<200}},componentDidMount:function(){var ca;if(ca=this.props.game.ca){return I.ConversionTracker.push(ca)}},render:function(){var game,ref1,ref2,tags;game=this.props.game;return section({className:"current_game"},h2({className:"game_title"},a({href:game.url,target:"_blank"},game.name)),h3({className:"game_author"},span({},"by ",a({href:game.user.url,target:"_blank"},game.user.name)),game.follow_button&&((ref1=I.current_user)!=null?ref1.id:void 0)!==game.user.id?R.FollowButton($.extend({show_name:false,className:"small",follow_data:{source:"queue"}},game.follow_button)):void 0),this.props.queue?div({className:"queue"},"from ",a({href:this.props.queue.url,target:"_blank"},this.props.queue.name)):void 0,game.summary||game.short_text?p({className:"game_summary"},_.compact([game.summary,game.short_text]).join(". ")):void 0,game.blurb?div({className:classNames("game_blurb",{truncated:!this.state.blurb_open}),onClick:!this.state.blurb_open?function(_this){return function(e){return _this.setState({blurb_open:true})}}(this):void 0},div({className:"blurb_author"},a({target:"blank",href:game.blurb.author.url},game.blurb.author.name)," says"),div({className:"blurb_wrapper",dangerouslySetInnerHTML:{__html:game.blurb.content}})):void 0,game.tags&&game.tags.length?(tags=_.toArray(game.tags).slice(0,11),div({className:"game_tags"},strong({},"Tags: "),this.comma_list(tags.map(function(_this){return function(tag){return a({key:tag.url,target:"_blank",href:tag.url},tag.name)}}(this))))):void 0,game.collection_url?a({className:"add_to_collection_btn button outline",type:"button",target:"_blank",href:game.collection_url,onClick:function(_this){return function(e){var btn;if(!I.current_user){return}e.preventDefault();btn=$(e.currentTarget);return I.Lightbox.open_remote(btn.attr("href"),I.CollectionLightbox)}}(this)},span({className:"icon icon-playlist_add"})," Add to collection"):void 0,((ref2=game.object)!=null?ref2.css:void 0)?pre({className:"game_css"},game.object.css):void 0)},comma_list:function(_this){return function(items){var i,idx,item,len,out;out=[];for(idx=i=0,len=items.length;i<len;idx=++i){item=items[idx];if(idx){out.push(", ")}out.push(item)}return out}}(this)});P("Viewer",{render:function(){return this.enclose({className:{finished:!this.state.current},children:this.state.current?[this.render_sidebar(),section({className:"object_wrapper"},this.state.current?iframe({src:this.state.current.embed_url||this.state.current.url}):void 0)]:this.render_empty_page()})},getInitialState:function(){return{loading:false,current:this.props.next_item,remaining:this.props.remaining,next_url:this.props.next_url}},set_url_state:function(object){var base;if(!(object!=null?object.restore_url:void 0)){return}return typeof(base=window.history).replaceState==="function"?base.replaceState({},object.name,object.restore_url):void 0},dismiss_and_next_item:function(){var current,dismiss;current=this.state.current;dismiss=(current!=null?current.dismiss_url:void 0)?$.post(current.dismiss_url,I.with_csrf()):$.when({});return dismiss.then(function(_this){return function(){return _this.next_item()}}(this))},next_item:function(next_url){return $.getJSON(next_url||this.state.next_url||"").then(function(_this){return function(res){var ref1;_this.set_url_state(res.next_item);return _this.setState({next_url:res.next_url,current:res.next_item,remaining:(ref1=res.remaining)!=null?ref1:void 0})}}(this))},render_empty_page:function(){var can_follow,ref1;can_follow=((ref1=I.current_user)!=null?ref1.id:void 0)!==this.props.queue.user.id;return div({className:"empty_message"},h2({},"You got to the end!"),p({},"There's nothing left in ",a({href:this.props.queue.url},this.props.queue.name)),can_follow?p({},"Did you like it? Give ",a({href:this.props.queue.user.url},"the author")," a follow!"):void 0,div({className:"action_buttons"},can_follow?R.FollowButton($.extend({follow_data:{source:"queue"}},this.props.queue.user.follow_button)):void 0," ",this.props.queue.queue_url?button({className:"button outline",type:"button",onClick:function(_this){return function(e){return _this.next_item(_this.props.queue.queue_url)}}(this)},"Restart collection"):void 0))},render_sidebar:function(){var current;current=this.state.current;return section({className:"sidebar"},this.props.register_url?div({className:"login_message"},a({target:"_blank",href:this.props.register_url,"data-register_action":"nag"},"Create an account on itch.io")," to create your own collections and follow creators"):void 0,div({className:"sidebar_inner"},button({className:classNames("button next_button forward_link",{disabled:this.state.loading}),type:"button",disabled:this.state.loading,onClick:function(_this){return function(e){if(_this.state.loading){return}_this.setState({loading:true});return _this.dismiss_and_next_item().then(function(){return _this.setState({loading:false})})}}(this)},this.state.loading?"Loading...":"Next item"),this.render_current_game(current),this.state.remaining!=null?p({className:"remaining_items_label"},"Remaining items: "+this.state.remaining):void 0,this.render_adjacent_games()))},render_current_game:function(current){return R.Queue.CurrentGame({key:current.id,game:current,queue:this.props.queue})},render_adjacent_game:function(game){var load_position;load_position=function(_this){return function(e){if(game.restore_url==null){return}if(e.button>0||e.ctrlKey){return}e.preventDefault();_this.setState({loading:true});return _this.next_item(game.restore_url).then(function(){return _this.setState({loading:false})})}}(this);return R.Queue.SlidingRow({key:game.id,children:[div({className:"game_row",key:game.id},a({href:game.url,className:"thumb_link",onClick:load_position},game.cover_thumb_url?img({src:game.cover_thumb_url,className:"thumb"}):void 0),div({className:"game_details"},div({className:"game_title"},a({href:game.url,onClick:load_position},game.title)),div({className:"game_author"},"by ",a({href:game.user.url},game.user.name))))]})},render_adjacent_games:function(){var games_after,games_before,ref1;ref1=this.state.current,games_before=ref1.games_before,games_after=ref1.games_after;games_before=_.toArray(games_before);games_before=games_before.slice(0,2).reverse();games_after=_.toArray(games_after);if(!(games_before.length||games_after.length)){return}return TransitionGroup({component:"section",className:"games_around",children:slice.call(games_before.map(this.render_adjacent_game)).concat([div({className:"current_location",key:"current"},span({className:"loc_label"},games_after.length?["Upcoming",R.Queue.TickIcon({key:"icon",width:10,height:10})]:void 0),span({className:"loc_label prev"},games_before.length?[R.Queue.TickIcon({key:"icon",width:10,height:10}),"Previously"]:void 0))],slice.call(games_after.map(this.render_adjacent_game)))})}})}).call(this);(function(){var P,a,br,button,code,div,em,fieldset,form,h1,h2,h3,h4,h5,h6,iframe,img,input,label,legend,li,ol,optgroup,option,p,pre,ref,section,select,span,strong,textarea,types,ul,hasProp={}.hasOwnProperty,slice=[].slice;if(!this.React){return}ref=React.DOM,div=ref.div,span=ref.span,a=ref.a,br=ref.br,p=ref.p,ol=ref.ol,ul=ref.ul,li=ref.li,strong=ref.strong,em=ref.em,img=ref.img,form=ref.form,label=ref.label,input=ref.input,textarea=ref.textarea,button=ref.button,iframe=ref.iframe,h1=ref.h1,h2=ref.h2,h3=ref.h3,h4=ref.h4,h5=ref.h5,h6=ref.h6,pre=ref.pre,code=ref.code,select=ref.select,option=ref.option,section=ref.section,optgroup=ref.optgroup,fieldset=ref.fieldset,legend=ref.legend;P=R["package"]("UserSettings");types=React.PropTypes;P("SellerCutPicker",{propTypes:{default_cut:types.number,cut:types.number,affiliate_cuts:types.array},getInitialState:function(){var cut,i,len,out,ref1,ref2,ref3;out={cut:(ref1=this.props.cut)!=null?ref1:this.props.default_cut,affiliate_cuts:{}};ref2=_.toArray(this.props.affiliate_cuts);for(i=0,len=ref2.length;i<len;i++){cut=ref2[i];out.affiliate_cuts[""+cut.user.id]=(ref3=cut.rate)!=null?ref3:cut.default_rate}return out},set_affiliate_cut:function(affiliate_id,cut){var _,affiliate_cuts,c,i,id,ids,len,marketplace_cut,sum,t,tuples,val;cut=Math.max(0,Math.min(100,+cut));affiliate_cuts=$.extend({},this.state.affiliate_cuts);affiliate_cuts[-1]=this.state.cut;affiliate_cuts[affiliate_id]=cut;sum=0;for(_ in affiliate_cuts){if(!hasProp.call(affiliate_cuts,_))continue;val=affiliate_cuts[_];sum+=val}if(sum>100){tuples=function(){var results;results=[];for(id in affiliate_cuts){if(!hasProp.call(affiliate_cuts,id))continue;c=affiliate_cuts[id];results.push([id,c])}return results}();tuples.sort(function(a,b){return b[1]-a[1]});ids=function(){var i,len,results;results=[];for(i=0,len=tuples.length;i<len;i++){t=tuples[i];results.push(t[0])}return results}();while(sum>100){for(i=0,len=ids.length;i<len;i++){id=ids[i];id=+id;if(id===affiliate_id){continue}if(affiliate_cuts[""+id]===0){continue}affiliate_cuts[""+id]-=1;sum-=1;if(sum<=100){break}}}}marketplace_cut=affiliate_cuts["-1"];delete affiliate_cuts["-1"];return this.setState({cut:marketplace_cut,affiliate_cuts:affiliate_cuts})},componentDidMount:function(){return this.dispatch({set_affiliate_cut:function(_this){return function(e,affiliate_id,cut){return _this.set_affiliate_cut(affiliate_id,cut)}}(this)})},render:function(){return this.enclose({children:[this.render_marketplace_cut(),this.render_affiliates()]})},render_marketplace_cut:function(){return div({className:"input_row cut_row",children:[input({type:"hidden",name:"data[cut]",value:this.state.cut}),div({className:classNames("cut_icon icon icon-heart-filled",{sad:this.state.cut<10,happy:this.state.cut>=30})}),div({className:"label"},"What percentage do you want to give to support itch.io?"),div({className:"cut_container",children:[R.Forms.Slider({min:0,max:100,value:this.state.cut,onChange:function(_this){return function(value){return _this.set_affiliate_cut(-1,value)}}(this)}),div({className:"cut_summary"},span({className:"cut_value"},this.state.cut+"%"),span({className:"sub"}," of each transaction"))]}),div({className:"cut_presets"},"Choose a preset",a({href:"#",className:"set_default_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.set_affiliate_cut(-1,10)}}(this)},"itch.io default (10%)"),a({href:"#",className:"set_standard_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.set_affiliate_cut(-1,30)}}(this)},"Industry standard (30%)"))]})},render_affiliates:function(){var cuts,ref1;if(!((ref1=this.props.affiliate_cuts)!=null?ref1.length:void 0)){return}cuts=this.props.affiliate_cuts.map(function(_this){return function(cut){return P.AffiliateCutPicker($.extend({cut:_this.state.affiliate_cuts[""+cut.user.id]},cut))}}(this));return div.apply(null,[{className:"affiliate_cuts"},h3({},"Affiliates"),p({},"If an itch.io partner helps sell one of your projects by converting someone through their special URL or profile page then you can share some of the revenue back with them.")].concat(slice.call(cuts)))}});P("AffiliateCutPicker",{pure:true,render:function(){var game_list;return this.enclose({className:"input_row cut_row affiliate_cut_row",children:[input({type:"hidden",name:"affiliate["+this.props.user.id+"][cut]",value:this.props.cut}),div({className:"label"},this.props.user.name+" revenue share"),this.props.user.avatar?a({href:this.props.user.url,target:"_blank"},img({className:"affiliate_avatar",src:this.props.user.avatar,width:35,height:35})):void 0,this.props.games&&this.props.games.length?(game_list=this.props.games.map(function(_this){return function(game,idx){return[idx>0?", ":void 0,a({href:game.url},game.title)]}}(this)),div({className:"affected_games",children:["Affected games: "].concat(slice.call(game_list))})):void 0,div({className:"cut_container",children:[R.Forms.Slider({min:0,max:100,value:this.props.cut,onChange:function(_this){return function(value){return _this.trigger("set_affiliate_cut",_this.props.user.id,value)}}(this)}),div({className:"cut_summary"},span({className:"cut_value"},this.props.cut+"%"),span({className:"sub"}," of each transaction"))]}),div({className:"cut_presets"},"Choose a preset",a({href:"#",className:"set_default_btn",onClick:function(_this){return function(e){e.preventDefault();return _this.trigger("set_affiliate_cut",_this.props.user.id,_this.props.default_rate)}}(this)},this.props.user.name+" default ("+this.props.default_rate+"%)"))]})}})}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CommunityArchiveTopicLightbox=function(superClass){extend(CommunityArchiveTopicLightbox,superClass);function CommunityArchiveTopicLightbox(){this.init=bind(this.init,this);return CommunityArchiveTopicLightbox.__super__.constructor.apply(this,arguments)}CommunityArchiveTopicLightbox.prototype.init=function(){var form;this.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),{minHeight:100,source:false})}}(this));return form=this.el.find("form").remote_submit(function(_this){return function(res){form.set_form_errors(res.errors);if(res.errors){return}return window.location.reload()}}(this))};return CommunityArchiveTopicLightbox}(I.Lightbox)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CommunityBanLightbox=function(superClass){extend(CommunityBanLightbox,superClass);function CommunityBanLightbox(){this.init=bind(this.init,this);return CommunityBanLightbox.__super__.constructor.apply(this,arguments)}CommunityBanLightbox.prototype.init=function(){var form;this.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),{minHeight:100,source:false})}}(this));return form=this.el.find("form").remote_submit(function(_this){return function(res){form.set_form_errors(res.errors);if(res.errors){return}return _this.el.addClass("after_ban")}}(this))};return CommunityBanLightbox}(I.Lightbox)}).call(this);(function(){I.CommunityBlocks=function(){function CommunityBlocks(el){this.el=$(el);this.el.remote_link(function(_this){return function(res){if(res.errors){I.flash(res.erorrs.join(", "),"error")}if(res.redirect_to){return window.location=res.redirect_to}}}(this))}return CommunityBlocks}()}).call(this);(function(){I.CommunityCategory=function(){function CommunityCategory(el){this.el=$(el);this.el.dispatch("click",{rules_link:function(_this){return function(){return _this.el.addClass("rules_visible")}}(this)})}return CommunityCategory}()}).call(this);(function(){I.CommunityCategoryBans=function(){function CommunityCategoryBans(el){this.el=$(el);this.el.remote_link(function(_this){return function(res){if(res.errors){alert(res.errors.join("\n"));return}return window.location.reload()}}(this))}return CommunityCategoryBans}()}).call(this);(function(){I.CommunityCategoryModerators=function(){function CommunityCategoryModerators(el){this.el=$(el);this.el.remote_link(function(_this){return function(res,el){if(res.return_to){return window.location=res.return_to}}}(this))}return CommunityCategoryModerators}()}).call(this);(function(){I.CommunityProfile=function(){function CommunityProfile(el,opts){var c;this.el=$(el);I.has_follow_button(this.el);this.carousels=function(){var i,len,ref,results;ref=this.el.find(".game_carousel_widget");results=[];for(i=0,len=ref.length;i<len;i++){c=ref[i];results.push(new I.GameCarousel($(c)))}return results}.call(this);new I.CommunityViewTopic(this.el.find(".recent_posts"),opts)}return CommunityProfile}()}).call(this);(function(){I.CommunityEditCategory=function(){function CommunityEditCategory(el){var form;this.el=$(el);I.redactor(this.el.find("textarea"),{minHeight:100});this.setup_tag_editor();form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}if(res.redirect_to){return window.location=res.redirect_to}}}(this))}CommunityEditCategory.prototype.setup_tag_editor=function(){var tag_editor,tags;tag_editor=this.el.find(".category_tag_editor");if(!tag_editor.length){return}tags=tag_editor.data("tags");return ReactDOM.render(R.Community.CategoryEditTags({tags:tags}),tag_editor[0])};return CommunityEditCategory}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CommunityLockTopicLightbox=function(superClass){extend(CommunityLockTopicLightbox,superClass);function CommunityLockTopicLightbox(){this.init=bind(this.init,this);return CommunityLockTopicLightbox.__super__.constructor.apply(this,arguments)}CommunityLockTopicLightbox.prototype.init=function(){var form;this.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),{minHeight:100,source:false})}}(this));return form=this.el.find("form").remote_submit(function(_this){return function(res){form.set_form_errors(res.errors);if(res.errors){return}return window.location.reload()}}(this))};return CommunityLockTopicLightbox}(I.Lightbox)}).call(this);(function(){I.CommunityNewTopic=function(){function CommunityNewTopic(el,opts){var form;this.el=$(el);I.redactor(this.el.find("textarea"),$.extend({minHeight:100},opts.redactor_opts));try{this.el.find("input[name=offset]").val((new Date).getTimezoneOffset())}catch(error){}this.set_fingerprint();form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){if(I.add_recaptcha_if_necessary(form,res.errors)){return}form.set_form_errors(res.errors);return}if(res.redirect_to){return window.location=res.redirect_to}}}(this))}CommunityNewTopic.prototype.set_fingerprint=function(){if(!window.Fingerprint2){return false}this.set_fingerprint=function(){};return(new Fingerprint2).get(function(_this){return function(res){if(res){return _this.el.find("input[name=bfp]").val(res)}}}(this))};return CommunityNewTopic}()}).call(this);(function(){I.CommunityPostForm=function(){function CommunityPostForm(el,opts){var form;if(opts==null){opts={}}this.el=$(el);I.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),$.extend({minHeight:50,focus:!!opts.focus},opts.redactor_opts))}}(this));form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){if(I.add_recaptcha_if_necessary(form,res.errors)){return}form.set_form_errors(res.errors);return}if(res.redirect_to){window.location=res.redirect_to}if(res.flash){return I.flash(res.flash)}}}(this))}return CommunityPostForm}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CommunityReportPostLightbox=function(superClass){extend(CommunityReportPostLightbox,superClass);function CommunityReportPostLightbox(){this.init=bind(this.init,this);return CommunityReportPostLightbox.__super__.constructor.apply(this,arguments)}CommunityReportPostLightbox.prototype.init=function(){var form;return form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){form.set_form_errors(res.errors);return}return _this.el.addClass("submitted_report")}}(this))};return CommunityReportPostLightbox}(I.Lightbox)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CommunityStickTopicLightbox=function(superClass){extend(CommunityStickTopicLightbox,superClass);function CommunityStickTopicLightbox(){this.init=bind(this.init,this);return CommunityStickTopicLightbox.__super__.constructor.apply(this,arguments)}CommunityStickTopicLightbox.prototype.init=function(){var form;this.with_redactor(function(_this){return function(){return I.redactor(_this.el.find("textarea"),{minHeight:100,source:false})}}(this));return form=this.el.find("form").remote_submit(function(_this){return function(res){form.set_form_errors(res.errors);if(res.errors){return}return window.location.reload()}}(this))};return CommunityStickTopicLightbox}(I.Lightbox)}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.CommunityTopicHeader=function(){function CommunityTopicHeader(el,opts){var moderation;this.opts=opts;this.render_topic_voter=bind(this.render_topic_voter,this);this.el=$(el);moderation=this.el.find(".moderation_tools");if(moderation.length){new I.CommunityTopicModerationTools(moderation,this.opts.moderation)}this.render_topic_voter()}CommunityTopicHeader.prototype.render_topic_voter=function(){var props,ref,voter;if(!(typeof R!=="undefined"&&R!==null?(ref=R.Community)!=null?ref.TopicVoter:void 0:void 0)){return}voter=this.el.find(".community_topic_voter_widget");if(!voter.length){return}props=voter.data("p");props.vote_url=this.opts.vote_url;return ReactDOM.render(R.Community.TopicVoter(props),voter[0])};return CommunityTopicHeader}()}).call(this);(function(){I.CommunityTopicList=function(){function CommunityTopicList(el,opts){this.opts=opts;this.el=$(el);new I.CommunityTopicModerationTools(el,this.opts);this.el.lazy_images({selector:"[data-background_image]"});this.render_topic_voters();this.el.has_tooltips();new I.GamePopups(this.el)}CommunityTopicList.prototype.render_topic_voters=function(){var i,len,props,ref,ref1,results,voter;if(!(typeof R!=="undefined"&&R!==null?(ref=R.Community)!=null?ref.TopicVoter:void 0:void 0)){return}ref1=this.el.find(".community_topic_voter_widget");results=[];for(i=0,len=ref1.length;i<len;i++){voter=ref1[i];props=$(voter).data("p");props.vote_url=this.opts.vote_url;results.push(ReactDOM.render(R.Community.TopicVoter(props),voter))}return results};return CommunityTopicList}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.CommunityTopicModerationTools=function(){CommunityTopicModerationTools.prototype.topic_url=function(route,topic_id){return this.opts.urls[route].replace(/:topic_id\b/,topic_id)};function CommunityTopicModerationTools(el,opts){this.opts=opts;this.topic_url=bind(this.topic_url,this);this.el=$(el);new I.FilterPickers(el);this.el.on("click",".filter_option",function(_this){return function(e){var target,topic_id,value;if($(e.target).is("a")){return}e.preventDefault();target=$(e.currentTarget).trigger("i:close_filter_pickers");topic_id=target.closest("[data-topic_id]").data("topic_id");value=target.data("value");switch(value){case"archive":case"unarchive":return I.Lightbox.open_remote(_this.topic_url("archive_topic",topic_id),I.CommunityArchiveTopicLightbox);case"lock":case"unlock":return I.Lightbox.open_remote(_this.topic_url("lock_topic",topic_id),I.CommunityLockTopicLightbox);case"stick":case"unstick":return I.Lightbox.open_remote(_this.topic_url("stick_topic",topic_id),I.CommunityStickTopicLightbox);case"delete":if(confirm("Are you sure you want to delete this topic?")){return $.ajax({url:_this.topic_url("delete_topic",topic_id),data:I.with_csrf(),type:"post",xhrFields:{withCredentials:true}}).done(function(res){if(res.errors){return alert(res.errors.join())}return window.location.reload()})}}}}(this))}return CommunityTopicModerationTools}()}).call(this);(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};I.CommunityViewTopic=function(){CommunityViewTopic.prototype.vote_counts_template=I.lazy_template(CommunityViewTopic,"vote_counts");function CommunityViewTopic(el,opts){this.opts=opts;this.update_votes=bind(this.update_votes,this);this.el=$(el);this.el.remote_link(function(_this){return function(res,el){if(el.is(".vote_btn")){if(res.errors){alert(res.errors.join(", "));return}_this.update_votes(el,res);return}if(res.redirect_to){return window.location=res.redirect_to}}}(this));this.el.dispatch("click",{ban_user_btn:function(_this){return function(btn){var ban_url,post;post=btn.closest(".community_post").data("post");ban_url=_this.opts.ban_url+("?banned_user_id="+post.user_id);return I.Lightbox.open_remote(ban_url,I.CommunityBanLightbox)}}(this),stick_topic_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("href"),I.CommunityStickTopicLightbox)}}(this),lock_topic_btn:function(_this){return function(btn){return I.Lightbox.open_remote(btn.data("href"),I.CommunityLockTopicLightbox)}}(this),report_post_btn:function(_this){return function(btn){var post,url;post=btn.closest(".community_post").data("post");url=_this.opts.report_url.replace(/:post_id/,post.id);return I.Lightbox.open_remote(url,I.CommunityReportPostLightbox)}}(this)})}CommunityViewTopic.prototype.update_votes=function(el,res){var i,len,like_button,post,v,voters;post=el.closest(".community_post");voters=post.find(".vote_btn");like_button=voters.filter(".post_action");like_button.removeClass("animate_bounce animate_drop_down");setTimeout(function(_this){return function(){return like_button.removeClass("animate_bounce animate_drop_down")}}(this),500);if(el.is(".voted")){_.defer(function(_this){return function(){return like_button.addClass("animate_drop_down")}}(this));el.removeClass("voted")}else{_.defer(function(_this){return function(){return like_button.addClass("animate_bounce")}}(this));voters.removeClass("voted").filter(el).addClass("voted")}for(i=0,len=voters.length;i<len;i++){v=voters[i];v=$(v);if(v.is(".voted")){v.data("params").action="remove"}else{delete v.data("params").action}}return post.find(".vote_counts").html(this.vote_counts_template({up_score:res.up_score+Math.max(0,res.score_adjustment),down_score:res.down_score+Math.abs(Math.min(0,res.score_adjustment))}))};return CommunityViewTopic}()}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.EditCollectionLightbox=function(superClass){extend(EditCollectionLightbox,superClass);function EditCollectionLightbox(){return EditCollectionLightbox.__super__.constructor.apply(this,arguments)}EditCollectionLightbox.prototype.init=function(){var privacy_input,update_state;I.event2("view edit collection lightbox");this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){alert(res.errors.join(", "));return}return window.location.reload()}}(this));I.redactor(this.el.find("textarea"),{minHeight:30,source:false});privacy_input=this.el.find("input[name='collection[private]']");update_state=function(_this){return function(){var is_private;is_private=privacy_input.prop("checked");return _this.el.toggleClass("is_private",is_private).find(".on_profile_toggle input").prop("disabled",is_private)}}(this);update_state();return privacy_input.on("change",update_state)};return EditCollectionLightbox}(I.Lightbox)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.CreditCardLightbox=function(superClass){extend(CreditCardLightbox,superClass);function CreditCardLightbox(){return CreditCardLightbox.__super__.constructor.apply(this,arguments)}CreditCardLightbox.prototype.init=function(opts){var form;this.opts=opts;this.stripe=Stripe(this.opts.publishable_key);this.elements=this.stripe.elements({fonts:[{cssSrc:"https://fonts.googleapis.com/css?family=Lato:400,400i,700,900"}]});this.stripe_card=this.elements.create("card",{iconStyle:"solid",style:{base:{fontFamily:"Lato, sans-serif",fontSize:"14px"}}});this.stripe_card.mount(this.el.find(".stripe_elements_card")[0]);return form=this.el.find("form").on("submit.stripe_submit",function(_this){return function(e){e.preventDefault();return _this.stripe.createToken(_this.stripe_card,{name:_this.el.find(".name_input").val()}).then(function(res){if(res.error){form.set_form_errors([res.error.message],false);return _this.el.removeClass("loading")}else{_this.el.find(".card_token_field").val(res.token.id);return I.remote_submit(form).done(function(res){if(res.errors){return form.set_form_errors(res.errors,false)}else{return location.reload()}})}})}}(this))};return CreditCardLightbox}(I.Lightbox);I.EditCreditCardLightbox=function(superClass){extend(EditCreditCardLightbox,superClass);function EditCreditCardLightbox(){return EditCreditCardLightbox.__super__.constructor.apply(this,arguments)}EditCreditCardLightbox.prototype.init=function(){var form;this.credit_card_form=new I.CreditCardForm(this.el);return form=this.el.find("form").remote_submit(function(_this){return function(res){if(res.errors){return form.set_form_errors(res.errors,false)}else{return location.reload()}}}(this),function(_this){return function(){var month,ref,year;_this.credit_card_form.clear_errors();ref=_this.credit_card_form.parse_expiration(),month=ref[0],year=ref[1];if(!$.payment.validateCardExpiry(month,year)){_this.credit_card_form.mark_field(_this.credit_card_form.expiration_input);return false}return true}}(this))};return EditCreditCardLightbox}(I.Lightbox)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.DashboardPurchaseLightbox=function(superClass){extend(DashboardPurchaseLightbox,superClass);function DashboardPurchaseLightbox(){return DashboardPurchaseLightbox.__super__.constructor.apply(this,arguments)}DashboardPurchaseLightbox.prototype.init=function(){this.el.has_tooltips();return this.el.dispatch("click",{show_download_btn:function(_this){return function(btn){return _this.el.toggleClass("show_download_group")}}(this)})};return DashboardPurchaseLightbox}(I.Lightbox)}).call(this);(function(){var MIN_GCS_CHUNK_SIZE,ResumableUploader,min,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty,slice=[].slice;MIN_GCS_CHUNK_SIZE=262144;min=function(_this){return function(a,b){if(a<b){return a}else{return b}}}(this);ResumableUploader=function(){function ResumableUploader(url,user_data){if(user_data==null){user_data={}}this.process_queue=bind(this.process_queue,this);this.push_chunk=bind(this.push_chunk,this);this.close=bind(this.close,this);this.write=bind(this.write,this);this.user_data=user_data;this.upload_url=url;this.chunk_size=MIN_GCS_CHUNK_SIZE;this.buf=new Uint8Array(this.chunk_size);this.offset=0;this.chunks=[];this.chunk_offset=0;this.total_size="*";this.closed=false}ResumableUploader.prototype.write=function(buf){var buf_offset,buf_remaining,copied,results,sl;buf_offset=0;buf_remaining=buf.byteLength;results=[];while(buf_remaining>0){copied=min(this.chunk_size-this.offset,buf_remaining);sl=buf.slice(buf_offset,buf_offset+copied);buf_offset+=copied;buf_remaining-=copied;this.buf.set(sl,this.offset);this.offset+=copied;if(this.offset===this.chunk_size){this.push_chunk(this.buf.slice());results.push(this.offset=0)}else{results.push(void 0)}}return results};ResumableUploader.prototype.close=function(){this.total_size=this.chunk_offset+this.offset;this.closed=true;return this.push_chunk(this.buf.slice(0,this.offset))};ResumableUploader.prototype.push_chunk=function(buf){var end,len,start;len=buf.byteLength;start=this.chunk_offset;end=start+len-1;this.chunks.push({range:"bytes "+start+"-"+end+"/"+this.total_size,data:buf});this.chunk_offset+=len;return this.process_queue()};ResumableUploader.prototype.process_queue=function(){var chunk,xhr;if(this.pending){return}chunk=this.chunks.shift();if(chunk){this.pending=true;xhr=new XMLHttpRequest;xhr.addEventListener("load",function(_this){return function(){_this.pending=false;console.log("chunk "+chunk.range+" sent!");if(_this.chunks.length){return setTimeout(function(){return _this.process_queue()},1)}else if(_this.closed){return typeof _this.on_complete==="function"?_this.on_complete():void 0}}}(this));xhr.open("PUT",this.upload_url);xhr.setRequestHeader("Content-Range",chunk.range);console.log("sending out ",chunk.range);return xhr.send(chunk.data)}};return ResumableUploader}();I.DashboardGameUploadChannelLightbox=function(superClass){extend(DashboardGameUploadChannelLightbox,superClass);function DashboardGameUploadChannelLightbox(){this.status=bind(this.status,this);this.make_diff=bind(this.make_diff,this);this.create_build_files=bind(this.create_build_files,this);this.download_signature=bind(this.download_signature,this);this.get_signature_url=bind(this.get_signature_url,this);this.list_build_files=bind(this.list_build_files,this);this.do_upload=bind(this.do_upload,this);this.on_container=bind(this.on_container,this);this.hopla_loaded=bind(this.hopla_loaded,this);this.init=bind(this.init,this);return DashboardGameUploadChannelLightbox.__super__.constructor.apply(this,arguments)}DashboardGameUploadChannelLightbox.prototype.init=function(options){var check_if_loaded;console.log("Got options",options);this.channel_name=options.channel_name;this.game=options.game;this.status_el=this.el.find("p.status");this.archive_input=this.el.find("input.archive-input");this.folder_input=this.el.find("input.folder-input");this.el.dispatch("click",{btn_pick_archive:function(_this){return function(){return _this.archive_input.click()}}(this),btn_pick_directory:function(_this){return function(){return _this.folder_input.click()}}(this),btn_upload_build:function(_this){return function(){return _this.do_upload()}}(this)});check_if_loaded=function(_this){return function(){console.log("Waiting for hopla to load...");if(window.Hopla){_this.hopla_loaded();_this.el.addClass("loaded");return setTimeout(function(){return _this.el.find(".loading_lightbox").remove()},500)}else{return setTimeout(check_if_loaded,200)}}}(this);return check_if_loaded()};DashboardGameUploadChannelLightbox.prototype.hopla_loaded=function(){console.log("Hopla loaded!");window.Hopla(this.archive_input[0],function(_this){return function(container){return _this.on_container(container)}}(this));return window.Hopla(this.folder_input[0],function(_this){return function(container){return _this.on_container(container)}}(this))};DashboardGameUploadChannelLightbox.prototype.on_container=function(container){var check_if_loaded;this.el.find(".btn_pick").addClass("disabled");this.container=container;check_if_loaded=function(_this){return function(){console.log("Waiting for wharf to load...");if(window.Wharf){_this.el.find(".btn_upload_build").removeClass("disabled");return _this.status("Ready when you are!")}else{return setTimeout(check_if_loaded,200)}}}(this);return check_if_loaded()};DashboardGameUploadChannelLightbox.prototype.do_upload=function(){if(!this.container){return alert("Please select a .zip file or directory first!")}this.status("Creating new build...");return $.ajax({method:"post",url:"/api/1/me/wharf/builds",data:{game_id:this.game.id,channel:this.channel_name},success:function(_this){return function(res){console.log(res);if(res.errors){throw res.errors.join(", ")}_this.build_id=res.build.id;return _this.list_build_files(res.build.parent_build.id)}}(this)})};DashboardGameUploadChannelLightbox.prototype.list_build_files=function(parent_build_id){this.status("Seeking signature ",parent_build_id);return $.ajax({method:"get",url:"/api/1/me/wharf/builds/"+parent_build_id+"/files",success:function(_this){return function(res){var signature_file;console.log(res);if(res.errors){throw res.errors.join(", ")}signature_file=_.findWhere(res.files,{type:"signature",sub_type:"default"});return _this.get_signature_url(parent_build_id,signature_file.id)}}(this)})};DashboardGameUploadChannelLightbox.prototype.get_signature_url=function(parent_build_id,file_id){this.status("Getting signature url",parent_build_id,file_id);return $.ajax({method:"get",url:"/api/1/me/wharf/builds/"+parent_build_id+"/files/"+file_id+"/download",success:function(_this){return function(res){console.log(res);return _this.download_signature(res.url)}}(this)})};DashboardGameUploadChannelLightbox.prototype.download_signature=function(download_url){var xhr;this.status("Downloading signature",download_url);xhr=new XMLHttpRequest;xhr.addEventListener("load",function(_this){return function(){var sigbytes;if(xhr.status!==200){_this.status("Error while downloading signature: ",xhr.statusCode,xhr.statusText);return}sigbytes=xhr.response;_this.status("Downloaded ",_.str.formatBytes(sigbytes.byteLength),"signature");return _this.create_build_files(sigbytes)}}(this));xhr.open("GET",download_url);xhr.responseType="arraybuffer";return xhr.send()};DashboardGameUploadChannelLightbox.prototype.create_build_files=function(sigbytes){var on_created,uploaders;uploaders={};on_created=function(_this){return function(type,file){uploaders[type]=new ResumableUploader(file.upload_url,file);if(uploaders.patch&&uploaders.signature){console.log("Both uploaders ready!");return _this.make_diff(sigbytes,uploaders)}}}(this);return _.each(["patch","signature"],function(_this){return function(type){return $.ajax({method:"post",url:"/api/1/me/wharf/builds/"+_this.build_id+"/files",data:{type:type,sub_type:"gzip",upload_type:"resumable"},success:function(res){console.log(res);if(res.errors){throw res.errors.join(", ")}return on_created(type,res.file)}})}}(this))};DashboardGameUploadChannelLightbox.prototype.make_diff=function(sigbytes,uploaders){var on_upload_complete,on_upload_validated,opts,validated;validated={};on_upload_validated=function(_this){return function(type){validated[type]=true;console.log(type+" validated!");if(validated.patch&&validated.signature){return _this.status("Hey, you did it!")}}}(this);on_upload_complete=function(_this){return function(type,uploader){console.log(type+" completed!");return $.ajax({method:"post",url:"/api/1/me/wharf/builds/"+_this.build_id+"/files/"+uploader.user_data.id,data:{size:uploader.total_size},success:function(res){console.log(res);if(res.errors){throw res.errors.join(", ")}return on_upload_validated(type)}})}}(this);_.each(uploaders,function(_this){return function(uploader,type){console.log("Setting up complete hook for "+type);return uploader.on_complete=function(){return on_upload_complete(type,uploader)}}}(this));opts={onMessage:function(_this){return function(level,msg){return _this.status(msg)}}(this),onProgress:function(_this){return function(alpha){return document.title=(alpha*100).toFixed(2)+"% done"}}(this),onPatchWrite:function(_this){return function(buf){return uploaders.patch.write(new Uint8Array(buf))}}(this),onSignatureWrite:function(_this){return function(buf){return uploaders.signature.write(new Uint8Array(buf))}}(this),onComplete:function(_this){return function(){uploaders.patch.close();uploaders.signature.close();return document.title="complete!"}}(this)};return Wharf.diff(sigbytes,this.container,opts)};DashboardGameUploadChannelLightbox.prototype.status=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return this.status_el.text(args.map(function(_this){return function(x){return""+x}}(this)).join(" "))};return DashboardGameUploadChannelLightbox}(I.Lightbox)}).call(this);(function(){var extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;I.DashboardGameChannelLightbox=function(superClass){extend(DashboardGameChannelLightbox,superClass);function DashboardGameChannelLightbox(){return DashboardGameChannelLightbox.__super__.constructor.apply(this,arguments)}DashboardGameChannelLightbox.prototype.init=function(data){return this.el.dispatch("click",{channel_upload_btn:function(_this){return function(){return I.Lightbox.open_remote(_this.el.data("upload_lightbox_url"),I.DashboardGameUploadChannelLightbox,data)}}(this)})};return DashboardGameChannelLightbox}(I.Lightbox)}).call(this);
